<!DOCTYPE html><meta charset="utf-8"><meta content="width=device-width,initial-scale=1"name="viewport"><link href="/css/main.css"rel="stylesheet"><link href="/blog/feed.xml"rel="alternate"title="RSS Feed"type="application/atom+xml"><title>jank development update - Lazy sequences!</title><meta content="jank development update - Lazy sequences!"property="og:title"><meta content="jank now has lazy seqs, loop, destructuring, and a whole slew of new functions!"property="og:description"><meta content="https://jank-lang.org/img/logo-text-dark.png"property="og:image"><link href="/img/favicon/apple-touch-icon.png"rel="apple-touch-icon"sizes="180x180"><link href="/img/favicon/32.png"rel="icon"sizes="32x32"type="image/png"><link href="/img/favicon/16.png"rel="icon"sizes="16x16"type="image/png"><link href="/img/favicon/site.webmanifest"rel="manifest"><style>.gg-bulb{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:16px;height:16px;border:2px solid;border-bottom-color:transparent;border-radius:100px}.gg-bulb::after,.gg-bulb::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-bulb::before{border-top:0;border-bottom-left-radius:18px;border-bottom-right-radius:18px;top:10px;border-bottom:2px solid transparent;box-shadow:0 5px 0 -2px,inset 2px 0 0 0,inset -2px 0 0 0,inset 0 -4px 0 -2px;width:8px;height:8px;left:2px}.gg-bulb::after{width:12px;height:2px;border-left:3px solid;border-right:3px solid;border-radius:2px;bottom:0;left:0}.gg-check-o{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:22px;height:22px;border:2px solid;border-radius:100px}.gg-check-o::after{content:"";display:block;box-sizing:border-box;position:absolute;left:3px;top:-1px;width:6px;height:10px;border-color:currentColor;border-width:0 2px 2px 0;border-style:solid;transform-origin:bottom left;transform:rotate(45deg)}.gg-comment{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:16px;border:2px solid;border-bottom:0;box-shadow:-6px 8px 0 -6px,6px 8px 0 -6px}.gg-comment::after,.gg-comment::before{content:"";display:block;box-sizing:border-box;position:absolute;width:8px}.gg-comment::before{border:2px solid;border-top-color:transparent;border-bottom-left-radius:20px;right:4px;bottom:-6px;height:6px}.gg-comment::after{height:2px;background:currentColor;box-shadow:0 4px 0 0;left:4px;top:4px}.gg-git-fork{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:2px;height:14px;background:currentColor}.gg-git-fork::after,.gg-git-fork::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-git-fork::before{border-right:2px solid;border-bottom:2px solid;border-bottom-right-radius:4px;bottom:4px;width:8px;height:6px;left:0}.gg-git-fork::after{width:4px;height:4px;background:currentColor;box-shadow:0 12px 0 0,6px 2px 0 0;border-radius:100%;left:-1px;top:-1px}.gg-heart,.gg-heart::after{border:2px solid;border-top-left-radius:100px;border-top-right-radius:100px;width:10px;height:8px;border-bottom:0}.gg-heart{box-sizing:border-box;position:relative;transform:translate(calc(-10px / 2 * var(--ggs,1)),calc(-6px / 2 * var(--ggs,1))) rotate(-45deg) scale(var(--ggs,1));display:block}.gg-heart::after,.gg-heart::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-heart::after{right:-9px;transform:rotate(90deg);top:5px}.gg-heart::before{width:11px;height:11px;border-left:2px solid;border-bottom:2px solid;left:-2px;top:3px}.gg-home{background:linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 0 bottom/4px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat right bottom/4px 2px;box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:18px;height:14px;border:2px solid;border-top:0;border-bottom:0;border-top-right-radius:3px;border-top-left-radius:3px;border-bottom-right-radius:0;border-bottom-left-radius:0;margin-bottom:-2px}.gg-home::after,.gg-home::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-home::before{border-top:2px solid;border-left:2px solid;border-top-left-radius:4px;transform:rotate(45deg);top:-5px;border-radius:3px;width:14px;height:14px;left:0}.gg-home::after{width:8px;height:10px;border:2px solid;border-radius:100px;border-bottom-left-radius:0;border-bottom-right-radius:0;border-bottom:0;left:3px;bottom:0}.gg-info{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:20px;border:2px solid;border-radius:40px}.gg-info::after,.gg-info::before{content:"";display:block;box-sizing:border-box;position:absolute;border-radius:3px;width:2px;background:currentColor;left:7px}.gg-info::after{bottom:2px;height:8px}.gg-info::before{height:2px;top:2px}.gg-link{box-sizing:border-box;position:relative;display:block;transform:rotate(-45deg) scale(var(--ggs,1));width:8px;height:2px;background:currentColor;border-radius:4px}.gg-link::after,.gg-link::before{content:"";display:block;box-sizing:border-box;position:absolute;border-radius:3px;width:8px;height:10px;border:2px solid;top:-4px}.gg-link::before{border-right:0;border-top-left-radius:40px;border-bottom-left-radius:40px;left:-6px}.gg-link::after{border-left:0;border-top-right-radius:40px;border-bottom-right-radius:40px;right:-6px}.gg-list{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:22px;height:20px;border:2px solid;border-radius:3px}.gg-list::after,.gg-list::before{content:"";display:block;box-sizing:border-box;position:absolute;width:2px;height:2px;background:currentColor;top:3px;left:3px;box-shadow:0 4px 0,0 8px 0}.gg-list::after{border-radius:3px;width:8px;left:7px}.gg-math-minus{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:16px;height:2px;background:currentColor;border-radius:10px}.gg-slack{position:relative;box-sizing:border-box;transform:scale(var(--ggs,1));display:block;width:20px;height:20px;background:linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 7px 2px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 15px 7px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 2px 10px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 10px 15px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 10px 2px/4px 5px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 5px 12px/4px 5px}.gg-slack::after,.gg-slack::before{background:currentColor;content:"";position:absolute;box-sizing:border-box;display:block;height:4px;border-radius:22px}.gg-slack::before{width:9px;top:5px;box-shadow:10px 5px 0}.gg-slack::after{width:4px;left:5px;box-shadow:-5px 10px 0,0 10px 0,0 15px 0,5px 15px 0,5px 5px 0,5px 0 0,10px 5px 0}.gg-sync{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));border-radius:40px;border:2px solid;margin:1px;border-left-color:transparent;border-right-color:transparent;width:18px;height:18px}.gg-sync::after,.gg-sync::before{content:"";display:block;box-sizing:border-box;position:absolute;width:0;height:0;border-top:4px solid transparent;border-bottom:4px solid transparent;transform:rotate(-45deg)}.gg-sync::before{border-left:6px solid;bottom:-1px;right:-3px}.gg-sync::after{border-right:6px solid;top:-1px;left:-3px}.gg-twitter{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:20px}.gg-twitter::after,.gg-twitter::before{content:"";display:block;position:absolute;box-sizing:border-box;left:4px}.gg-twitter::before{width:9px;height:14px;border-left:4px solid;border-bottom:4px solid;border-bottom-left-radius:6px;background:linear-gradient(to left,currentColor 12px,transparent 0) no-repeat center 2px/10px 4px;top:4px}.gg-twitter::after{width:4px;height:4px;background:currentColor;border-radius:20px;top:2px;box-shadow:7px 4px 0,7px 12px 0}</style><script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),(()=>{var a="//matomo.jeaye.com/";_paq.push(["setTrackerUrl",a+"matomo.php"]),_paq.push(["setSiteId","1"]);var e=(p=document).createElement("script"),p=p.getElementsByTagName("script")[0];e.async=!0,e.src=a+"matomo.js",p.parentNode.insertBefore(e,p)})()</script><div><div><nav class="navbar is-primary"><div class="container"><div class="navbar-brand"><a class="navbar-item title has-text-white"href="/blog"style="font-family:Comfortaa"><img src="/img/logo-transparent.png"style="margin-right:15px">jank blog</a></div><div class="navbar-menu is-active"><div class="navbar-end has-text-weight-semibold"><a class="navbar-item has-text-white"href="/"><span class="icon mr-1"><i class="gg-home"></i></span><strong>Home</strong></a><a class="navbar-item has-text-white"href="/blog"><span class="icon mr-1"><i class="gg-comment"></i></span><strong>Blog</strong></a><a class="navbar-item has-text-white"href="https://github.com/sponsors/jeaye"><span class="icon mr-1"style="color:#c96198"><i class="gg-heart"></i></span><strong>Sponsor</strong></a><a class="navbar-item has-text-white"href="https://github.com/jank-lang/jank"><span class="icon mr-1"><i class="gg-git-fork"></i></span><strong>Github</strong></a><a class="navbar-item has-text-white"href="https://clojurians.slack.com/archives/C03SRH97FDK"><span class="icon mr-1"><i class="gg-slack"></i></span>Slack</a><a class="navbar-item has-text-white"href="https://twitter.com/jeayewilkerson"><span class="icon mr-1"><i class="gg-twitter"></i></span>Twitter</a></div></div></div></nav></div><section class="section"><div class="container blog-container"><span class="is-size-1">jank development update - Lazy sequences!</span><div class="is-size-6 has-text-weight-light">Apr 27, 2024 Â· <a class="has-text-weight-normal"href="https://github.com/jeaye">Jeaye Wilkerson</a></div><hr><div class="content"><p>This quarter, I'm being funded by <a href="https://www.clojuriststogether.org/">Clojurists Together</a> to build out jank's lazy sequences, special <code>loop*</code> form, destructuring, and support for the <code>for</code> and <code>doseq</code> macros. Going into this quarter, I had only a rough idea of how Clojure's lazy sequences were implemented. Now, a month in, I'm ready to report some impressive progress!<h2>Lazy sequences</h2><p>There are three primary types of lazy sequences in Clojure. I was planning on explaining all of this, but, even better, I can shine the spotlight on <a href="https://blog.brunobonacci.com/2023/09/08/buffered-sequences/">Bruno Bonacci's blog</a>, since he's covered all three of them very clearly. In short, we have:<ol><li>Per-element lazy sequences<li>Chunked lazy sequences<li>Buffered lazy sequences</ol><p>This month, I have implemented per-element lazy sequences, along with partial support for chunked lazy sequences. Chunked lazy sequences will be finished next month. By implementing even per-element lazy sequences, so many new opportunities open up. I'll show what I mean by that later in this post, so don't go anywhere!<h2>Loop</h2><p>Prior to this month, jank supported function-level <code>recur</code>. As part of this month's work, I also implemented <code>loop*</code> and its related <code>recur</code>. When we look at how Clojure JVM implements <code>loop*</code>, it has two different scenarios:<ol><li>Expression loops<li>Statement loops</ol><p>If a loop is in a statement position, Clojure JVM will code-generate labels with goto jumps and local mutations. If the loop is an expression, Clojure JVM generates a function around the loop and then immediately calls that. There is <em>potentially</em> a performance win of not generating the function wrapper and calling it right away, but note that this particular idiom is commonly identified and elided by optimizing compilers. It even has its own acronym: <a href="https://en.wikipedia.org/wiki/Immediately_invoked_function_expression">IIFE</a>. (see <a href="https://rigtorp.se/iife/">this</a> also)<p>jank, for now anyway, simplifies this by always using the IIFE. It does it in a more janky way, though, which is interesting enough that I'll share it with you all. Let's take an example <code>loop*</code> (note that the special form of <code>loop</code> is actually <code>loop*</code>, same as in Clojure; <code>loop</code> is a macro which provides destructuring on top of <code>loop*</code> â€“ now you know):<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#fd971f">(</span><span style="color:#a6e22e">loop*</span><span style="color:#fd971f"> [</span><span style="color:#f8f8f2">x </span><span style="color:#ae81ff">0</span><span style="color:#fd971f">]</span></span>
<span class="line"><span style="color:#fd971f">  (</span><span style="color:#fb4934;font-weight:700">when</span><span style="color:#fd971f"> (</span><span style="color:#a6e22e">&lt;</span><span style="color:#f8f8f2"> x </span><span style="color:#ae81ff">10</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">    (</span><span style="color:#a6e22e">println</span><span style="color:#f8f8f2"> x</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">    (</span><span style="color:#fb4934;font-weight:700">recur</span><span style="color:#fd971f"> (</span><span style="color:#a6e22e">inc</span><span style="color:#f8f8f2"> x</span><span style="color:#fd971f">))))</span></span></code></pre><p>Given this, jank will replace the <code>loop*</code> with a <code>fn*</code> and just use function recursion. Initial loop values just get lifted into parameters. The jank compiler will transform the above code into the following:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#fd971f">((</span><span style="color:#a6e22e">fn*</span><span style="color:#fd971f"> [</span><span style="color:#f8f8f2">x</span><span style="color:#fd971f">]</span></span>
<span class="line"><span style="color:#fd971f">   (</span><span style="color:#fb4934;font-weight:700">when</span><span style="color:#fd971f"> (</span><span style="color:#a6e22e">&lt;</span><span style="color:#f8f8f2"> x </span><span style="color:#ae81ff">10</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">     (</span><span style="color:#a6e22e">println</span><span style="color:#f8f8f2"> x</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">     (</span><span style="color:#fb4934;font-weight:700">recur</span><span style="color:#fd971f"> (</span><span style="color:#a6e22e">inc</span><span style="color:#f8f8f2"> x</span><span style="color:#fd971f">))))</span><span style="color:#ae81ff"> 0</span><span style="color:#fd971f">)</span></span></code></pre><p>jank code-generates function recursion into a <code>while(true)</code> loop with mutation on some locals for each iteration, similar to Clojure.<p>However, <code>loop*</code> is tricky, since it can also do anything <code>let*</code> can do. For example (also note: no recursion):<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#fd971f">(</span><span style="color:#a6e22e">loop*</span><span style="color:#fd971f"> [</span><span style="color:#f8f8f2">a </span><span style="color:#ae81ff">1</span></span>
<span class="line"><span style="color:#f8f8f2">        b </span><span style="color:#fd971f">(</span><span style="color:#a6e22e">*</span><span style="color:#ae81ff"> 2</span><span style="color:#f8f8f2"> a</span><span style="color:#fd971f">)]</span></span>
<span class="line"><span style="color:#fd971f">  (</span><span style="color:#a6e22e">println</span><span style="color:#f8f8f2"> a b</span><span style="color:#fd971f">))</span></span></code></pre><p>Since we're using <code>a</code> in the binding for <code>b</code>, we can't know <code>b</code> until we've calculated <code>a</code>, and doing so can involve any arbitrary expression. Agh! This can't work if we just dump those into the positional parameters of the IIFE. So jank gets around this by actually just wrapping it in a <code>let*</code>. ðŸ™ƒ<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#fd971f">(</span><span style="color:#a6e22e">let*</span><span style="color:#fd971f"> [</span><span style="color:#f8f8f2">a </span><span style="color:#ae81ff">1</span></span>
<span class="line"><span style="color:#f8f8f2">       b </span><span style="color:#fd971f">(</span><span style="color:#a6e22e">*</span><span style="color:#ae81ff"> 2</span><span style="color:#f8f8f2"> a</span><span style="color:#fd971f">)]</span></span>
<span class="line"><span style="color:#fd971f">  ((</span><span style="color:#a6e22e">fn*</span><span style="color:#fd971f"> [</span><span style="color:#f8f8f2">a b</span><span style="color:#fd971f">]</span></span>
<span class="line"><span style="color:#fd971f">    (</span><span style="color:#a6e22e">println</span><span style="color:#f8f8f2"> a b</span><span style="color:#fd971f">))</span><span style="color:#f8f8f2"> a b</span><span style="color:#fd971f">))</span></span></code></pre><p>This could be done in a macro, but since it's a language-level feature, the compiler does it for us. This means you can still use <code>loop*</code> even if you're running without <code>clojure.core</code>. As mentioned, this is potentially slower, in the scenario of the loop being in statement position. We can return to this when the performance of loops is the most important thing to tackle. Right now, parity with Clojure and getting jank onto your machine are most important.<h2>Destructuring</h2><p>Clojure supports all kinds of fancy destructuring of sequences, maps, and keyword arguments. We use destructuring in <code>let</code>, <code>defn</code>, and <code>loop</code>, primarily. One interesting thing about this destructuring is that there's no compiler support for it at all; it's not a language-level feature. It's a library feature, done entirely in macros. The amazing thing about it is that, as long as we support all of the core functions required, we can support destructuring. The actual <code>destructure</code> function is huge, but you can see it in Clojure's source <a href="https://github.com/clojure/clojure/blob/06d450895e2d4028afaa4face17f8e597c772a24/src/clj/clojure/core.clj#L4417-L4511">here</a>.<p>This month, I implemented all of the missing functions required for the <code>destructure</code> function to be ported over to jank. Largely, once all those functions were implemented, the port just meant updating Java interop in a few places to be C++ interop. Now jank supports all of the fancy destructuring Clojure does, in all the same places. This helps demonstrate how much closer jank is to being a complete Clojure dialect, since complex functions like this can <em>almost</em> just work.<h2>New clojure.core functions</h2><p>So, to support lazy sequences and destructuring, I needed to add several new core functions. While adding those, I tended toward implementing any similar or surrounding functions as well. I got a little carried away, to be honest. Let's take a look at the new functions jank now supports.<table><thead><tr><th><th><tbody><tr><td><code>take</code> (no transducer)<td><code>cycle</code><tr><td><code>take-while</code> (no transducer)<td><code>repeat</code><tr><td><code>drop</code> (no transducer)<td><code>seq?</code><tr><td><code>filter</code> (no transducer)<td><code>concat</code><tr><td><code>identity</code><td><code>-&gt;</code><tr><td><code>constantly</code><td><code>-&gt;&gt;</code><tr><td><code>into</code> (no transducer)<td><code>cond-&gt;</code><tr><td><code>mapv</code><td><code>zipmap</code><tr><td><code>filterv</code><td><code>last</code><tr><td><code>reduce</code><td><code>butlast</code><tr><td><code>nthrest</code><td><code>map?</code><tr><td><code>nthnext</code><td><code>key</code><tr><td><code>partition</code><td><code>val</code><tr><td><code>partition-all</code><td><code>dissoc</code><tr><td><code>partition-by</code><td><code>ident?</code><tr><td><code>dorun</code><td><code>simple-ident?</code><tr><td><code>doall</code><td><code>qualified-ident?</code><tr><td><code>when-let</code><td><code>boolean</code><tr><td><code>when-some</code><td><code>nth</code><tr><td><code>when-first</code><td><code>loop</code><tr><td><code>split-at</code><td><code>peek</code><tr><td><code>split-with</code><td><code>pop</code><tr><td><code>drop-last</code><td><code>for</code><tr><td><code>take-last</code><td><code>chunk-buffer</code><tr><td><code>chunk-append</code><td><code>destructure</code></table><p>That's 52 new functions/macros! That alone amounts to around 10% of all the functions in <code>clojure.core</code> jank will be implementing. A few of these will need some updates once jank fully supports chunked lazy sequences and transducers, but they're all very usable today. You may also note that <code>for</code> is in there, which was one of the goals this quarter.<h2>Migration from Cling to Clang</h2><p>jank is much closer to running on Clang's JIT compiler than it was a month ago. Some recent patches have landed which partially address a blocking bug with pre-compiled header handling in Clang's internal C++ JIT compiler. I have identified another small reproduction case for what I hope to be the rest of the issues. Part of my work this month involved getting jank running on LLVM 19 and updating filling out the related CMake system to be able to flexibly bring in LLVM on any system.<p>Once jank moves away from Cling in favor of Clang, building and distributing jank will be significantly easier. Developers won't need to compile a custom Cling/Clang/LLVM stack. On top of that, Clang's JIT compiler has recently landed support for loading C++20 modules, which can serve as an less-portable equivalent to JVM's class files, allowing jank to load pre-compiled modules very quickly. This will drastically optimize jank's startup time, but will require some work to get going. I'll keep you updated!<h2>What's next?</h2><p>I'm well ahead of schedule, for the quarter, but I need to finish up chunked sequences and <code>doseq</code>. I'll have time after that and I'd like to get atoms working, since most Clojure programs have some form of state. From there, I can look into strengthening native interop and making jank more easily distributable, but let's not get ahead of ourselves.<h2>Website changes</h2><p>On a smaller note, the theming of this website has been spruced up. Those of you with your browsers set to prefer dark themes may notice that this website now respects it. I try to make things look appealing without requiring any JS, even for all of the code highlighting and charts across my posts. Your feedback on my success here would also be welcome. The static site itself is built in Clojure!<h2>Would you like to join in?</h2><ol><li>Join the community on <a href="https://clojurians.slack.com/archives/C03SRH97FDK">Slack</a><li>Join the design discussions or pick up a ticket on <a href="https://github.com/jank-lang/jank">GitHub</a><li>Considering becoming a <a href="https://github.com/sponsors/jeaye">Sponsor</a> <span class="icon"style="color:#c96198"><i class="gg-heart"></i></span><li><strong>Hire me full-time to work on jank!</strong></ol></div></div></section></div><footer class="footer"><div class="container"><div class="columns has-text-centered"></div><div class="container has-text-centered"><div class="content is-small"><p>Â© 2025 Jeaye Wilkerson | All rights reserved.</div></div></div></footer><noscript><p><img src="//matomo.jeaye.com/matomo.php?idsite=1&amp;rec=1"style="border:0"alt=""></p></noscript><script>for(var coll=document.getElementsByClassName("collapsible"),i=0;i<coll.length;i++)coll[i].addEventListener("click",function(){this.classList.toggle("active");var l=this.nextElementSibling;"block"===l.style.display?l.style.display="none":l.style.display="block"})</script>