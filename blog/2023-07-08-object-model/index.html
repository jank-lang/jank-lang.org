<!DOCTYPE html><meta charset="utf-8"><meta content="width=device-width,initial-scale=1"name="viewport"><link href="/css/main.css"rel="stylesheet"><link href="/blog/feed.xml"rel="alternate"title="RSS Feed"type="application/atom+xml"><title>jank development update - A faster object model</title><meta content="jank development update - A faster object model"property="og:title"><meta content="A deep dive into jank&apos;s C++ object model, the cost of polymorphism, and how to do better."property="og:description"><meta content="https://jank-lang.org/img/logo-text-dark.png"property="og:image"><link href="/img/favicon/apple-touch-icon.png"rel="apple-touch-icon"sizes="180x180"><link href="/img/favicon/32.png"rel="icon"sizes="32x32"type="image/png"><link href="/img/favicon/16.png"rel="icon"sizes="16x16"type="image/png"><link href="/img/favicon/site.webmanifest"rel="manifest"><style>.gg-bulb{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:16px;height:16px;border:2px solid;border-bottom-color:transparent;border-radius:100px}.gg-bulb::after,.gg-bulb::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-bulb::before{border-top:0;border-bottom-left-radius:18px;border-bottom-right-radius:18px;top:10px;border-bottom:2px solid transparent;box-shadow:0 5px 0 -2px,inset 2px 0 0 0,inset -2px 0 0 0,inset 0 -4px 0 -2px;width:8px;height:8px;left:2px}.gg-bulb::after{width:12px;height:2px;border-left:3px solid;border-right:3px solid;border-radius:2px;bottom:0;left:0}.gg-check-o{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:22px;height:22px;border:2px solid;border-radius:100px}.gg-check-o::after{content:"";display:block;box-sizing:border-box;position:absolute;left:3px;top:-1px;width:6px;height:10px;border-color:currentColor;border-width:0 2px 2px 0;border-style:solid;transform-origin:bottom left;transform:rotate(45deg)}.gg-comment{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:16px;border:2px solid;border-bottom:0;box-shadow:-6px 8px 0 -6px,6px 8px 0 -6px}.gg-comment::after,.gg-comment::before{content:"";display:block;box-sizing:border-box;position:absolute;width:8px}.gg-comment::before{border:2px solid;border-top-color:transparent;border-bottom-left-radius:20px;right:4px;bottom:-6px;height:6px}.gg-comment::after{height:2px;background:currentColor;box-shadow:0 4px 0 0;left:4px;top:4px}.gg-git-fork{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:2px;height:14px;background:currentColor}.gg-git-fork::after,.gg-git-fork::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-git-fork::before{border-right:2px solid;border-bottom:2px solid;border-bottom-right-radius:4px;bottom:4px;width:8px;height:6px;left:0}.gg-git-fork::after{width:4px;height:4px;background:currentColor;box-shadow:0 12px 0 0,6px 2px 0 0;border-radius:100%;left:-1px;top:-1px}.gg-heart,.gg-heart::after{border:2px solid;border-top-left-radius:100px;border-top-right-radius:100px;width:10px;height:8px;border-bottom:0}.gg-heart{box-sizing:border-box;position:relative;transform:translate(calc(-10px / 2 * var(--ggs,1)),calc(-6px / 2 * var(--ggs,1))) rotate(-45deg) scale(var(--ggs,1));display:block}.gg-heart::after,.gg-heart::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-heart::after{right:-9px;transform:rotate(90deg);top:5px}.gg-heart::before{width:11px;height:11px;border-left:2px solid;border-bottom:2px solid;left:-2px;top:3px}.gg-home{background:linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 0 bottom/4px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat right bottom/4px 2px;box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:18px;height:14px;border:2px solid;border-top:0;border-bottom:0;border-top-right-radius:3px;border-top-left-radius:3px;border-bottom-right-radius:0;border-bottom-left-radius:0;margin-bottom:-2px}.gg-home::after,.gg-home::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-home::before{border-top:2px solid;border-left:2px solid;border-top-left-radius:4px;transform:rotate(45deg);top:-5px;border-radius:3px;width:14px;height:14px;left:0}.gg-home::after{width:8px;height:10px;border:2px solid;border-radius:100px;border-bottom-left-radius:0;border-bottom-right-radius:0;border-bottom:0;left:3px;bottom:0}.gg-info{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:20px;border:2px solid;border-radius:40px}.gg-info::after,.gg-info::before{content:"";display:block;box-sizing:border-box;position:absolute;border-radius:3px;width:2px;background:currentColor;left:7px}.gg-info::after{bottom:2px;height:8px}.gg-info::before{height:2px;top:2px}.gg-link{box-sizing:border-box;position:relative;display:block;transform:rotate(-45deg) scale(var(--ggs,1));width:8px;height:2px;background:currentColor;border-radius:4px}.gg-link::after,.gg-link::before{content:"";display:block;box-sizing:border-box;position:absolute;border-radius:3px;width:8px;height:10px;border:2px solid;top:-4px}.gg-link::before{border-right:0;border-top-left-radius:40px;border-bottom-left-radius:40px;left:-6px}.gg-link::after{border-left:0;border-top-right-radius:40px;border-bottom-right-radius:40px;right:-6px}.gg-list{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:22px;height:20px;border:2px solid;border-radius:3px}.gg-list::after,.gg-list::before{content:"";display:block;box-sizing:border-box;position:absolute;width:2px;height:2px;background:currentColor;top:3px;left:3px;box-shadow:0 4px 0,0 8px 0}.gg-list::after{border-radius:3px;width:8px;left:7px}.gg-math-minus{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:16px;height:2px;background:currentColor;border-radius:10px}.gg-slack{position:relative;box-sizing:border-box;transform:scale(var(--ggs,1));display:block;width:20px;height:20px;background:linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 7px 2px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 15px 7px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 2px 10px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 10px 15px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 10px 2px/4px 5px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 5px 12px/4px 5px}.gg-slack::after,.gg-slack::before{background:currentColor;content:"";position:absolute;box-sizing:border-box;display:block;height:4px;border-radius:22px}.gg-slack::before{width:9px;top:5px;box-shadow:10px 5px 0}.gg-slack::after{width:4px;left:5px;box-shadow:-5px 10px 0,0 10px 0,0 15px 0,5px 15px 0,5px 5px 0,5px 0 0,10px 5px 0}.gg-sync{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));border-radius:40px;border:2px solid;margin:1px;border-left-color:transparent;border-right-color:transparent;width:18px;height:18px}.gg-sync::after,.gg-sync::before{content:"";display:block;box-sizing:border-box;position:absolute;width:0;height:0;border-top:4px solid transparent;border-bottom:4px solid transparent;transform:rotate(-45deg)}.gg-sync::before{border-left:6px solid;bottom:-1px;right:-3px}.gg-sync::after{border-right:6px solid;top:-1px;left:-3px}.gg-twitter{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:20px}.gg-twitter::after,.gg-twitter::before{content:"";display:block;position:absolute;box-sizing:border-box;left:4px}.gg-twitter::before{width:9px;height:14px;border-left:4px solid;border-bottom:4px solid;border-bottom-left-radius:6px;background:linear-gradient(to left,currentColor 12px,transparent 0) no-repeat center 2px/10px 4px;top:4px}.gg-twitter::after{width:4px;height:4px;background:currentColor;border-radius:20px;top:2px;box-shadow:7px 4px 0,7px 12px 0}</style><script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),(()=>{var a="//matomo.jeaye.com/";_paq.push(["setTrackerUrl",a+"matomo.php"]),_paq.push(["setSiteId","1"]);var e=(p=document).createElement("script"),p=p.getElementsByTagName("script")[0];e.async=!0,e.src=a+"matomo.js",p.parentNode.insertBefore(e,p)})()</script><div><div><nav class="navbar is-primary"><div class="container"><div class="navbar-brand"><a class="navbar-item title has-text-white"href="/blog"style="font-family:Comfortaa"><img src="/img/logo-transparent.png"style="margin-right:15px">jank blog</a></div><div class="navbar-menu is-active"><div class="navbar-end has-text-weight-semibold"><a class="navbar-item has-text-white"href="/"><span class="icon mr-1"><i class="gg-home"></i></span><strong>Home</strong></a><a class="navbar-item has-text-white"href="/blog"><span class="icon mr-1"><i class="gg-comment"></i></span><strong>Blog</strong></a><a class="navbar-item has-text-white"href="https://github.com/sponsors/jeaye"><span class="icon mr-1"style="color:#c96198"><i class="gg-heart"></i></span><strong>Sponsor</strong></a><a class="navbar-item has-text-white"href="https://github.com/jank-lang/jank"><span class="icon mr-1"><i class="gg-git-fork"></i></span><strong>Github</strong></a><a class="navbar-item has-text-white"href="https://clojurians.slack.com/archives/C03SRH97FDK"><span class="icon mr-1"><i class="gg-slack"></i></span>Slack</a><a class="navbar-item has-text-white"href="https://twitter.com/jeayewilkerson"><span class="icon mr-1"><i class="gg-twitter"></i></span>Twitter</a></div></div></div></nav></div><section class="section"><div class="container blog-container"><span class="is-size-1">jank development update - A faster object model</span><div class="is-size-6 has-text-weight-light">Jul 08, 2023 Â· <a class="has-text-weight-normal"href="https://github.com/jeaye">Jeaye Wilkerson</a></div><hr><div class="content"><p>This quarter, my work on jank is being sponsored by <a href="https://www.clojuriststogether.org/">Clojurists Together</a>. The terms of the work are to research a new object model for jank, with the goal of making jank code faster across the board. This is a half-way report and I'm excited to share my results!<h2>The problem</h2><p>Before getting into any solutions, or celebrating any wins, we need to talk about why this work is being done at all. As you can see in my previous development updates, jank is fast. It can beat Clojure in each benchmark I've published so far. However, some parts of jank's runtime are still quite slow and, unfortunately, the problem is systemic.<p>Generally speaking, the problem can be boiled down to this: the JVM is ridiculously fast at allocations. That's important, since Clojure is, to put it nicely, very liberal with its allocations. jank overcomes this, in some ways, by just allocating a whole lot less. Still, each allocation pushes Clojure ahead in benchmarks and it adds up.<p>So, JVM allocations are fast, but why are jank's slow? To understand this requires an understanding of C++ inheritance and virtual function tables (vtables), so let's cover that at an implementation level.<h2>Virtual function tables</h2><p>Clojure is thoroughly polymorphic. Everything is an Object, which can then have any number of interfaces it implements, all of which can be extended, checked at run-time, etc. To accomplish this, in C++, I modeled the objects quite closely to how they are in Clojure's Java runtime. Let's take a look.<p>Let's take a stripped down jank base object:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> jank_object</span><span style="color:#f8f8f2"> : gc</span></span>
<span class="line"><span style="color:#fd971f">{</span><span style="color:#f8f8f2"> virtual </span><span style="color:#a6e22e">std</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">string</span><span style="color:#a6e22e"> to_native_string</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2"> const </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">; </span><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span></code></pre><p>Now let's define our boxed string object:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> jank_string</span><span style="color:#f8f8f2"> : jank_object</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#a6e22e">  std</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">string</span><span style="color:#a6e22e"> to_native_string</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2"> const override</span></span>
<span class="line"><span style="color:#fd971f">  {</span><span style="color:#fb4934;font-weight:700"> return</span><span style="color:#f8f8f2"> data; </span><span style="color:#fd971f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#a6e22e">  std</span><span style="color:#f8f8f2">::string data</span><span style="color:#fd971f">{}</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span></code></pre><p>This is how each object is modeled in jank, currently, and it's mostly the same as how they are in Java. Each boxed string, hash map, vector, integer, etc inherits from a base object and overrides some functionality. We can use <code>g++ -fdump-lang-class foo.cpp</code> to put these sample types into a file and see the generated class hierarchy details. The output of that is long and confusing, though, so I've turned them into simpler diagrams. Let's take a look at <code>jank_string</code>.<p><figure width="300px"><img src="/img/blog/2023-07-08-object-model/class-1.svg"></figure><p><p>So, <code>jank_string</code> is 40 bytes (8 for the <code>jank_object</code> vtable pointer + 32 for the <code>std::string</code>). It has its own static vtable and a <code>vptr</code> to it, since it inherits from <code>jank_object</code> and overrides a function. Whenever a <code>jank_string</code> is allocated, these vtable pointers need to be initialized. All of this is handled by the C++ compiler, and is implementation-defined, so we don't have much control over it.<p>Let's take this a step further and add another behavior, since I need to be able to get the size of a <code>jank_string</code>.<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> jank_countable</span></span>
<span class="line"><span style="color:#fd971f">{</span><span style="color:#f8f8f2"> virtual </span><span style="color:#66d9ef;font-style:italic">size_t</span><span style="color:#a6e22e"> count</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2"> const </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">; </span><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> jank_string</span><span style="color:#f8f8f2"> : jank_object, </span><span style="color:#a6e22e">jank_countable</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#a6e22e">  std</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">string</span><span style="color:#a6e22e"> to_native_string</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2"> const override</span></span>
<span class="line"><span style="color:#fd971f">  {</span><span style="color:#fb4934;font-weight:700"> return</span><span style="color:#f8f8f2"> data; </span><span style="color:#fd971f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">  size_t</span><span style="color:#a6e22e"> count</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2"> const override</span></span>
<span class="line"><span style="color:#fd971f">  {</span><span style="color:#fb4934;font-weight:700"> return</span><span style="color:#f8f8f2"> data.</span><span style="color:#a6e22e">size</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2">; </span><span style="color:#fd971f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#a6e22e">  std</span><span style="color:#f8f8f2">::string data</span><span style="color:#fd971f">{}</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span></code></pre><p>So now we add <code>jank_countable</code> into the mix and implement that for <code>jank_string</code>. What has this done to our vtables? Well, <code>jank_countable</code> needs its own vtable and <code>jank_string</code> is going to need a pointer to it.<p><figure width="300px"><img src="/img/blog/2023-07-08-object-model/class-2.svg"></figure><p><p>Notice that <code>jank_string</code> was 40 bytes, but now it's 48 bytes, due to the additional pointer to the <code>jank_countable</code> vtable. It's important to note here that we didn't just make every string we allocate larger, which may slow down allocations, we also added another field to be initialized, which will <em>certainly</em> slow down allocations.<p>I'm sure you get the point, so let me wrap this section up by noting that Clojure's object model involves a <em>lot</em> of behaviors. Here's what jank's map object looks like right now:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> map</span></span>
<span class="line"><span style="color:#f8f8f2">  : </span><span style="color:#a6e22e">object</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">    behavior::</span><span style="color:#a6e22e">seqable</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">    behavior::</span><span style="color:#a6e22e">countable</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">    behavior::</span><span style="color:#a6e22e">metadatable</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">    behavior::</span><span style="color:#a6e22e">associatively_readable</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">    behavior::</span><span style="color:#a6e22e">associatively_writable</span></span>
<span class="line"><span style="color:#fd971f">{</span><span style="color:#88846f"> /* ... */</span><span style="color:#fd971f"> }</span><span style="color:#f8f8f2">;</span></span></code></pre><p>That's <em>six vtable pointers</em> and it covers maybe half of the functionality which Clojure's maps have. I just haven't implemented the rest yet. As I do, jank's maps will become slower and slower to allocate.<h2>Garbage collectors</h2><p>Before going further, I need to note that all of my Clojure benchmarking has been done on my local Linux desktop running OpenJDK 11 with the G1 GC. jank is currently using the Boehm GC, which is a conservative, non-moving GC that's super easy to use, but not the fastest on the market. More on this later, but note that jank has a lot of room to grow in terms of allocation speed by using a more tailored GC integration.<h2>Initial numbers</h2><p>By benchmarking the creation of non-empty hash maps (<code>{:a :b}</code> specifically), we can paint a pretty clear picture of the issue I've been describing.<p><figure width="33%"><object data="/img/blog/2023-07-08-object-model/allocations-initial.plot.svg"type="image/svg+xml"><img src="/img/blog/2023-07-08-object-model/allocations-initial.plot.svg"></object></figure><p><p>For Clojure, it takes about 16ns to allocate. For jank, that number is nearly doubled to 31ns. So what can be done? Clojure depends on this level of polymorphism, and virtual functions are how you accomplish this in C++, so what else <em>can</em> we even do?<h2>Static runtimes</h2><p>Let's consider how a completely static runtime might be implemented. For example, let's assume I had a simple language which only supported a few object types, with no syntax for defining new types or protocols or even extending existing ones. This would often be implemented using something like a <a href="https://en.wikipedia.org/wiki/Tagged_union">tagged union</a> in C-like languages. Here's a quick example:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">enum</span><span style="color:#66d9ef;font-style:italic"> class</span><span style="color:#a6e22e"> object_type</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#f8f8f2">  nil,</span></span>
<span class="line"><span style="color:#f8f8f2">  string,</span></span>
<span class="line"><span style="color:#f8f8f2">  integer</span></span>
<span class="line"><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#fb4934;font-weight:700">using</span><span style="color:#a6e22e"> nil_t</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#f8f8f2"> struct { };</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">using</span><span style="color:#a6e22e"> string_t</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#66d9ef;font-style:italic"> char</span><span style="color:#f8f8f2"> const </span><span style="color:#fb4934;font-weight:700">*</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">using</span><span style="color:#a6e22e"> integer_t</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#66d9ef;font-style:italic"> long</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> object</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#88846f">  /* Each object has a &quot;tag&quot;, which is generally an enum. */</span></span>
<span class="line"><span style="color:#f8f8f2">  object_type type;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">  /* Each object can store one of each type, but all in the same location. */</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">  union</span></span>
<span class="line"><span style="color:#fd971f">  {</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">    nil_t</span><span style="color:#f8f8f2"> nil;</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">    string_t</span><span style="color:#f8f8f2"> string;</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">    integer_t</span><span style="color:#f8f8f2"> integer;</span></span>
<span class="line"><span style="color:#fd971f">  }</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">void</span><span style="color:#a6e22e"> print</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">object</span><span style="color:#f8f8f2"> const &amp;</span><span style="color:#fd971f;font-style:italic">o</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  switch</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">o.type</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">  {</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    case</span><span style="color:#a6e22e"> object_type</span><span style="color:#f8f8f2">::nil:</span></span>
<span class="line"><span style="color:#a6e22e">      fmt</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">print</span><span style="color:#fd971f">(</span><span style="color:#e6db74">&quot;nil&quot;</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      break</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    case</span><span style="color:#a6e22e"> object_type</span><span style="color:#f8f8f2">::string:</span></span>
<span class="line"><span style="color:#a6e22e">      fmt</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">print</span><span style="color:#fd971f">(</span><span style="color:#e6db74">&quot;{}&quot;</span><span style="color:#f8f8f2">, o.string</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      break</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    case</span><span style="color:#a6e22e"> object_type</span><span style="color:#f8f8f2">::integer:</span></span>
<span class="line"><span style="color:#a6e22e">      fmt</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">print</span><span style="color:#fd971f">(</span><span style="color:#e6db74">&quot;{}&quot;</span><span style="color:#f8f8f2">, o.integer</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      break</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">  }</span></span>
<span class="line"><span style="color:#fd971f">}</span></span></code></pre><p>So, if you're not familiar how unions work, they just store all of the possible fields listed in the union in the same memory space. The union is as big as its largest field. The tag accompanies the union and informs you how to treat that memory (i.e. as a <code>integer</code>, <code>string</code>, etc). In order to access data from the union, we generally just use a <code>switch</code> statement on the tag.<p>The main drawback with this approach is that all possible types need to be known at compile-time, since they're part of the enum, the union, and each switch statement. However, the main benefit of this approach is the same. All types are known at compile-time, so compilers have everything they need to optimize access. There are no vtables, object allocations are all the same size, each function call can potentially be inlined, and so on.<h2>A hybrid runtime</h2><p>Clojure demands polymorphism, but it also has a well known set of static types. In fact, we model most of our programs just using Clojure's built-in data structures, so why not optimize for that case? The entirely open, polymorphic case doesn't need to negatively impact the average case.<p>This reasoning lead me to prototyping and benchmarking a tagged object model for jank. However, since jank is not a trivial language, the tagged implementation couldn't quite be as simple as my example above. There are a few key concerns.<h3>Concern 1: Unions</h3><p>Unions are very limiting. Even with jank's static objects, there is a large variety in object size. Requiring every integer, for example, to be as big as a hash map is not ideal. Numbers need to be fast to allocate and use.<p>Fortunately, C++ offers a great deal more power than C when it comes to compile-time polymorphism, in the form of templates, so we can take advantage of that. Let's see what that looks like:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">enum</span><span style="color:#66d9ef;font-style:italic"> class</span><span style="color:#a6e22e"> object_type</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#f8f8f2">  nil,</span></span>
<span class="line"><span style="color:#f8f8f2">  integer</span></span>
<span class="line"><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">template</span><span style="color:#fd971f"> &lt;</span><span style="color:#66d9ef;font-style:italic">object_type</span><span style="color:#a6e22e"> T</span><span style="color:#fd971f">&gt;</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> static_object</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">template</span><span style="color:#fd971f"> &lt;&gt;</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> static_object</span><span style="color:#fd971f">&lt;</span><span style="color:#a6e22e">object_type</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">nil</span><span style="color:#fd971f">&gt;</span><span style="color:#f8f8f2"> : </span><span style="color:#a6e22e">gc</span></span>
<span class="line"><span style="color:#fd971f">{</span><span style="color:#fd971f"> }</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">template</span><span style="color:#fd971f"> &lt;&gt;</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> static_object</span><span style="color:#fd971f">&lt;</span><span style="color:#a6e22e">object_type</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">integer</span><span style="color:#fd971f">&gt;</span><span style="color:#f8f8f2"> : </span><span style="color:#a6e22e">gc</span></span>
<span class="line"><span style="color:#fd971f">{</span><span style="color:#f8f8f2"> native_integer data</span><span style="color:#fd971f">{}</span><span style="color:#f8f8f2">; </span><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span></code></pre><p>Ok, let me break this down. We start with the same enum as with the static runtime example. Here I'm just showing <code>nil</code> and <code>integer</code>. Then, we have a new <code>static_object</code> struct template. It's parameterized on the object type. Note that templates can be parameterized on types as well as certain values. Here we're parameterizing on the enum value itself. We can <em>specialize</em> this template for each value of <code>object_type</code> and each one can be a completely distinct struct, with its own fields. However, they're all tied together by the combination of <code>static_object</code> and some enum value. This usage of templates is kind of like Clojure's multi-methods, but for compile-time types.<p>This is much more flexible than the union approach, since each object type has its own definition and size. The size of the integer specialization will be far smaller than the size of the map specialization.<p>However, the work isn't done yet.<h3>Concerns 2 and 3: Type erasure and stable pointers</h3><p>With the above <code>static_object</code> template, we can allocate an integer and it has its own strong, static type. However, to achieve Clojure's polymorphism, we need <a href="https://en.wikipedia.org/wiki/Type_erasure">type erasure</a>. For example, we need to be able to store any type of object in a vector, or as a key in a map. When using inheritance, we have a base <code>object</code> type for that. When using the union based approach, every object fits inside of a single <code>object</code> type. However, in our type-rich object model, each object type is discrete. We need a common way to refer to them, while still being able to get back to the static object. On top of that, we need a way to <em>unerase</em> the type, allowing us to get back to the original static object. This is Concern 2.<p>Also, Concern 3 is that the pointers we use to hang onto these objects need to be stable and they need to correspond with the pointers the GC gave us when we allocated them. This is because the GC is constantly scanning the process memory for references to those pointers; if we type-erase to some other pointer value and hang onto that, the GC may suspect nobody is referencing the original value anymore and take the liberty of freeing it.<p>We can solve both of these problems with the same addition: a simple <code>object</code> type which contains our <code>object_type</code> enum. If every <code>static_object</code> specialization has this <code>object</code> type as its first member, we can ensure that a pointer to the <code>object</code> member is the same value as a pointer to the <code>static_object</code> itself (and we can <code>static_assert</code> this to ensure padding doesn't bite us). With that knowledge, we can reinterpret any <code>object</code> pointer to be a <code>static_object</code> pointer, based on doing a <code>switch</code> on the object type. Here's how it would look:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">enum</span><span style="color:#66d9ef;font-style:italic"> class</span><span style="color:#a6e22e"> object_type</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#f8f8f2">  nil,</span></span>
<span class="line"><span style="color:#f8f8f2">  integer</span></span>
<span class="line"><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">/* An object type which contain the enum value. */</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> object</span></span>
<span class="line"><span style="color:#fd971f">{</span><span style="color:#f8f8f2"> object_type type</span><span style="color:#fd971f">{}</span><span style="color:#f8f8f2">; </span><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">using</span><span style="color:#a6e22e"> object_ptr</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#a6e22e"> object</span><span style="color:#f8f8f2">*;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">template</span><span style="color:#fd971f"> &lt;</span><span style="color:#66d9ef;font-style:italic">object_type</span><span style="color:#a6e22e"> T</span><span style="color:#fd971f">&gt;</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> static_object</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">/* Each specialization composes the object type as its first member. */</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">template</span><span style="color:#fd971f"> &lt;&gt;</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> static_object</span><span style="color:#fd971f">&lt;</span><span style="color:#a6e22e">object_type</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">nil</span><span style="color:#fd971f">&gt;</span><span style="color:#f8f8f2"> : </span><span style="color:#a6e22e">gc</span></span>
<span class="line"><span style="color:#fd971f">{</span><span style="color:#f8f8f2"> object base</span><span style="color:#fd971f">{</span><span style="color:#a6e22e"> object_type</span><span style="color:#f8f8f2">::nil </span><span style="color:#fd971f">}</span><span style="color:#f8f8f2">; </span><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">template</span><span style="color:#fd971f"> &lt;&gt;</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> static_object</span><span style="color:#fd971f">&lt;</span><span style="color:#a6e22e">object_type</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">integer</span><span style="color:#fd971f">&gt;</span><span style="color:#f8f8f2"> : </span><span style="color:#a6e22e">gc</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#f8f8f2">  object base</span><span style="color:#fd971f">{</span><span style="color:#a6e22e"> object_type</span><span style="color:#f8f8f2">::integer </span><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#f8f8f2">  native_integer data</span><span style="color:#fd971f">{}</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">void</span><span style="color:#a6e22e"> print</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">object</span><span style="color:#f8f8f2"> const &amp;</span><span style="color:#fd971f;font-style:italic">o</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  switch</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">o.type</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">  {</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    case</span><span style="color:#a6e22e"> object_type</span><span style="color:#f8f8f2">::nil:</span></span>
<span class="line"><span style="color:#a6e22e">      fmt</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">print</span><span style="color:#fd971f">(</span><span style="color:#e6db74">&quot;nil&quot;</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      break</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    case</span><span style="color:#a6e22e"> object_type</span><span style="color:#f8f8f2">::integer:</span></span>
<span class="line"><span style="color:#88846f">      /* We can cast right from the object pointer to the static_object pointer. */</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">      auto</span><span style="color:#f8f8f2"> const </span><span style="color:#a6e22e">typed_o</span><span style="color:#fd971f">(</span><span style="color:#fb4934;font-weight:700">reinterpret_cast&lt;</span><span style="color:#f8f8f2">static_object</span><span style="color:#fb4934;font-weight:700">&lt;</span><span style="color:#a6e22e">object_type</span><span style="color:#f8f8f2">::integer</span><span style="color:#fb4934;font-weight:700">&gt;</span><span style="color:#f8f8f2"> const</span><span style="color:#fb4934;font-weight:700">*&gt;</span><span style="color:#fd971f">(</span><span style="color:#fb4934;font-weight:700">&amp;</span><span style="color:#f8f8f2">o</span><span style="color:#fd971f">))</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#a6e22e">      fmt</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">print</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">typed_o-&gt;data</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      break</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">  }</span></span>
<span class="line"><span style="color:#fd971f">}</span></span></code></pre><p>This is the classic composition versus inheritance change. The previous version of jank's object model followed Clojure JVM's design of using inheritance. This new design uses composition, by having each static object have the base <code>object</code> as its first member.<h3>Concern 4: Switch statements</h3><p>Imagine if we had to write a switch statement everywhere we wanted polymorphism. In a simpler language that uses the classic tagged union approach, especially when written in C, this would typically just be the way things work. However, surely modern C++ has some more robust features for us to use instead? Indeed it does.<p>We can get around this duplication by having the switch in only one place and using the <a href="https://en.wikipedia.org/wiki/Visitor_pattern">visitor pattern</a> to access it. The result looks like this:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">template</span><span style="color:#fd971f"> &lt;</span><span style="color:#66d9ef;font-style:italic">typename</span><span style="color:#a6e22e"> F</span><span style="color:#fd971f">&gt;</span></span>
<span class="line"><span style="color:#fd971f">[[</span><span style="color:#a6e22e">gnu</span><span style="color:#f8f8f2">::always_inline, </span><span style="color:#a6e22e">gnu</span><span style="color:#f8f8f2">::flatten, </span><span style="color:#a6e22e">gnu</span><span style="color:#f8f8f2">::hot</span><span style="color:#fd971f">]]</span></span>
<span class="line"><span style="color:#f8f8f2">inline </span><span style="color:#66d9ef;font-style:italic">void</span><span style="color:#a6e22e"> visit_object</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">object</span><span style="color:#f8f8f2"> * const </span><span style="color:#fd971f;font-style:italic">erased</span><span style="color:#f8f8f2">, </span><span style="color:#a6e22e">F</span><span style="color:#f8f8f2"> &amp;&amp;</span><span style="color:#fd971f;font-style:italic">fn</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  switch</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">erased-&gt;type</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">  {</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    case</span><span style="color:#a6e22e"> object_type</span><span style="color:#f8f8f2">::nil:</span></span>
<span class="line"><span style="color:#a6e22e">      fn</span><span style="color:#fd971f">(</span><span style="color:#fb4934;font-weight:700">reinterpret_cast&lt;</span><span style="color:#f8f8f2">static_nil</span><span style="color:#fb4934;font-weight:700">*&gt;</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">erased</span><span style="color:#fd971f">))</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      break</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    case</span><span style="color:#a6e22e"> object_type</span><span style="color:#f8f8f2">::integer:</span></span>
<span class="line"><span style="color:#a6e22e">      fn</span><span style="color:#fd971f">(</span><span style="color:#fb4934;font-weight:700">reinterpret_cast&lt;</span><span style="color:#f8f8f2">static_integer</span><span style="color:#fb4934;font-weight:700">*&gt;</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">erased</span><span style="color:#fd971f">))</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      break</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">  }</span></span>
<span class="line"><span style="color:#fd971f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">void</span><span style="color:#a6e22e"> print</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">object</span><span style="color:#f8f8f2"> const &amp;</span><span style="color:#fd971f;font-style:italic">o</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#f8f8f2">  visit_object</span></span>
<span class="line"><span style="color:#fd971f">  (</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    &amp;</span><span style="color:#f8f8f2">o,</span></span>
<span class="line"><span style="color:#88846f">    /* Generic anonymous function. */</span></span>
<span class="line"><span style="color:#f8f8f2">    [](</span><span style="color:#66d9ef;font-style:italic">auto</span><span style="color:#f8f8f2"> const </span><span style="color:#fd971f;font-style:italic">typed_o</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#fd971f">    {</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      using</span><span style="color:#a6e22e"> T</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#a6e22e"> std</span><span style="color:#f8f8f2">::</span><span style="color:#66d9ef;font-style:italic">decay_t</span><span style="color:#fd971f">&lt;</span><span style="color:#66d9ef;font-style:italic">decltype</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">typed_o</span><span style="color:#fd971f">)&gt;</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      if</span><span style="color:#f8f8f2"> constexpr</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">std</span><span style="color:#f8f8f2">::same_as</span><span style="color:#fb4934;font-weight:700">&lt;</span><span style="color:#f8f8f2">T, static_nil</span><span style="color:#fb4934;font-weight:700">*&gt;</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">      {</span><span style="color:#a6e22e"> fmt</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">print</span><span style="color:#fd971f">(</span><span style="color:#e6db74">&quot;nil&quot;</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">; </span><span style="color:#fd971f">}</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      else</span><span style="color:#fb4934;font-weight:700"> if</span><span style="color:#f8f8f2"> constexpr</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">std</span><span style="color:#f8f8f2">::same_as</span><span style="color:#fb4934;font-weight:700">&lt;</span><span style="color:#f8f8f2">T, static_integer</span><span style="color:#fb4934;font-weight:700">*&gt;</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">      {</span><span style="color:#a6e22e"> fmt</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">print</span><span style="color:#fd971f">(</span><span style="color:#e6db74">&quot;{}&quot;</span><span style="color:#f8f8f2">, typed_o-&gt;data</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">; </span><span style="color:#fd971f">}</span></span>
<span class="line"><span style="color:#fd971f">    }</span></span>
<span class="line"><span style="color:#fd971f">  )</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">}</span></span></code></pre><p>The vistor pattern here allows us to specify a <em>generic lambda</em>, which is basically shorthand for a function template which accepts any input. The anonymous function will be called with the fully typed <code>static_object</code> and we can use compile-time branching based on the type of the parameter to do the things we want. This means the most optimal code is generated and there's static type checking every step of the way, even in our polymorphic system.<p>The annotations above <code>visit_object</code> instruct the compiler to optimize all of this away. As I will show in just a bit, this is no challenge at all. The visitor pattern is not <em>at all</em> present in the generated binary.<p>I know that the <code>if constexpr</code> branching didn't save us any lines, compared to the <code>switch</code>, in the previous example. Hang tight while we address that.<h3>Concern 5: Polymorphic behaviors</h3><p>Finally, we hit our last concern. Objects in Clojure are polymorphic, but they can also be referred to by their own polymorphic behaviors. For example, in jank, we have behaviors for <code>countable</code> (for use with <code>count</code>), <code>associatively_readable</code> (which supplies access to <code>get</code>), etc. These aren't objects on their own; they're behaviors for objects. In typical OOP terms, they're interfaces which these objects implement. In a world with static objects and compile-time branching to visit them, how do we handle these behaviors?<p>Well, C++20 introduces an improved take on the idea of compile-time behaviors in what it calls concepts. So, let's define a concept for getting a string from an object. I like to end all of these behaviors with <code>able</code>, even when it doesn't grammatically work at all, as a cheeky jab at OOP.<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">template</span><span style="color:#fd971f"> &lt;</span><span style="color:#66d9ef;font-style:italic">typename</span><span style="color:#a6e22e"> T</span><span style="color:#fd971f">&gt;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">concept</span><span style="color:#f8f8f2"> stringable </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#fb4934;font-weight:700"> requires</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">T </span><span style="color:#fb4934;font-weight:700">*</span><span style="color:#f8f8f2"> const t</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#fd971f">  {</span><span style="color:#f8f8f2"> t-&gt;</span><span style="color:#a6e22e">to_string</span><span style="color:#fd971f">()</span><span style="color:#fd971f"> }</span><span style="color:#fb4934;font-weight:700"> -&gt;</span><span style="color:#a6e22e"> std</span><span style="color:#f8f8f2">::convertible_to</span><span style="color:#fb4934;font-weight:700">&lt;</span><span style="color:#f8f8f2">native_string</span><span style="color:#fb4934;font-weight:700">&gt;</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span></code></pre><p>C++20 concepts are just compile-time predicates, but they're quite flexible. This is a predicate for some type <code>T</code> that checks if you can call <code>-&gt;to_string()</code> on an instance of it and get something compatible with a <code>native_string</code>. This is less specific than a C++ interface which says you need to implement something like <code>virtual native_string to_string() const</code>, since it allows returning references to strings, or something which can convert to a string.<p>Keep in mind that, while inheritance is intrusive, concepts are not. They're just predicates for types and are not coupled to any given type. This is analogous to the <a href="https://en.wikipedia.org/wiki/Structural_type_system">structural typing</a> versus nominal typing discussion.<p>If we wanted to use this in our <code>print</code> function, we could just do:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">void</span><span style="color:#a6e22e"> print</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">object</span><span style="color:#f8f8f2"> const &amp;</span><span style="color:#fd971f;font-style:italic">o</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#f8f8f2">  visit_object</span></span>
<span class="line"><span style="color:#fd971f">  (</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    &amp;</span><span style="color:#f8f8f2">o,</span></span>
<span class="line"><span style="color:#f8f8f2">    [](</span><span style="color:#66d9ef;font-style:italic">auto</span><span style="color:#f8f8f2"> const </span><span style="color:#fd971f;font-style:italic">typed_o</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#fd971f">    {</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      using</span><span style="color:#a6e22e"> T</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#a6e22e"> std</span><span style="color:#f8f8f2">::</span><span style="color:#66d9ef;font-style:italic">decay_t</span><span style="color:#fd971f">&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f8f8f2">::</span><span style="color:#66d9ef;font-style:italic">remove_pointer_t</span><span style="color:#fd971f">&lt;</span><span style="color:#66d9ef;font-style:italic">decltype</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">typed_o</span><span style="color:#fd971f">)&gt;&gt;</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#88846f">      /* Alternatively, I could `if constexpr` check here and</span></span>
<span class="line"><span style="color:#88846f">         do something else otherwise. */</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      static_assert</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">stringable</span><span style="color:#fb4934;font-weight:700">&lt;</span><span style="color:#f8f8f2">T</span><span style="color:#fb4934;font-weight:700">&gt;</span><span style="color:#f8f8f2">, </span><span style="color:#e6db74">&quot;Object must be stringable&quot;</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#a6e22e">      fmt</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">print</span><span style="color:#fd971f">(</span><span style="color:#e6db74">&quot;{}&quot;</span><span style="color:#f8f8f2">, typed_o-&gt;</span><span style="color:#a6e22e">to_string</span><span style="color:#fd971f">())</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">    }</span></span>
<span class="line"><span style="color:#fd971f">  )</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">}</span></span></code></pre><p>Finally, let's wrap up with a more real world example. In Clojure, getting the length of a sequence can be an O(n) operation. However, some sequences may already know their length, or have it cached. In Clojure, there's a <code>Counted</code> interface for this; in jank, it's called <code>countable</code>. The old inheritance version of <code>countable</code> looked like this:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> countable</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#f8f8f2">  virtual </span><span style="color:#a6e22e">~countable</span><span style="color:#fd971f">()</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#fb4934;font-weight:700"> default</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#f8f8f2">  virtual </span><span style="color:#66d9ef;font-style:italic">size_t</span><span style="color:#a6e22e"> count</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2"> const </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span></code></pre><p>The concept for it would be very similar:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">template</span><span style="color:#fd971f"> &lt;</span><span style="color:#66d9ef;font-style:italic">typename</span><span style="color:#a6e22e"> T</span><span style="color:#fd971f">&gt;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">concept</span><span style="color:#f8f8f2"> countable </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#fb4934;font-weight:700"> requires</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">T </span><span style="color:#fb4934;font-weight:700">*</span><span style="color:#f8f8f2"> const t</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#fd971f">  {</span><span style="color:#f8f8f2"> t-&gt;</span><span style="color:#a6e22e">count</span><span style="color:#fd971f">()</span><span style="color:#fd971f"> }</span><span style="color:#fb4934;font-weight:700"> -&gt;</span><span style="color:#a6e22e"> std</span><span style="color:#f8f8f2">::convertible_to</span><span style="color:#fb4934;font-weight:700">&lt;</span><span style="color:#66d9ef;font-style:italic">size_t</span><span style="color:#fb4934;font-weight:700">&gt;</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span></code></pre><p>And we can conditionally use it when measuring a sequences length:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">size_t</span><span style="color:#a6e22e"> sequence_length</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">object_ptr</span><span style="color:#f8f8f2"> const </span><span style="color:#fd971f;font-style:italic">s</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  if</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">s </span><span style="color:#fb4934;font-weight:700">==</span><span style="color:#ae81ff"> nullptr</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">  {</span><span style="color:#fb4934;font-weight:700"> return</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">; </span><span style="color:#fd971f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  return</span><span style="color:#f8f8f2"> visit_object</span></span>
<span class="line"><span style="color:#fd971f">  (</span></span>
<span class="line"><span style="color:#f8f8f2">    s,</span></span>
<span class="line"><span style="color:#f8f8f2">    [](</span><span style="color:#66d9ef;font-style:italic">auto</span><span style="color:#f8f8f2"> const </span><span style="color:#fd971f;font-style:italic">typed_s</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#fd971f">    {</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      using</span><span style="color:#a6e22e"> T</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#a6e22e"> std</span><span style="color:#f8f8f2">::</span><span style="color:#66d9ef;font-style:italic">decay_t</span><span style="color:#fd971f">&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f8f8f2">::</span><span style="color:#66d9ef;font-style:italic">remove_pointer_t</span><span style="color:#fd971f">&lt;</span><span style="color:#66d9ef;font-style:italic">decltype</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">typed_s</span><span style="color:#fd971f">)&gt;&gt;</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      if</span><span style="color:#f8f8f2"> constexpr</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">countable</span><span style="color:#fb4934;font-weight:700">&lt;</span><span style="color:#f8f8f2">T</span><span style="color:#fb4934;font-weight:700">&gt;</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">      {</span><span style="color:#fb4934;font-weight:700"> return</span><span style="color:#f8f8f2"> c-&gt;</span><span style="color:#a6e22e">count</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2">; </span><span style="color:#fd971f">}</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      else</span></span>
<span class="line"><span style="color:#fd971f">      {</span><span style="color:#88846f"> /* Normal O(n) code... */</span><span style="color:#fd971f"> }</span></span>
<span class="line"><span style="color:#fd971f">    }</span></span>
<span class="line"><span style="color:#fd971f">  )</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">}</span></span></code></pre><h2>The numbers</h2><p>This has been a lot of theory, but my aim here is to shed light on how these things work. Your feedback on whether or not this is a good level of detail is very welcome, so please reach out to me any way you can to let me know your thoughts. Now let's celebrate some wins!<p><figure width="50%"><object data="/img/blog/2023-07-08-object-model/allocations-tagged.plot.svg"type="image/svg+xml"><img src="/img/blog/2023-07-08-object-model/allocations-tagged.plot.svg"></object></figure><p><p>Non-empty map allocations are down from 31ns to 17ns, which is marginally higher than Clojure's 16ns. As I mentioned, the Boehm GC isn't the fastest on the market, so there's more work to be done here. Still, this is a huge win. Remember that jank has been consistently beating Clojure in benchmarks <em>without</em> these changes, so this is going to set it well ahead.<p><figure width="50%"><object data="/img/blog/2023-07-08-object-model/extra-benchmarks.plot.svg"type="image/svg+xml"><img src="/img/blog/2023-07-08-object-model/extra-benchmarks.plot.svg"></object></figure><p><p>Map operations such as <code>get</code> and <code>count</code> were already very fast, compared to Clojure. This is one area which allowed jank to make up for its slower allocations. However, with the static objects, visitors, and concepts, these benchmarks also dropped significantly.<p>I'm very excited to benchmark more once I've finished this work, but there's still more to do. This is only a half-way report!<h2>Status</h2><p>Initial prototyping and benchmarking is finished and I'm ripping apart jank's inheritance object model to replace it with the tagged object model. This is a large effort, which is why I wanted to get this done while jank was still young; it changes how every jank object works. At the end of the quarter, I'll be presenting more final numbers, as well as outlining future plans.<h2>Wrapping up</h2><p>You may be wondering how jank will handle dynamic objects now. For those, there will just be an enum value for dynamic, which will then rely entirely on jank protocols for its behavior. This currently cuts off the static object model from the dynamic object model, in the sense that the static objects rely on concepts and not protocols. However, I think that jank can still maintain the strong Clojure compatibility goal with this approach. ClojureScript, for example, doesn't implement all of Clojure JVM's protocol API. With this design, jank can implement all that ClojureScript does, which fits my overall mantra of &quot;If it works in both Clojure and ClojureScript, it should work in jank.&quot;<p>In the original announcement of this work, I noted that I would be investigating various ECS frameworks as a way of representing objects and behaviors. While I didn't go over them much here, I did a deep dive into them (in particular <a href="https://github.com/SanderMertens/flecs">FLECS</a> and <a href="https://github.com/skypjack/entt">EnTT</a>) and ruled them out. The primary reason is that they cannot address Concern 3, meaning they won't play well with garbage collection. The secondary reason would be that they would require multiple allocations per object, since behaviors are stored separately from entities, which is going to slow things down rather than speed them up.<p>Also, to those C++ devs wondering if I've just reimplemented <code>variant</code>, in some ways you're right. I benchmarked <code>boost::variant</code> against this implementation and it's equally fast for map <code>get</code> and <code>count</code>. However, variants are significantly slower to allocate than a <code>static_object</code>. Allocation speeds was the primary focus here, so I had to roll my own.<h2>Thanks again</h2><p>As a reminder, my work on jank this quarter is sponsored by <a href="https://www.clojuriststogether.org/">Clojurists Together</a>. Thank you to all of the members there who chose jank for this quarter. Thanks, also, to all of my <a href="https://github.com/sponsors/jeaye">Github sponsors</a>. Your continued support fuels jank's continued development!<p>I've already submitted a proposal for next quarter, to build out jank's namespace loading, class file generating, compilation cache, and class path handling. This leads into support for multi-file projects, leiningen integration, and AOT compilation, so if you'd like to see this work funded, reach out to me!<h2>Would you like to join in?</h2><ol><li>Join the community on <a href="https://clojurians.slack.com/archives/C03SRH97FDK">Slack</a><li>Join the design discussions or pick up a ticket on <a href="https://github.com/jank-lang/jank">GitHub</a><li>Considering becoming a <a href="https://github.com/sponsors/jeaye">Sponsor</a> <span class="icon mr-1"style="color:#c96198"><i class="gg-heart"></i></span><li><strong>Hire me full-time to work on jank!</strong></ol></div></div></section></div><footer class="footer"><div class="container"><div class="columns has-text-centered"></div><div class="container has-text-centered"><div class="content is-small"><p>Â© 2025 Jeaye Wilkerson | All rights reserved.</div></div></div></footer><noscript><p><img src="//matomo.jeaye.com/matomo.php?idsite=1&amp;rec=1"style="border:0"alt=""></p></noscript><script>for(var coll=document.getElementsByClassName("collapsible"),i=0;i<coll.length;i++)coll[i].addEventListener("click",function(){this.classList.toggle("active");var l=this.nextElementSibling;"block"===l.style.display?l.style.display="none":l.style.display="block"})</script>