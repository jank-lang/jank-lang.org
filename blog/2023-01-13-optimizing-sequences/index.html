<!DOCTYPE html><meta charset="utf-8"><meta content="width=device-width,initial-scale=1"name="viewport"><link href="/css/main.css"rel="stylesheet"><link href="/blog/feed.xml"rel="alternate"title="RSS Feed"type="application/atom+xml"><title>jank development update - Optimizing sequences</title><meta content="jank development update - Optimizing sequences"property="og:title"><meta content="A deep dive into Clojure&apos;s sequence API and what it takes for a native Clojure dialect to compete, in performance, with the JVM."property="og:description"><meta content="https://jank-lang.org/img/logo-text-dark.png"property="og:image"><link href="/img/favicon/apple-touch-icon.png"rel="apple-touch-icon"sizes="180x180"><link href="/img/favicon/32.png"rel="icon"sizes="32x32"type="image/png"><link href="/img/favicon/16.png"rel="icon"sizes="16x16"type="image/png"><link href="/img/favicon/site.webmanifest"rel="manifest"><style>.gg-bulb{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:16px;height:16px;border:2px solid;border-bottom-color:transparent;border-radius:100px}.gg-bulb::after,.gg-bulb::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-bulb::before{border-top:0;border-bottom-left-radius:18px;border-bottom-right-radius:18px;top:10px;border-bottom:2px solid transparent;box-shadow:0 5px 0 -2px,inset 2px 0 0 0,inset -2px 0 0 0,inset 0 -4px 0 -2px;width:8px;height:8px;left:2px}.gg-bulb::after{width:12px;height:2px;border-left:3px solid;border-right:3px solid;border-radius:2px;bottom:0;left:0}.gg-check-o{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:22px;height:22px;border:2px solid;border-radius:100px}.gg-check-o::after{content:"";display:block;box-sizing:border-box;position:absolute;left:3px;top:-1px;width:6px;height:10px;border-color:currentColor;border-width:0 2px 2px 0;border-style:solid;transform-origin:bottom left;transform:rotate(45deg)}.gg-comment{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:16px;border:2px solid;border-bottom:0;box-shadow:-6px 8px 0 -6px,6px 8px 0 -6px}.gg-comment::after,.gg-comment::before{content:"";display:block;box-sizing:border-box;position:absolute;width:8px}.gg-comment::before{border:2px solid;border-top-color:transparent;border-bottom-left-radius:20px;right:4px;bottom:-6px;height:6px}.gg-comment::after{height:2px;background:currentColor;box-shadow:0 4px 0 0;left:4px;top:4px}.gg-git-fork{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:2px;height:14px;background:currentColor}.gg-git-fork::after,.gg-git-fork::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-git-fork::before{border-right:2px solid;border-bottom:2px solid;border-bottom-right-radius:4px;bottom:4px;width:8px;height:6px;left:0}.gg-git-fork::after{width:4px;height:4px;background:currentColor;box-shadow:0 12px 0 0,6px 2px 0 0;border-radius:100%;left:-1px;top:-1px}.gg-heart,.gg-heart::after{border:2px solid;border-top-left-radius:100px;border-top-right-radius:100px;width:10px;height:8px;border-bottom:0}.gg-heart{box-sizing:border-box;position:relative;transform:translate(calc(-10px / 2 * var(--ggs,1)),calc(-6px / 2 * var(--ggs,1))) rotate(-45deg) scale(var(--ggs,1));display:block}.gg-heart::after,.gg-heart::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-heart::after{right:-9px;transform:rotate(90deg);top:5px}.gg-heart::before{width:11px;height:11px;border-left:2px solid;border-bottom:2px solid;left:-2px;top:3px}.gg-home{background:linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 0 bottom/4px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat right bottom/4px 2px;box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:18px;height:14px;border:2px solid;border-top:0;border-bottom:0;border-top-right-radius:3px;border-top-left-radius:3px;border-bottom-right-radius:0;border-bottom-left-radius:0;margin-bottom:-2px}.gg-home::after,.gg-home::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-home::before{border-top:2px solid;border-left:2px solid;border-top-left-radius:4px;transform:rotate(45deg);top:-5px;border-radius:3px;width:14px;height:14px;left:0}.gg-home::after{width:8px;height:10px;border:2px solid;border-radius:100px;border-bottom-left-radius:0;border-bottom-right-radius:0;border-bottom:0;left:3px;bottom:0}.gg-info{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:20px;border:2px solid;border-radius:40px}.gg-info::after,.gg-info::before{content:"";display:block;box-sizing:border-box;position:absolute;border-radius:3px;width:2px;background:currentColor;left:7px}.gg-info::after{bottom:2px;height:8px}.gg-info::before{height:2px;top:2px}.gg-link{box-sizing:border-box;position:relative;display:block;transform:rotate(-45deg) scale(var(--ggs,1));width:8px;height:2px;background:currentColor;border-radius:4px}.gg-link::after,.gg-link::before{content:"";display:block;box-sizing:border-box;position:absolute;border-radius:3px;width:8px;height:10px;border:2px solid;top:-4px}.gg-link::before{border-right:0;border-top-left-radius:40px;border-bottom-left-radius:40px;left:-6px}.gg-link::after{border-left:0;border-top-right-radius:40px;border-bottom-right-radius:40px;right:-6px}.gg-list{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:22px;height:20px;border:2px solid;border-radius:3px}.gg-list::after,.gg-list::before{content:"";display:block;box-sizing:border-box;position:absolute;width:2px;height:2px;background:currentColor;top:3px;left:3px;box-shadow:0 4px 0,0 8px 0}.gg-list::after{border-radius:3px;width:8px;left:7px}.gg-math-minus{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:16px;height:2px;background:currentColor;border-radius:10px}.gg-slack{position:relative;box-sizing:border-box;transform:scale(var(--ggs,1));display:block;width:20px;height:20px;background:linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 7px 2px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 15px 7px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 2px 10px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 10px 15px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 10px 2px/4px 5px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 5px 12px/4px 5px}.gg-slack::after,.gg-slack::before{background:currentColor;content:"";position:absolute;box-sizing:border-box;display:block;height:4px;border-radius:22px}.gg-slack::before{width:9px;top:5px;box-shadow:10px 5px 0}.gg-slack::after{width:4px;left:5px;box-shadow:-5px 10px 0,0 10px 0,0 15px 0,5px 15px 0,5px 5px 0,5px 0 0,10px 5px 0}.gg-sync{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));border-radius:40px;border:2px solid;margin:1px;border-left-color:transparent;border-right-color:transparent;width:18px;height:18px}.gg-sync::after,.gg-sync::before{content:"";display:block;box-sizing:border-box;position:absolute;width:0;height:0;border-top:4px solid transparent;border-bottom:4px solid transparent;transform:rotate(-45deg)}.gg-sync::before{border-left:6px solid;bottom:-1px;right:-3px}.gg-sync::after{border-right:6px solid;top:-1px;left:-3px}.gg-twitter{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:20px}.gg-twitter::after,.gg-twitter::before{content:"";display:block;position:absolute;box-sizing:border-box;left:4px}.gg-twitter::before{width:9px;height:14px;border-left:4px solid;border-bottom:4px solid;border-bottom-left-radius:6px;background:linear-gradient(to left,currentColor 12px,transparent 0) no-repeat center 2px/10px 4px;top:4px}.gg-twitter::after{width:4px;height:4px;background:currentColor;border-radius:20px;top:2px;box-shadow:7px 4px 0,7px 12px 0}</style><script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){var e="//matomo.jeaye.com/",a=(_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]),document),t=a.createElement("script"),a=a.getElementsByTagName("script")[0];t.async=!0,t.src=e+"matomo.js",a.parentNode.insertBefore(t,a)}()</script><div><div><nav class="navbar is-primary"><div class="container"><div class="navbar-brand"><a class="navbar-item title has-text-white"href="/blog"style="font-family:Comfortaa"><img src="/img/logo-transparent.png"style="margin-right:15px">jank blog</a></div><div class="navbar-menu is-active"><div class="navbar-end has-text-weight-semibold"><a class="navbar-item has-text-white"href="/"><span class="icon mr-1"><i class="gg-home"></i></span><strong>Home</strong></a><a class="navbar-item has-text-white"href="/blog"><span class="icon mr-1"><i class="gg-comment"></i></span><strong>Blog</strong></a><a class="navbar-item has-text-white"href="https://github.com/sponsors/jeaye"><span class="icon mr-1"style="color:#c96198"><i class="gg-heart"></i></span><strong>Sponsor</strong></a><a class="navbar-item has-text-white"href="https://github.com/jank-lang/jank"><span class="icon mr-1"><i class="gg-git-fork"></i></span><strong>Github</strong></a><a class="navbar-item has-text-white"href="https://clojurians.slack.com/archives/C03SRH97FDK"><span class="icon mr-1"><i class="gg-slack"></i></span>Slack</a><a class="navbar-item has-text-white"href="https://twitter.com/jeayewilkerson"><span class="icon mr-1"><i class="gg-twitter"></i></span>Twitter</a></div></div></div></nav></div><section class="section"><div class="container blog-container"><span class="is-size-1">jank development update - Optimizing sequences</span><div class="is-size-6 has-text-weight-light">Jan 13, 2023 Â· <a class="has-text-weight-normal"href="https://github.com/jeaye">Jeaye Wilkerson</a></div><hr><div class="content"><p>In this episode of jank's development updates, we follow an exciting few weekends as I was digging deep into Clojure's sequence implementation, building jank's equivalent, and then benchmarking and profiling in a dizzying race to the bottom.<h2>Introduction</h2><p>Not expecting a rabbit hole, I was originally surprised at how many allocations are involved in a normal sequence iteration in Clojure and thought to optimize that in jank. In fact, Clojure allocates a new sequence for every element over which it iterates!<p>Clojure's interface for sequences looks like this (<a href="https://github.com/clojure/clojure/blob/9e362e2ee4bf1feb942d31dac821e9d2917789b6/src/jvm/clojure/lang/ISeq.java">link</a>):<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f92672">public</span><span style="color:#f92672"> interface</span><span style="color:#a6e22e"> ISeq</span><span style="color:#f92672"> extends</span><span style="color:#a6e22e;font-style:italic"> IPersistentCollection</span></span>
<span class="line"><span style="color:#f8f8f2">{</span></span>
<span class="line"><span style="color:#88846f">  /* Returns the current front element of the sequence. */</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">  Object</span><span style="color:#a6e22e"> first</span><span style="color:#f8f8f2">();</span></span>
<span class="line"><span style="color:#88846f">  /* Returns a *new* sequence where the first is the next element, or nil. */</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">  ISeq</span><span style="color:#a6e22e"> next</span><span style="color:#f8f8f2">();</span></span>
<span class="line"><span style="color:#88846f">  /* Returns a *new* sequence where the first is the next element, or (). */</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">  ISeq</span><span style="color:#a6e22e"> more</span><span style="color:#f8f8f2">();</span></span>
<span class="line"><span style="color:#88846f">  /* Returns a *new* sequence where o is placed before the current first. */</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">  ISeq</span><span style="color:#a6e22e"> cons</span><span style="color:#f8f8f2">(</span><span style="color:#66d9ef;font-style:italic">Object</span><span style="color:#fd971f;font-style:italic"> o</span><span style="color:#f8f8f2">);</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p><p>In particular, we're interested in <code>next</code>. To look at how this is implemented, let's see an example from Clojure's <code>APersistentVector</code> sequence (<a href="https://github.com/clojure/clojure/blob/56d37996b18df811c20f391c840e7fd26ed2f58d/src/jvm/clojure/lang/APersistentVector.java#L473-L477">link</a>):<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f92672">public</span><span style="color:#66d9ef;font-style:italic"> ISeq</span><span style="color:#a6e22e"> next</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">{</span></span>
<span class="line"><span style="color:#88846f">  /* This seq has a member for the vector itself, `v`, and the current offset</span></span>
<span class="line"><span style="color:#88846f">     into it, `i`. Each iteration makes a new sequence with `i` incremented. */</span></span>
<span class="line"><span style="color:#f92672">  if</span><span style="color:#f8f8f2">(i </span><span style="color:#f92672">+</span><span style="color:#ae81ff"> 1</span><span style="color:#f92672"> &lt;</span><span style="color:#f8f8f2"> v.</span><span style="color:#a6e22e">count</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">  { </span><span style="color:#f92672">return</span><span style="color:#f92672"> new</span><span style="color:#f8f8f2"> APersistentVector.</span><span style="color:#a6e22e">Seq</span><span style="color:#f8f8f2">(v, i </span><span style="color:#f92672">+</span><span style="color:#ae81ff"> 1</span><span style="color:#f8f8f2">); }</span></span>
<span class="line"><span style="color:#f92672">  return</span><span style="color:#ae81ff"> null</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>This really surprised me, and I figured there must be a lot of cases where a sequence is only referenced in one place, so it can be changed in place in order to avoid allocations. This could <strong>potentially save millions of allocations in a typical program</strong>. For example, with something like:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">apply</span><span style="color:#f8f8f2"> str [</span><span style="color:#ae81ff">1</span><span style="color:#ae81ff"> 2</span><span style="color:#ae81ff"> 3</span><span style="color:#ae81ff"> 4</span><span style="color:#ae81ff"> 5</span><span style="color:#ae81ff"> 6</span><span style="color:#ae81ff"> 7</span><span style="color:#ae81ff"> 8</span><span style="color:#ae81ff"> 9</span><span style="color:#ae81ff"> 10</span><span style="color:#f8f8f2">])</span></span></code></pre><p>The exact <code>APersistenVector.Seq</code> from above will be used here, resulting in 10 allocations as <code>apply</code> iterates through the sequence to build the arguments for <code>str</code>. So I built something like that in jank's sequence API. It looks like this:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> sequence</span><span style="color:#f8f8f2"> : </span><span style="color:#66d9ef;font-style:italic">virtual</span><span style="color:#a6e22e"> object</span><span style="color:#f8f8f2">, </span><span style="color:#a6e22e">seqable</span></span>
<span class="line"><span style="color:#f8f8f2">{</span></span>
<span class="line"><span style="color:#f92672">  using</span><span style="color:#a6e22e"> sequence_ptr</span><span style="color:#f92672"> =</span><span style="color:#a6e22e"> detail</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">box_type</span><span style="color:#f8f8f2">&lt;</span><span style="color:#a6e22e">sequence</span><span style="color:#f8f8f2">&gt;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f92672">  virtual</span><span style="color:#a6e22e"> object_ptr</span><span style="color:#a6e22e"> first</span><span style="color:#f8f8f2">() </span><span style="color:#f92672">const</span><span style="color:#f92672"> =</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#f92672">  virtual</span><span style="color:#a6e22e"> sequence_ptr</span><span style="color:#a6e22e"> next</span><span style="color:#f8f8f2">() </span><span style="color:#f92672">const</span><span style="color:#f92672"> =</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#88846f">  /* Each call to next() allocates a new sequence_ptr, since it's polymorphic. When iterating</span></span>
<span class="line"><span style="color:#88846f">   * over a large sequence, this can mean a _lot_ of allocations. However, if you own the</span></span>
<span class="line"><span style="color:#88846f">   * sequence_ptr you have, typically meaning it wasn't a parameter, then you can mutate it</span></span>
<span class="line"><span style="color:#88846f">   * in place using this function. No allocations will happen.</span></span>
<span class="line"><span style="color:#88846f">   *</span></span>
<span class="line"><span style="color:#88846f">   * If you don't own your sequence_ptr, you can call next() on it once, to get one you</span></span>
<span class="line"><span style="color:#88846f">   * do own, and then next_in_place() on that to your heart's content. */</span></span>
<span class="line"><span style="color:#f92672">  virtual</span><span style="color:#a6e22e"> sequence_ptr</span><span style="color:#a6e22e"> next_in_place</span><span style="color:#f8f8f2">() </span><span style="color:#f92672">=</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">  /* Note, no cons here, since that's not implemented yet. */</span></span>
<span class="line"><span style="color:#f8f8f2">};</span></span></code></pre><p>The usage of <code>next_in_place</code> for all sequence traversals in jank meant that, <strong>at most, one allocation was needed for an iteration of any length</strong>. In jank's case, that meant the same <code>(apply str [1 2 3 4 5 6 7 8 9 10])</code> went from 32 sequence allocations to only 3.<p>That's a huge win. Right?<h2>The rabbit hole</h2><p>So then I benchmarked. How long does jank take to <code>apply</code> that same vector of numbers to <code>str</code>? How much did I save?<h3>jank</h3><p>Note, this benchmark fn in jank is using <a href="https://nanobench.ankerl.com/">nanobench</a>. Since jank doesn't have working macros yet, the benchmark also includes invoking the function, which is not the case for Clojure.<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">benchmark</span><span style="color:#e6db74"> &quot;apply&quot;</span></span>
<span class="line"><span style="color:#f8f8f2">           (</span><span style="color:#a6e22e">fn*</span><span style="color:#f8f8f2"> []</span></span>
<span class="line"><span style="color:#f8f8f2">             (</span><span style="color:#a6e22e">apply</span><span style="color:#f8f8f2"> str [</span><span style="color:#ae81ff">1</span><span style="color:#ae81ff"> 2</span><span style="color:#ae81ff"> 3</span><span style="color:#ae81ff"> 4</span><span style="color:#ae81ff"> 5</span><span style="color:#ae81ff"> 6</span><span style="color:#ae81ff"> 7</span><span style="color:#ae81ff"> 8</span><span style="color:#ae81ff"> 9</span><span style="color:#ae81ff"> 10</span><span style="color:#f8f8f2">])))</span></span></code></pre><p><p>Before the <code>next_in_place</code> change (<code>ns/op</code> is the primary value of interest):<table><thead><tr><th style="text-align:right">ns/op<th style="text-align:right">op/s<th style="text-align:right">err%<th style="text-align:right">ins/op<th style="text-align:right">branch/op<th style="text-align:right">miss%<th style="text-align:right">total<th style="text-align:left">benchmark<tbody><tr><td style="text-align:right">7,215.69<td style="text-align:right">138,586.80<td style="text-align:right">0.3%<td style="text-align:right">30,505.02<td style="text-align:right">8,329.00<td style="text-align:right">0.4%<td style="text-align:right">0.04<td style="text-align:left"><code>apply</code></table><p>After the <code>next_in_place</code> change:<table><thead><tr><th style="text-align:right">ns/op<th style="text-align:right">op/s<th style="text-align:right">err%<th style="text-align:right">ins/op<th style="text-align:right">branch/op<th style="text-align:right">miss%<th style="text-align:right">total<th style="text-align:left">benchmark<tbody><tr><td style="text-align:right">6,191.03<td style="text-align:right">161,523.93<td style="text-align:right">0.2%<td style="text-align:right">25,375.02<td style="text-align:right">7,220.00<td style="text-align:right">0.4%<td style="text-align:right">0.04<td style="text-align:left"><code>apply</code></table><p>Nice! That's about 1,100 ns we trimmed off there, by removing the extra allocations. I'm curious, though, how long does Clojure take to do the same thing?<h3>Clojure</h3><pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">user=&gt; (</span><span style="color:#a6e22e">quick-bench</span><span style="color:#f8f8f2"> (</span><span style="color:#a6e22e">apply</span><span style="color:#f8f8f2"> str [</span><span style="color:#ae81ff">1</span><span style="color:#ae81ff"> 2</span><span style="color:#ae81ff"> 3</span><span style="color:#ae81ff"> 4</span><span style="color:#ae81ff"> 5</span><span style="color:#ae81ff"> 6</span><span style="color:#ae81ff"> 7</span><span style="color:#ae81ff"> 8</span><span style="color:#ae81ff"> 9</span><span style="color:#ae81ff"> 10</span><span style="color:#f8f8f2">]))</span></span>
<span class="line"><span style="color:#88846f">; Evaluation count : 629958 in 6 samples of 104993 calls.</span></span>
<span class="line"><span style="color:#88846f">;              Execution time mean : 938.749444 ns</span></span>
<span class="line"><span style="color:#88846f">;     Execution time std-deviation : 27.891701 ns</span></span>
<span class="line"><span style="color:#88846f">;    Execution time lower quantile : 923.094673 ns ( 2.5%)</span></span>
<span class="line"><span style="color:#88846f">;    Execution time upper quantile : 987.172459 ns (97.5%)</span></span>
<span class="line"><span style="color:#88846f">;                    Overhead used : 14.193132 ns</span></span></code></pre><p><strong>Oh no</strong>. Clojure takes about 939 ns, while jank, even with the optimized interface, takes 6,191 ns. We're not even close!<h2>Profile, change, benchmark, repeat</h2><p>Firstly, let's compare the actual code being benchmarked here.<h3>Generated code</h3><h4>Clojure</h4><p>There is an excellent tool, which has proved useful so many times during jank's development, called <a href="https://github.com/clojure-goes-fast/clj-java-decompiler">clojure-goes-fast/clj-java-decompiler</a>. With just the following:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">user=&gt; (</span><span style="color:#f92672">require</span><span style="color:#f8f8f2"> '[clj-java-decompiler.core :refer [decompile]])</span></span>
<span class="line"><span style="color:#f8f8f2">user=&gt; (</span><span style="color:#a6e22e">decompile</span><span style="color:#f8f8f2"> (</span><span style="color:#a6e22e">apply</span><span style="color:#f8f8f2"> str [</span><span style="color:#ae81ff">1</span><span style="color:#ae81ff"> 2</span><span style="color:#ae81ff"> 3</span><span style="color:#ae81ff"> 4</span><span style="color:#ae81ff"> 5</span><span style="color:#ae81ff"> 6</span><span style="color:#ae81ff"> 7</span><span style="color:#ae81ff"> 8</span><span style="color:#ae81ff"> 9</span><span style="color:#ae81ff"> 10</span><span style="color:#f8f8f2">]))</span></span></code></pre><p><p>We get:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f92672">public</span><span style="color:#f92672"> class</span><span style="color:#a6e22e"> cjd__init</span></span>
<span class="line"><span style="color:#f8f8f2">{</span></span>
<span class="line"><span style="color:#f92672">  public</span><span style="color:#f92672"> static</span><span style="color:#f92672"> final</span><span style="color:#66d9ef;font-style:italic"> Var</span><span style="color:#f8f8f2"> const__0;</span></span>
<span class="line"><span style="color:#f92672">  public</span><span style="color:#f92672"> static</span><span style="color:#f92672"> final</span><span style="color:#66d9ef;font-style:italic"> Var</span><span style="color:#f8f8f2"> const__1;</span></span>
<span class="line"><span style="color:#f92672">  public</span><span style="color:#f92672"> static</span><span style="color:#f92672"> final</span><span style="color:#66d9ef;font-style:italic"> AFn</span><span style="color:#f8f8f2"> const__12;</span></span>
<span class="line"><span style="color:#f8f8f2">  </span></span>
<span class="line"><span style="color:#f92672">  public</span><span style="color:#f92672"> static</span><span style="color:#66d9ef;font-style:italic"> void</span><span style="color:#a6e22e"> load</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">  {</span></span>
<span class="line"><span style="color:#f8f8f2">    ((IFn)cjd__init.const__0.</span><span style="color:#a6e22e">getRawRoot</span><span style="color:#f8f8f2">()).invoke</span></span>
<span class="line"><span style="color:#f8f8f2">    (</span></span>
<span class="line"><span style="color:#f8f8f2">      cjd__init.const__1.</span><span style="color:#a6e22e">getRawRoot</span><span style="color:#f8f8f2">(),</span></span>
<span class="line"><span style="color:#f8f8f2">      cjd__init.const__12</span></span>
<span class="line"><span style="color:#f8f8f2">    );</span></span>
<span class="line"><span style="color:#f8f8f2">  }</span></span>
<span class="line"><span style="color:#f8f8f2">  </span></span>
<span class="line"><span style="color:#f92672">  public</span><span style="color:#f92672"> static</span><span style="color:#66d9ef;font-style:italic"> void</span><span style="color:#a6e22e"> __init0</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">  {</span></span>
<span class="line"><span style="color:#f8f8f2">    const__0 </span><span style="color:#f92672">=</span><span style="color:#f8f8f2"> RT.</span><span style="color:#a6e22e">var</span><span style="color:#f8f8f2">(</span><span style="color:#e6db74">&quot;clojure.core&quot;</span><span style="color:#f8f8f2">, </span><span style="color:#e6db74">&quot;apply&quot;</span><span style="color:#f8f8f2">);</span></span>
<span class="line"><span style="color:#f8f8f2">    const__1 </span><span style="color:#f92672">=</span><span style="color:#f8f8f2"> RT.</span><span style="color:#a6e22e">var</span><span style="color:#f8f8f2">(</span><span style="color:#e6db74">&quot;clojure.core&quot;</span><span style="color:#f8f8f2">, </span><span style="color:#e6db74">&quot;str&quot;</span><span style="color:#f8f8f2">);</span></span>
<span class="line"><span style="color:#f8f8f2">    const__12 </span><span style="color:#f92672">=</span><span style="color:#f8f8f2"> (AFn)RT.</span><span style="color:#a6e22e">vector</span><span style="color:#f8f8f2">(</span><span style="color:#ae81ff">1L</span><span style="color:#f8f8f2">, </span><span style="color:#ae81ff">2L</span><span style="color:#f8f8f2">, </span><span style="color:#ae81ff">3L</span><span style="color:#f8f8f2">, </span><span style="color:#ae81ff">4L</span><span style="color:#f8f8f2">, </span><span style="color:#ae81ff">5L</span><span style="color:#f8f8f2">, </span><span style="color:#ae81ff">6L</span><span style="color:#f8f8f2">, </span><span style="color:#ae81ff">7L</span><span style="color:#f8f8f2">, </span><span style="color:#ae81ff">8L</span><span style="color:#f8f8f2">, </span><span style="color:#ae81ff">9L</span><span style="color:#f8f8f2">, </span><span style="color:#ae81ff">10L</span><span style="color:#f8f8f2">);</span></span>
<span class="line"><span style="color:#f8f8f2">  }</span></span>
<span class="line"><span style="color:#f8f8f2">  </span></span>
<span class="line"><span style="color:#f92672">  static</span></span>
<span class="line"><span style="color:#f8f8f2">  {</span></span>
<span class="line"><span style="color:#a6e22e">    __init0</span><span style="color:#f8f8f2">();</span></span>
<span class="line"><span style="color:#88846f">    // A bit more redacted here ...</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p><p>So, to understand this, note that our expression <code>(apply str [1 2 3 4 5 6 7 8 9 10])</code> was turned into a Java class. The constants for <code>apply</code> and <code>str</code>, which are vars, were lifted, and our vector constant was also lifted. Those are the three <code>const__</code> members of the class, which are statically initialized. The actual code which does our <code>apply</code> is in <code>load</code>. We can see, it basically does the following, if we sanitize the lifted constants:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">apply.</span><span style="color:#a6e22e">getRawRoot</span><span style="color:#f8f8f2">().</span><span style="color:#a6e22e">invoke</span><span style="color:#f8f8f2">(str.</span><span style="color:#a6e22e">getRawRoot</span><span style="color:#f8f8f2">(), vec);</span></span></code></pre><p>Clojure's generated code seems optimal. The vars and vector are both lifted and the <code>load</code> function only gets their roots and invokes (roots can't reasonably be cached, especially during interactive programming, since vars can be redefined at any time, including from other threads). Let's see what jank is generating for this, to ensure it's equally optimized.<h4>jank</h4><pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> gen166</span><span style="color:#f8f8f2"> : jank::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">object</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">                jank::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">pool_item_base</span><span style="color:#f8f8f2">&lt;</span><span style="color:#a6e22e">gen166</span><span style="color:#f8f8f2">&gt;,</span></span>
<span class="line"><span style="color:#f8f8f2">                jank::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">behavior</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">callable</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">                jank::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">behavior</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">metadatable</span><span style="color:#f8f8f2"> {</span></span>
<span class="line"><span style="color:#88846f">  // Some bits redacted ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::context </span><span style="color:#f92672">&amp;</span><span style="color:#f8f8f2">__rt_ctx;</span></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::var_ptr </span><span style="color:#f92672">const</span><span style="color:#f8f8f2"> str155;</span></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::var_ptr </span><span style="color:#f92672">const</span><span style="color:#f8f8f2"> apply154;</span></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::object_ptr </span><span style="color:#f92672">const</span><span style="color:#f8f8f2"> const165;</span></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::object_ptr </span><span style="color:#f92672">const</span><span style="color:#f8f8f2"> const164;</span></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::object_ptr </span><span style="color:#f92672">const</span><span style="color:#f8f8f2"> const163;</span></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::object_ptr </span><span style="color:#f92672">const</span><span style="color:#f8f8f2"> const162;</span></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::object_ptr </span><span style="color:#f92672">const</span><span style="color:#f8f8f2"> const161;</span></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::object_ptr </span><span style="color:#f92672">const</span><span style="color:#f8f8f2"> const160;</span></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::object_ptr </span><span style="color:#f92672">const</span><span style="color:#f8f8f2"> const159;</span></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::object_ptr </span><span style="color:#f92672">const</span><span style="color:#f8f8f2"> const158;</span></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::object_ptr </span><span style="color:#f92672">const</span><span style="color:#f8f8f2"> const157;</span></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::object_ptr </span><span style="color:#f92672">const</span><span style="color:#f8f8f2"> const156;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#a6e22e">  gen166</span><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">context</span><span style="color:#f92672"> &amp;</span><span style="color:#fd971f;font-style:italic">__rt_ctx</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">      : </span><span style="color:#a6e22e">__rt_ctx</span><span style="color:#f8f8f2">{__rt_ctx},</span></span>
<span class="line"><span style="color:#a6e22e">        str155</span><span style="color:#f8f8f2">{__rt_ctx.</span><span style="color:#a6e22e">intern_var</span><span style="color:#f8f8f2">(</span><span style="color:#e6db74">&quot;clojure.core&quot;</span><span style="color:#f8f8f2">, </span><span style="color:#e6db74">&quot;str&quot;</span><span style="color:#f8f8f2">).</span><span style="color:#a6e22e">expect_ok</span><span style="color:#f8f8f2">()},</span></span>
<span class="line"><span style="color:#a6e22e">        apply154</span><span style="color:#f8f8f2">{__rt_ctx.</span><span style="color:#a6e22e">intern_var</span><span style="color:#f8f8f2">(</span><span style="color:#e6db74">&quot;clojure.core&quot;</span><span style="color:#f8f8f2">, </span><span style="color:#e6db74">&quot;apply&quot;</span><span style="color:#f8f8f2">).</span><span style="color:#a6e22e">expect_ok</span><span style="color:#f8f8f2">()},</span></span>
<span class="line"><span style="color:#a6e22e">        const165</span><span style="color:#f8f8f2">{</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">make_box</span><span style="color:#f8f8f2">&lt;</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">obj</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">integer</span><span style="color:#f8f8f2">&gt;(</span><span style="color:#ae81ff">10</span><span style="color:#f8f8f2">)},</span></span>
<span class="line"><span style="color:#a6e22e">        const164</span><span style="color:#f8f8f2">{</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">make_box</span><span style="color:#f8f8f2">&lt;</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">obj</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">integer</span><span style="color:#f8f8f2">&gt;(</span><span style="color:#ae81ff">9</span><span style="color:#f8f8f2">)},</span></span>
<span class="line"><span style="color:#a6e22e">        const163</span><span style="color:#f8f8f2">{</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">make_box</span><span style="color:#f8f8f2">&lt;</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">obj</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">integer</span><span style="color:#f8f8f2">&gt;(</span><span style="color:#ae81ff">8</span><span style="color:#f8f8f2">)},</span></span>
<span class="line"><span style="color:#a6e22e">        const162</span><span style="color:#f8f8f2">{</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">make_box</span><span style="color:#f8f8f2">&lt;</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">obj</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">integer</span><span style="color:#f8f8f2">&gt;(</span><span style="color:#ae81ff">7</span><span style="color:#f8f8f2">)},</span></span>
<span class="line"><span style="color:#a6e22e">        const161</span><span style="color:#f8f8f2">{</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">make_box</span><span style="color:#f8f8f2">&lt;</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">obj</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">integer</span><span style="color:#f8f8f2">&gt;(</span><span style="color:#ae81ff">6</span><span style="color:#f8f8f2">)},</span></span>
<span class="line"><span style="color:#a6e22e">        const160</span><span style="color:#f8f8f2">{</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">make_box</span><span style="color:#f8f8f2">&lt;</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">obj</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">integer</span><span style="color:#f8f8f2">&gt;(</span><span style="color:#ae81ff">5</span><span style="color:#f8f8f2">)},</span></span>
<span class="line"><span style="color:#a6e22e">        const159</span><span style="color:#f8f8f2">{</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">make_box</span><span style="color:#f8f8f2">&lt;</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">obj</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">integer</span><span style="color:#f8f8f2">&gt;(</span><span style="color:#ae81ff">4</span><span style="color:#f8f8f2">)},</span></span>
<span class="line"><span style="color:#a6e22e">        const158</span><span style="color:#f8f8f2">{</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">make_box</span><span style="color:#f8f8f2">&lt;</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">obj</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">integer</span><span style="color:#f8f8f2">&gt;(</span><span style="color:#ae81ff">3</span><span style="color:#f8f8f2">)},</span></span>
<span class="line"><span style="color:#a6e22e">        const157</span><span style="color:#f8f8f2">{</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">make_box</span><span style="color:#f8f8f2">&lt;</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">obj</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">integer</span><span style="color:#f8f8f2">&gt;(</span><span style="color:#ae81ff">2</span><span style="color:#f8f8f2">)},</span></span>
<span class="line"><span style="color:#a6e22e">        const156</span><span style="color:#f8f8f2">{</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">make_box</span><span style="color:#f8f8f2">&lt;</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">obj</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">integer</span><span style="color:#f8f8f2">&gt;(</span><span style="color:#ae81ff">1</span><span style="color:#f8f8f2">)}</span></span>
<span class="line"><span style="color:#f8f8f2">  { }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">object_ptr</span><span style="color:#a6e22e"> call</span><span style="color:#f8f8f2">() </span><span style="color:#f92672">const</span><span style="color:#f92672"> override</span></span>
<span class="line"><span style="color:#f8f8f2">  {</span></span>
<span class="line"><span style="color:#f92672">    using</span><span style="color:#66d9ef;font-style:italic"> namespace</span><span style="color:#a6e22e"> jank</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#f92672">    using</span><span style="color:#66d9ef;font-style:italic"> namespace</span><span style="color:#a6e22e"> jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#f8f8f2">    object_ptr call167;</span></span>
<span class="line"><span style="color:#f8f8f2">    {</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">      auto</span><span style="color:#f92672"> const</span><span style="color:#f92672"> &amp;</span><span style="color:#a6e22e">vec168</span><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">make_box</span><span style="color:#f8f8f2">&lt;</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">obj</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">vector</span><span style="color:#f8f8f2">&gt;(</span></span>
<span class="line"><span style="color:#f8f8f2">          const156, const157, const158, const159, const160, const161, const162,</span></span>
<span class="line"><span style="color:#f8f8f2">          const163, const164, const165));</span></span>
<span class="line"><span style="color:#f8f8f2">      call167 </span><span style="color:#f92672">=</span><span style="color:#a6e22e"> jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">dynamic_call</span><span style="color:#f8f8f2">(apply154-&gt;</span><span style="color:#a6e22e">get_root</span><span style="color:#f8f8f2">(), str155-&gt;</span><span style="color:#a6e22e">get_root</span><span style="color:#f8f8f2">(), vec168);</span></span>
<span class="line"><span style="color:#f8f8f2">    }</span></span>
<span class="line"><span style="color:#f92672">    return</span><span style="color:#f8f8f2"> call167;</span></span>
<span class="line"><span style="color:#f8f8f2">  }</span></span>
<span class="line"><span style="color:#f8f8f2">};</span></span></code></pre><p>The outline here is similar. jank generates a struct from the expression. We have constants lifted to members, and we initialize those in the struct's constructor. Then we have a <code>call</code> function which does our work. But, looking at our <code>call</code> function, we can see it's creating our vector, too; jank only lifted the numbers, not the whole vector! Let's change that.<p>The changes: <a href="https://github.com/jank-lang/jank/commit/2a8014dfae6e57273983cee8f2c7f78a2be7fe73">2a8014dfae6e57273983cee8f2c7f78a2be7fe73</a><table><thead><tr><th style="text-align:right">ns/op<th style="text-align:right">op/s<th style="text-align:right">err%<th style="text-align:right">ins/op<th style="text-align:right">branch/op<th style="text-align:right">miss%<th style="text-align:right">total<th style="text-align:left">benchmark<tbody><tr><td style="text-align:right">4,671.71<td style="text-align:right">214,054.61<td style="text-align:right">0.2%<td style="text-align:right">23,798.02<td style="text-align:right">6,721.00<td style="text-align:right">0.3%<td style="text-align:right">0.03<td style="text-align:left"><code>apply</code></table><p>Nice! We've gone from 6,191 ns to 4,671 ns by ensuring we lift the vector out. Our generated <code>call</code> function just looks like this now:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">object_ptr</span><span style="color:#a6e22e"> call</span><span style="color:#f8f8f2">() </span><span style="color:#f92672">const</span><span style="color:#f92672"> override</span></span>
<span class="line"><span style="color:#f8f8f2">{</span></span>
<span class="line"><span style="color:#f92672">  using</span><span style="color:#66d9ef;font-style:italic"> namespace</span><span style="color:#a6e22e"> jank</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#f92672">  using</span><span style="color:#66d9ef;font-style:italic"> namespace</span><span style="color:#a6e22e"> jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#f8f8f2">  object_ptr call169 </span><span style="color:#f92672">=</span><span style="color:#a6e22e"> jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::dynamic_call</span></span>
<span class="line"><span style="color:#f8f8f2">  (</span></span>
<span class="line"><span style="color:#f8f8f2">    apply154-&gt;</span><span style="color:#a6e22e">get_root</span><span style="color:#f8f8f2">(),</span></span>
<span class="line"><span style="color:#f8f8f2">    str155-&gt;</span><span style="color:#a6e22e">get_root</span><span style="color:#f8f8f2">(),</span></span>
<span class="line"><span style="color:#f8f8f2">    const166</span></span>
<span class="line"><span style="color:#f8f8f2">  );</span></span>
<span class="line"><span style="color:#f92672">  return</span><span style="color:#f8f8f2"> call169;</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>Very similar to the generated Clojure <code>load</code> function! But still over 4x slower. We know the generated code is good, so let's dig deeper into what's going on when we call these functions.<h3>Sequence lengths</h3><p>If we follow how <code>apply</code> works on the C++ side, it looks like this:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#a6e22e">object_ptr</span><span style="color:#a6e22e"> apply_to</span><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">object_ptr</span><span style="color:#f92672"> const</span><span style="color:#f92672"> &amp;</span><span style="color:#fd971f;font-style:italic">source</span><span style="color:#f8f8f2">, </span><span style="color:#a6e22e">object_ptr</span><span style="color:#f92672"> const</span><span style="color:#f92672"> &amp;</span><span style="color:#fd971f;font-style:italic">args</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">{</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">  auto</span><span style="color:#f92672"> const</span><span style="color:#f92672"> &amp;</span><span style="color:#a6e22e">s</span><span style="color:#f8f8f2">(args-&gt;</span><span style="color:#a6e22e">as_seqable</span><span style="color:#f8f8f2">()-&gt;</span><span style="color:#a6e22e">seq</span><span style="color:#f8f8f2">());</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">  auto</span><span style="color:#f92672"> const</span><span style="color:#a6e22e"> length</span><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">detail</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">sequence_length</span><span style="color:#f8f8f2">(s, max_params </span><span style="color:#f92672">+</span><span style="color:#ae81ff"> 1</span><span style="color:#f8f8f2">));</span></span>
<span class="line"><span style="color:#f92672">  switch</span><span style="color:#f8f8f2">(length)</span></span>
<span class="line"><span style="color:#f8f8f2">  {</span></span>
<span class="line"><span style="color:#f92672">    case</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">:</span></span>
<span class="line"><span style="color:#f92672">      return</span><span style="color:#a6e22e"> dynamic_call</span><span style="color:#f8f8f2">(source);</span></span>
<span class="line"><span style="color:#f92672">    case</span><span style="color:#ae81ff"> 1</span><span style="color:#f8f8f2">:</span></span>
<span class="line"><span style="color:#f92672">      return</span><span style="color:#a6e22e"> dynamic_call</span><span style="color:#f8f8f2">(source, s-&gt;</span><span style="color:#a6e22e">first</span><span style="color:#f8f8f2">());</span></span>
<span class="line"><span style="color:#f92672">    case</span><span style="color:#ae81ff"> 2</span><span style="color:#f8f8f2">:</span></span>
<span class="line"><span style="color:#f92672">      return</span><span style="color:#a6e22e"> dynamic_call</span><span style="color:#f8f8f2">(source, s-&gt;</span><span style="color:#a6e22e">first</span><span style="color:#f8f8f2">(), s-&gt;</span><span style="color:#a6e22e">next_in_place</span><span style="color:#f8f8f2">()-&gt;</span><span style="color:#a6e22e">first</span><span style="color:#f8f8f2">());</span></span>
<span class="line"><span style="color:#88846f">    // more redacted ...</span></span>
<span class="line"><span style="color:#f8f8f2">  }</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>We need to know how many arguments we're calling the function with, by getting the sequence length, and then we build out the correct call accordingly. Clojure does the same thing <a href="https://github.com/clojure/clojure/blob/9e362e2ee4bf1feb942d31dac821e9d2917789b6/src/jvm/clojure/lang/AFn.java#L147">here</a>. Right now, <code>detail::sequence_length</code> is O(n), but our sequences know their length. Let's use that and add a <code>Countable</code> behavior to get an O(1) length check here. The new function looks like:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">size_t</span><span style="color:#a6e22e"> sequence_length</span><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">behavior</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">sequence_ptr</span><span style="color:#f92672"> const</span><span style="color:#f92672"> &amp;</span><span style="color:#fd971f;font-style:italic">s</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">size_t</span><span style="color:#f92672"> const</span><span style="color:#fd971f;font-style:italic"> max</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">{</span></span>
<span class="line"><span style="color:#f92672">  if</span><span style="color:#f8f8f2">(s </span><span style="color:#f92672">==</span><span style="color:#ae81ff"> nullptr</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">  { </span><span style="color:#f92672">return</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">; }</span></span>
<span class="line"><span style="color:#88846f">  /* This is allow us to be O(1). */</span></span>
<span class="line"><span style="color:#f92672">  else</span><span style="color:#f92672"> if</span><span style="color:#f8f8f2">(</span><span style="color:#66d9ef;font-style:italic">auto</span><span style="color:#f92672"> const</span><span style="color:#f92672"> *</span><span style="color:#f92672"> const</span><span style="color:#f8f8f2"> c </span><span style="color:#f92672">=</span><span style="color:#f8f8f2"> s-&gt;</span><span style="color:#a6e22e">as_countable</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">  { </span><span style="color:#f92672">return</span><span style="color:#f8f8f2"> c-&gt;</span><span style="color:#a6e22e">count</span><span style="color:#f8f8f2">(); }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">  size_t</span><span style="color:#f8f8f2"> length{ </span><span style="color:#ae81ff">1</span><span style="color:#f8f8f2"> };</span></span>
<span class="line"><span style="color:#f92672">  for</span><span style="color:#f8f8f2">(</span><span style="color:#66d9ef;font-style:italic">auto</span><span style="color:#a6e22e"> i</span><span style="color:#f8f8f2">(s-&gt;</span><span style="color:#a6e22e">next</span><span style="color:#f8f8f2">()); i </span><span style="color:#f92672">!=</span><span style="color:#ae81ff"> nullptr</span><span style="color:#f92672"> &amp;&amp;</span><span style="color:#f8f8f2"> length </span><span style="color:#f92672">&lt;</span><span style="color:#f8f8f2"> max; i </span><span style="color:#f92672">=</span><span style="color:#f8f8f2"> i-&gt;</span><span style="color:#a6e22e">next_in_place</span><span style="color:#f8f8f2">())</span></span>
<span class="line"><span style="color:#f8f8f2">  { </span><span style="color:#f92672">++</span><span style="color:#f8f8f2">length; }</span></span>
<span class="line"><span style="color:#f92672">  return</span><span style="color:#f8f8f2"> length;</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>The changes: <a href="https://github.com/jank-lang/jank/commit/0ec065d8ed6a986690c1055ab29d91cc50680921">0ec065d8ed6a986690c1055ab29d91cc50680921</a><table><thead><tr><th style="text-align:right">ns/op<th style="text-align:right">op/s<th style="text-align:right">err%<th style="text-align:right">ins/op<th style="text-align:right">branch/op<th style="text-align:right">miss%<th style="text-align:right">total<th style="text-align:left">benchmark<tbody><tr><td style="text-align:right">4,320.42<td style="text-align:right">231,459.17<td style="text-align:right">0.4%<td style="text-align:right">21,956.02<td style="text-align:right">6,150.00<td style="text-align:right">0.4%<td style="text-align:right">0.03<td style="text-align:left"><code>apply</code></table><p>From 4,671 ns to 4,320 ns. That's good progress, but we're still a long way off from Clojure's 939 ns.<h2>Packed variadic args</h2><p>Once we get into <code>dynamic_call</code>, after <code>apply_to</code>, we need to check if the function is variadic and then pack some args accordingly. Let's take a look at our <code>str</code> function, so we can see which path will be taken.<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">(</span><span style="color:#f92672">def</span><span style="color:#f8f8f2"> str</span></span>
<span class="line"><span style="color:#f8f8f2">  (</span><span style="color:#a6e22e">fn*</span></span>
<span class="line"><span style="color:#f8f8f2">    ([]</span></span>
<span class="line"><span style="color:#e6db74">     &quot;&quot;</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">    ([o]</span></span>
<span class="line"><span style="color:#f8f8f2">     (</span><span style="color:#a6e22e">native/raw</span><span style="color:#e6db74"> &quot;__value = make_box(#{ o }#-&gt;to_string());&quot;</span><span style="color:#f8f8f2">))</span></span>
<span class="line"><span style="color:#f8f8f2">    ([o &amp; args]</span></span>
<span class="line"><span style="color:#f8f8f2">     (</span><span style="color:#a6e22e">native/raw</span><span style="color:#e6db74"> &quot;std::string ret(#{ o }#-&gt;to_string().data);</span></span>
<span class="line"><span style="color:#e6db74">                  auto const * const l(#{ args }#-&gt;as_list());</span></span>
<span class="line"><span style="color:#e6db74">                  for(auto const &amp;elem : l-&gt;data)</span></span>
<span class="line"><span style="color:#e6db74">                  { ret += elem-&gt;to_string().data; }</span></span>
<span class="line"><span style="color:#e6db74">                  __value = make_box(ret);&quot;</span><span style="color:#f8f8f2">))))</span></span></code></pre><p>Ok, so when we apply <code>[1 2 3 4 5 6 7 8 9 10]</code> to this, we'll use the variadic arity. The <code>o</code> param will be <code>1</code> and then <code>args</code> will be <code>(2 3 4 5 6 7 8 9 10)</code>. The current implementation passes in a list for <code>args</code>, which means that packing those 9 numbers requires 9 allocations. However, we can see that Clojure uses an <code>ArraySeq</code> for packed arguments instead, <a href="https://github.com/clojure/clojure/blob/9e362e2ee4bf1feb942d31dac821e9d2917789b6/src/jvm/clojure/lang/RestFn.java#L816">here</a>. Let's do that.<p>The changes: <a href="https://github.com/jank-lang/jank/commit/6e8a63ebc98c041ba86e7a1ad6839902d1ead939">6e8a63ebc98c041ba86e7a1ad6839902d1ead939</a><table><thead><tr><th style="text-align:right">ns/op<th style="text-align:right">op/s<th style="text-align:right">err%<th style="text-align:right">ins/op<th style="text-align:right">branch/op<th style="text-align:right">miss%<th style="text-align:right">total<th style="text-align:left">benchmark<tbody><tr><td style="text-align:right">2,533.89<td style="text-align:right">394,649.35<td style="text-align:right">0.3%<td style="text-align:right">12,233.02<td style="text-align:right">3,471.00<td style="text-align:right">0.1%<td style="text-align:right">0.01<td style="text-align:left"><code>apply</code></table><p>Yeah! From 4,320 ns down to 2,533 ns. <strong>Building that list was slow!</strong><h2>String formatting</h2><p>If we look at the new implementation of <code>str</code>, we're looping over our args and calling <code>to_string()</code> for each.<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">native/raw</span><span style="color:#e6db74"> &quot;std::string ret(#{ o }#-&gt;to_string().data);</span></span>
<span class="line"><span style="color:#e6db74">             auto const &amp;seq(#{ args }#-&gt;as_seqable()-&gt;seq());</span></span>
<span class="line"><span style="color:#e6db74">             ret += seq-&gt;first()-&gt;to_string();</span></span>
<span class="line"><span style="color:#e6db74">             for(auto it(seq-&gt;next_in_place()); it != nullptr; it = it-&gt;next_in_place())</span></span>
<span class="line"><span style="color:#e6db74">             { ret += it-&gt;first()-&gt;to_string().data; }</span></span>
<span class="line"><span style="color:#e6db74">             __value = make_box(ret);&quot;</span><span style="color:#f8f8f2">)</span></span></code></pre><p>But that means we need to allocate a new <code>std::string</code> for every argument, then concatenate that into our accumulator, which likely requires yet another allocation. Let's use <a href="https://github.com/fmtlib/fmt">fmt</a>'s string building to do this all in place. That means jank's base runtime <code>object</code> expands its interface to have two <code>to_string</code> functions:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> object</span><span style="color:#f8f8f2"> : </span><span style="color:#66d9ef;font-style:italic">virtual</span><span style="color:#a6e22e"> pool_item_common_base</span></span>
<span class="line"><span style="color:#f8f8f2">{</span></span>
<span class="line"><span style="color:#88846f">  // redacted ...</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f92672">  virtual</span><span style="color:#a6e22e"> detail</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">string_type</span><span style="color:#a6e22e"> to_string</span><span style="color:#f8f8f2">() </span><span style="color:#f92672">const</span><span style="color:#f92672"> =</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#f92672">  virtual</span><span style="color:#66d9ef;font-style:italic"> void</span><span style="color:#a6e22e"> to_string</span><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">fmt</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">memory_buffer</span><span style="color:#f92672"> &amp;</span><span style="color:#fd971f;font-style:italic">buffer</span><span style="color:#f8f8f2">) </span><span style="color:#f92672">const</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">  // redacted ...</span></span>
<span class="line"><span style="color:#f8f8f2">};</span></span></code></pre><p>If we look at the implementation of this for <code>integer</code>, we can see a neat usage of <code>FMT_COMPILE</code>. This allows us to compile our format string ahead of time, leading to very efficient rendering at run-time.<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">void</span><span style="color:#a6e22e"> integer</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">to_string</span><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">fmt</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">memory_buffer</span><span style="color:#f92672"> &amp;</span><span style="color:#fd971f;font-style:italic">buff</span><span style="color:#f8f8f2">) </span><span style="color:#f92672">const</span></span>
<span class="line"><span style="color:#f8f8f2">{ </span><span style="color:#a6e22e">fmt</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">format_to</span><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">std</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">back_inserter</span><span style="color:#f8f8f2">(buff), </span><span style="color:#a6e22e">FMT_COMPILE</span><span style="color:#f8f8f2">(</span><span style="color:#e6db74">&quot;{}&quot;</span><span style="color:#f8f8f2">), data); }</span></span></code></pre><p>The changes: <a href="https://github.com/jank-lang/jank/commit/819e1a178c3be549c894e9386e9dc54513800fe8">819e1a178c3be549c894e9386e9dc54513800fe8</a><table><thead><tr><th style="text-align:right">ns/op<th style="text-align:right">op/s<th style="text-align:right">err%<th style="text-align:right">ins/op<th style="text-align:right">branch/op<th style="text-align:right">miss%<th style="text-align:right">total<th style="text-align:left">benchmark<tbody><tr><td style="text-align:right">2,375.56<td style="text-align:right">420,952.59<td style="text-align:right">0.3%<td style="text-align:right">10,751.02<td style="text-align:right">3,070.00<td style="text-align:right">0.2%<td style="text-align:right">0.01<td style="text-align:left"><code>apply</code></table><p>From 2,533 ns to 2,375 ns.<h2>Further sequence interface optimizations</h2><p>To kick things off, we added the <code>next_in_place</code> function to the sequence interface, but there are two things which can easily be identified by looking at the previous <code>apply_to</code> snippet:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#a6e22e">object_ptr</span><span style="color:#a6e22e"> apply_to</span><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">object_ptr</span><span style="color:#f92672"> const</span><span style="color:#f92672"> &amp;</span><span style="color:#fd971f;font-style:italic">source</span><span style="color:#f8f8f2">, </span><span style="color:#a6e22e">object_ptr</span><span style="color:#f92672"> const</span><span style="color:#f92672"> &amp;</span><span style="color:#fd971f;font-style:italic">args</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#f8f8f2">{</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">  auto</span><span style="color:#f92672"> const</span><span style="color:#f92672"> &amp;</span><span style="color:#a6e22e">s</span><span style="color:#f8f8f2">(args-&gt;</span><span style="color:#a6e22e">as_seqable</span><span style="color:#f8f8f2">()-&gt;</span><span style="color:#a6e22e">seq</span><span style="color:#f8f8f2">());</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">  auto</span><span style="color:#f92672"> const</span><span style="color:#a6e22e"> length</span><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">detail</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">sequence_length</span><span style="color:#f8f8f2">(s, max_params </span><span style="color:#f92672">+</span><span style="color:#ae81ff"> 1</span><span style="color:#f8f8f2">));</span></span>
<span class="line"><span style="color:#f92672">  switch</span><span style="color:#f8f8f2">(length)</span></span>
<span class="line"><span style="color:#f8f8f2">  {</span></span>
<span class="line"><span style="color:#88846f">    // redacted some ...</span></span>
<span class="line"><span style="color:#f92672">    case</span><span style="color:#ae81ff"> 2</span><span style="color:#f8f8f2">:</span></span>
<span class="line"><span style="color:#f92672">      return</span><span style="color:#a6e22e"> dynamic_call</span><span style="color:#f8f8f2">(source, s-&gt;</span><span style="color:#a6e22e">first</span><span style="color:#f8f8f2">(), s-&gt;</span><span style="color:#a6e22e">next_in_place</span><span style="color:#f8f8f2">()-&gt;</span><span style="color:#a6e22e">first</span><span style="color:#f8f8f2">());</span></span>
<span class="line"><span style="color:#f92672">    case</span><span style="color:#ae81ff"> 3</span><span style="color:#f8f8f2">:</span></span>
<span class="line"><span style="color:#f92672">      return</span><span style="color:#f8f8f2"> dynamic_call</span></span>
<span class="line"><span style="color:#f8f8f2">      (</span></span>
<span class="line"><span style="color:#f8f8f2">        source,</span></span>
<span class="line"><span style="color:#f8f8f2">        s-&gt;</span><span style="color:#a6e22e">first</span><span style="color:#f8f8f2">(),</span></span>
<span class="line"><span style="color:#f8f8f2">        s-&gt;</span><span style="color:#a6e22e">next_in_place</span><span style="color:#f8f8f2">()-&gt;</span><span style="color:#a6e22e">first</span><span style="color:#f8f8f2">(),</span></span>
<span class="line"><span style="color:#f8f8f2">        s-&gt;</span><span style="color:#a6e22e">next_in_place</span><span style="color:#f8f8f2">()-&gt;</span><span style="color:#a6e22e">first</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">      );</span></span>
<span class="line"><span style="color:#f92672">    case</span><span style="color:#ae81ff"> 4</span><span style="color:#f8f8f2">:</span></span>
<span class="line"><span style="color:#f92672">      return</span><span style="color:#f8f8f2"> dynamic_call</span></span>
<span class="line"><span style="color:#f8f8f2">      (</span></span>
<span class="line"><span style="color:#f8f8f2">        source,</span></span>
<span class="line"><span style="color:#f8f8f2">        s-&gt;</span><span style="color:#a6e22e">first</span><span style="color:#f8f8f2">(),</span></span>
<span class="line"><span style="color:#f8f8f2">        s-&gt;</span><span style="color:#a6e22e">next_in_place</span><span style="color:#f8f8f2">()-&gt;</span><span style="color:#a6e22e">first</span><span style="color:#f8f8f2">(),</span></span>
<span class="line"><span style="color:#f8f8f2">        s-&gt;</span><span style="color:#a6e22e">next_in_place</span><span style="color:#f8f8f2">()-&gt;</span><span style="color:#a6e22e">first</span><span style="color:#f8f8f2">(),</span></span>
<span class="line"><span style="color:#f8f8f2">        s-&gt;</span><span style="color:#a6e22e">next_in_place</span><span style="color:#f8f8f2">()-&gt;</span><span style="color:#a6e22e">first</span><span style="color:#f8f8f2">()</span></span>
<span class="line"><span style="color:#f8f8f2">      );</span></span>
<span class="line"><span style="color:#88846f">    // more redacted ...</span></span>
<span class="line"><span style="color:#f8f8f2">  }</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>1. We're very often following up <code>next_in_place</code> with a call to <code>first</code>, which is another virtual call<p><strong>Solution:</strong> Also add a <code>next_in_place_first</code>, which does both. It's not a pretty interface, but for cases like <code>apply_to</code> with 10 arguments, that's an extra 10 virtual calls we save. Worth it.<p>2. We have <code>next_in_place</code> returning a smart ptr, but for in-place updates, we don't need to keep updating reference counts<p><strong>Solution:</strong> Just return a raw pointer from <code>next_in_place</code> and stop with all the reference counting.<p>The changes: <a href="https://github.com/jank-lang/jank/commit/c1e8da91bfe65bc6b8b02a9c8636de87a24f6110">c1e8da91bfe65bc6b8b02a9c8636de87a24f6110</a> and <a href="https://github.com/jank-lang/jank/commit/09ac8e31ef2337b7fb5d046a85302d2755d570f3">09ac8e31ef2337b7fb5d046a85302d2755d570f3</a><table><thead><tr><th style="text-align:right">ns/op<th style="text-align:right">op/s<th style="text-align:right">err%<th style="text-align:right">ins/op<th style="text-align:right">branch/op<th style="text-align:right">miss%<th style="text-align:right">total<th style="text-align:left">benchmark<tbody><tr><td style="text-align:right">2,015.26<td style="text-align:right">496,213.24<td style="text-align:right">0.1%<td style="text-align:right">8,978.00<td style="text-align:right">2,518.00<td style="text-align:right">0.2%<td style="text-align:right">0.12<td style="text-align:left"><code>apply</code></table><p>We're nearly under 2k ns now! From 2,375 ns to 2,015 ns was a good win.<h2>Faster synchronization</h2><p>At this point, profiling isn't pointing out anything to do with sequences anymore. Instead, all of the time is spent doing three things:<ol><li>Building strings from integers<li>Getting var roots<li>Updating reference counts</ol><p>Only one of those is what we really care about, so let's see if we can trim down the var root accessing. I mentioned earlier that Clojure/jank vars can be redefined at any time, from any thread, so they require synchronization. I was using <a href="https://github.com/copperspice/cs_libguarded">libguarded</a>, but I gave <a href="https://github.com/facebook/folly/blob/main/folly/docs/Synchronized.md">folly's synchronization</a> a shot and it was a big win.<p>The changes: <a href="https://github.com/jank-lang/jank/commit/059e828c789b7782595007dcb5a389fe1db442ac">059e828c789b7782595007dcb5a389fe1db442ac</a><table><thead><tr><th style="text-align:right">ns/op<th style="text-align:right">op/s<th style="text-align:right">err%<th style="text-align:right">ins/op<th style="text-align:right">branch/op<th style="text-align:right">miss%<th style="text-align:right">total<th style="text-align:left">benchmark<tbody><tr><td style="text-align:right">1,776.69<td style="text-align:right">562,843.97<td style="text-align:right">0.3%<td style="text-align:right">7,942.00<td style="text-align:right">2,214.00<td style="text-align:right">0.2%<td style="text-align:right">0.11<td style="text-align:left"><code>apply</code></table><p>Oh yeah. We're down from 2,015 ns to 1,776 ns. Under 2x of Clojure's benchmark time. Profiling still shows that we're spending our time:<ol><li>Building strings from integers<li>Updating reference counts</ol><p>Since jank is using <code>boost::intrusive_ptr</code> and a custom arena memory pool for object lifecycle managements, for the benefit of deterministic object lifetimes, there's not much more we can do there. In fact, Clojure's cheating a bit, since it's not cleaning up any of its garbage in its benchmark, while jank is leaving everything as it found it.<h2>Garbage collector?</h2><p>In truth, I paused for a while here, thinking about what could be done. For jank, I have so far intentionally chosen not to use a GC. The C++ part of my brain grasps for <a href="https://en.cppreference.com/w/cpp/language/raii">RAII</a> and deterministic object lifetimes.<p>But, as I thought about the benefits of RAII in Clojure, they became harder to justify. Here are some of the things I considered.<ol><li>Constructors and destructors make sense for allocating and deallocating resources, specifically mutable resources like a DB connection or file handle<li>Deterministic object lifetimes especially matter when objects contain these resources, since we can't have them lingering beyond when we need them<li>Clojure handles resource management in an entirely different way and its object system is not used for this; it's just used for the polymorphic treatment of various Clojure runtime types<li>Nearly all of the Clojure runtime types are just immutable values; knowing when they are cleaned up doesn't matter, outside of ensuring memory usage doesn't grow too much. They don't have destructors that are doing anything important.</ol><p>So, the only arguments remaining for not using a GC for a Clojure dialect were:<ol><li>GC pauses can limit the language's use cases<li>Deterministic object lifetimes grant a better idea of how much memory will be used at any given time, which is saner for environments such as embedded systems</ol><p>For the first point, the <a href="https://github.com/ivmai/bdwgc">Boehm GC</a> supports an incremental mode, which does small amounts of freeing work during allocations, rather than pausing. For the second point, I had to consider if this ever mattered to me when I was writing a Clojure application, or if it would matter to me with what I have planned for jank. I figured I'd see how much the GC moved the needle first, before deciding anything.<p>The changes: <a href="https://github.com/jank-lang/jank/commit/995bec7377fec04ddc5744eed5f1d1149ccc3019">995bec7377fec04ddc5744eed5f1d1149ccc3019</a><table><thead><tr><th style="text-align:right">ns/op<th style="text-align:right">op/s<th style="text-align:right">err%<th style="text-align:right">ins/op<th style="text-align:right">branch/op<th style="text-align:right">miss%<th style="text-align:right">total<th style="text-align:left">benchmark<tbody><tr><td style="text-align:right">966.15<td style="text-align:right">1,035,032.47<td style="text-align:right">3.2%<td style="text-align:right">5,250.10<td style="text-align:right">1,353.26<td style="text-align:right">0.2%<td style="text-align:right">0.09<td style="text-align:left"><code>apply</code></table><p>Ok, <strong>that's a huge win</strong>. Clojure was at 939 ns and we're now at 966 ns. I had said in <a href="https://clojurians.slack.com/archives/C03SRH97FDK/p1671038588821099?thread_ts=1671030141.013459&amp;cid=C03SRH97FDK">#jank</a>, when someone asked if jank was going to use a GC, that I'd rather have determinism, if it means jank is marginally slower. However, the difference here is not marginal. To make matters worse, the current reference counting approach isn't even thread-safe; I'd need to use an atomic size_t for that, which would slow things down even more. This GC is thread-safe.<p>But we're so close to actually <em>beating</em> Clojure, why not try?<h2>A couple more wins</h2><p>Since we brought in folly for synchronization, we might as well use its <a href="https://github.com/facebook/folly/blob/main/folly/docs/FBString.md">fbstring</a>, which is compliant with <code>std::string</code> and is more heavily optimized.<p>The changes: <a href="https://github.com/jank-lang/jank/commit/f323d5f4e7854c029a79cc28865dabd5e9e063d0">f323d5f4e7854c029a79cc28865dabd5e9e063d0</a><p>Also, if we get really picky in the profiler, we can see that the jank sequence we were using for iterating over the <code>[1 2 3 4 5 6 7 8 9 10]</code> vector is showing up, since we're incrementing an dereferencing <a href="https://github.com/arximboldi/immer">immer</a> iterators. What if we just use an index, like with our <code>array_sequence</code>?<p>The changes: <a href="https://github.com/jank-lang/jank/commit/42132be331862688e09c42c15e4af8285b0f3591">42132be331862688e09c42c15e4af8285b0f3591</a><table><thead><tr><th style="text-align:right">ns/op<th style="text-align:right">op/s<th style="text-align:right">err%<th style="text-align:right">ins/op<th style="text-align:right">branch/op<th style="text-align:right">miss%<th style="text-align:right">total<th style="text-align:left">benchmark<tbody><tr><td style="text-align:right">911.60<td style="text-align:right">1,096,970.83<td style="text-align:right">0.9%<td style="text-align:right">5,316.51<td style="text-align:right">1,350.48<td style="text-align:right">0.2%<td style="text-align:right">0.01<td style="text-align:left"><code>apply</code></table><p>We can now run that Clojure expression over a million times per second and, in this micro benchmark, jank is faster than Clojure. <strong>We can do in 912 ns what Clojure takes a paltry 939 ns to do</strong>. More, even, since remember that our benchmark also includes calling the function wrapping the code.<h2>Closing notes</h2><p>This was a lot of fun to do, and I did not have the intention of starting down this rabbit hole when I was just looking to implement jank's sequence API. Still, we've ended up with a much better understanding of Clojure, much more optimized sequence, format, synchronization, and string systems in jank, and, well, a garbage collector.<p>It's important to call out that this is a micro benchmark, which means it doesn't mean that much in practice. The JVM, and thus Clojure, has an optimizing JIT compiler, which jank does not have. Each of these languages are now cheating by not cleaning up their garbage during this benchmark, but how they do and when they do has a huge impact on the usability of the runtime. Neither of these programs were AOT compiled, since benchmarking was done in a REPL. Furthermore, there's a lot more to most programs than just what's been covered here. Though I'm very excited about the progress, I can't reasonably claim jank is faster than Clojure for anything but this micro benchmark.<p>That is, until I make larger benchmarks and spend weeks optimizing those.<h2>Would you like to join in?</h2><ol><li>Join the community on <a href="https://clojurians.slack.com/archives/C03SRH97FDK">Slack</a><li>Join the design discussions on <a href="https://github.com/jank-lang/jank/discussions">Github</a><li>Considering becoming a <a href="https://github.com/sponsors/jeaye">Sponsor</a></ol></div></div></section></div><footer class="footer"><div class="container"><div class="columns has-text-centered"></div><div class="container has-text-centered"><div class="content is-small"><p>Â© 2024 Jeaye Wilkerson | All rights reserved.</div></div></div></footer><noscript><p><img src="//matomo.jeaye.com/matomo.php?idsite=1&amp;rec=1"style="border:0"alt=""></p></noscript><script>for(var coll=document.getElementsByClassName("collapsible"),i=0;i<coll.length;i++)coll[i].addEventListener("click",function(){this.classList.toggle("active");var l=this.nextElementSibling;"block"===l.style.display?l.style.display="none":l.style.display="block"})</script>