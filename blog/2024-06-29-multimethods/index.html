<!DOCTYPE html><meta charset="utf-8"><meta content="width=device-width,initial-scale=1"name="viewport"><link href="/css/main.css"rel="stylesheet"><link href="/blog/feed.xml"rel="alternate"title="RSS Feed"type="application/atom+xml"><title>jank development update - Multimethods!</title><meta content="jank development update - Multimethods!"property="og:title"><meta content="Learn some neat multimethod tricks as you read about the latest progress in the upcoming native Clojure dialect on LLVM."property="og:description"><meta content="https://jank-lang.org/img/logo-text-dark.png"property="og:image"><link href="/img/favicon/apple-touch-icon.png"rel="apple-touch-icon"sizes="180x180"><link href="/img/favicon/32.png"rel="icon"sizes="32x32"type="image/png"><link href="/img/favicon/16.png"rel="icon"sizes="16x16"type="image/png"><link href="/img/favicon/site.webmanifest"rel="manifest"><style>.gg-bulb{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:16px;height:16px;border:2px solid;border-bottom-color:transparent;border-radius:100px}.gg-bulb::after,.gg-bulb::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-bulb::before{border-top:0;border-bottom-left-radius:18px;border-bottom-right-radius:18px;top:10px;border-bottom:2px solid transparent;box-shadow:0 5px 0 -2px,inset 2px 0 0 0,inset -2px 0 0 0,inset 0 -4px 0 -2px;width:8px;height:8px;left:2px}.gg-bulb::after{width:12px;height:2px;border-left:3px solid;border-right:3px solid;border-radius:2px;bottom:0;left:0}.gg-check-o{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:22px;height:22px;border:2px solid;border-radius:100px}.gg-check-o::after{content:"";display:block;box-sizing:border-box;position:absolute;left:3px;top:-1px;width:6px;height:10px;border-color:currentColor;border-width:0 2px 2px 0;border-style:solid;transform-origin:bottom left;transform:rotate(45deg)}.gg-comment{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:16px;border:2px solid;border-bottom:0;box-shadow:-6px 8px 0 -6px,6px 8px 0 -6px}.gg-comment::after,.gg-comment::before{content:"";display:block;box-sizing:border-box;position:absolute;width:8px}.gg-comment::before{border:2px solid;border-top-color:transparent;border-bottom-left-radius:20px;right:4px;bottom:-6px;height:6px}.gg-comment::after{height:2px;background:currentColor;box-shadow:0 4px 0 0;left:4px;top:4px}.gg-git-fork{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:2px;height:14px;background:currentColor}.gg-git-fork::after,.gg-git-fork::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-git-fork::before{border-right:2px solid;border-bottom:2px solid;border-bottom-right-radius:4px;bottom:4px;width:8px;height:6px;left:0}.gg-git-fork::after{width:4px;height:4px;background:currentColor;box-shadow:0 12px 0 0,6px 2px 0 0;border-radius:100%;left:-1px;top:-1px}.gg-heart,.gg-heart::after{border:2px solid;border-top-left-radius:100px;border-top-right-radius:100px;width:10px;height:8px;border-bottom:0}.gg-heart{box-sizing:border-box;position:relative;transform:translate(calc(-10px / 2 * var(--ggs,1)),calc(-6px / 2 * var(--ggs,1))) rotate(-45deg) scale(var(--ggs,1));display:block}.gg-heart::after,.gg-heart::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-heart::after{right:-9px;transform:rotate(90deg);top:5px}.gg-heart::before{width:11px;height:11px;border-left:2px solid;border-bottom:2px solid;left:-2px;top:3px}.gg-home{background:linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 0 bottom/4px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat right bottom/4px 2px;box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:18px;height:14px;border:2px solid;border-top:0;border-bottom:0;border-top-right-radius:3px;border-top-left-radius:3px;border-bottom-right-radius:0;border-bottom-left-radius:0;margin-bottom:-2px}.gg-home::after,.gg-home::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-home::before{border-top:2px solid;border-left:2px solid;border-top-left-radius:4px;transform:rotate(45deg);top:-5px;border-radius:3px;width:14px;height:14px;left:0}.gg-home::after{width:8px;height:10px;border:2px solid;border-radius:100px;border-bottom-left-radius:0;border-bottom-right-radius:0;border-bottom:0;left:3px;bottom:0}.gg-info{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:20px;border:2px solid;border-radius:40px}.gg-info::after,.gg-info::before{content:"";display:block;box-sizing:border-box;position:absolute;border-radius:3px;width:2px;background:currentColor;left:7px}.gg-info::after{bottom:2px;height:8px}.gg-info::before{height:2px;top:2px}.gg-link{box-sizing:border-box;position:relative;display:block;transform:rotate(-45deg) scale(var(--ggs,1));width:8px;height:2px;background:currentColor;border-radius:4px}.gg-link::after,.gg-link::before{content:"";display:block;box-sizing:border-box;position:absolute;border-radius:3px;width:8px;height:10px;border:2px solid;top:-4px}.gg-link::before{border-right:0;border-top-left-radius:40px;border-bottom-left-radius:40px;left:-6px}.gg-link::after{border-left:0;border-top-right-radius:40px;border-bottom-right-radius:40px;right:-6px}.gg-list{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:22px;height:20px;border:2px solid;border-radius:3px}.gg-list::after,.gg-list::before{content:"";display:block;box-sizing:border-box;position:absolute;width:2px;height:2px;background:currentColor;top:3px;left:3px;box-shadow:0 4px 0,0 8px 0}.gg-list::after{border-radius:3px;width:8px;left:7px}.gg-math-minus{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:16px;height:2px;background:currentColor;border-radius:10px}.gg-slack{position:relative;box-sizing:border-box;transform:scale(var(--ggs,1));display:block;width:20px;height:20px;background:linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 7px 2px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 15px 7px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 2px 10px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 10px 15px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 10px 2px/4px 5px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 5px 12px/4px 5px}.gg-slack::after,.gg-slack::before{background:currentColor;content:"";position:absolute;box-sizing:border-box;display:block;height:4px;border-radius:22px}.gg-slack::before{width:9px;top:5px;box-shadow:10px 5px 0}.gg-slack::after{width:4px;left:5px;box-shadow:-5px 10px 0,0 10px 0,0 15px 0,5px 15px 0,5px 5px 0,5px 0 0,10px 5px 0}.gg-sync{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));border-radius:40px;border:2px solid;margin:1px;border-left-color:transparent;border-right-color:transparent;width:18px;height:18px}.gg-sync::after,.gg-sync::before{content:"";display:block;box-sizing:border-box;position:absolute;width:0;height:0;border-top:4px solid transparent;border-bottom:4px solid transparent;transform:rotate(-45deg)}.gg-sync::before{border-left:6px solid;bottom:-1px;right:-3px}.gg-sync::after{border-right:6px solid;top:-1px;left:-3px}.gg-twitter{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:20px}.gg-twitter::after,.gg-twitter::before{content:"";display:block;position:absolute;box-sizing:border-box;left:4px}.gg-twitter::before{width:9px;height:14px;border-left:4px solid;border-bottom:4px solid;border-bottom-left-radius:6px;background:linear-gradient(to left,currentColor 12px,transparent 0) no-repeat center 2px/10px 4px;top:4px}.gg-twitter::after{width:4px;height:4px;background:currentColor;border-radius:20px;top:2px;box-shadow:7px 4px 0,7px 12px 0}</style><script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){var e="//matomo.jeaye.com/",a=(_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]),document),t=a.createElement("script"),a=a.getElementsByTagName("script")[0];t.async=!0,t.src=e+"matomo.js",a.parentNode.insertBefore(t,a)}()</script><div><div><nav class="navbar is-primary"><div class="container"><div class="navbar-brand"><a class="navbar-item title has-text-white"href="/blog"style="font-family:Comfortaa"><img src="/img/logo-transparent.png"style="margin-right:15px">jank blog</a></div><div class="navbar-menu is-active"><div class="navbar-end has-text-weight-semibold"><a class="navbar-item has-text-white"href="/"><span class="icon mr-1"><i class="gg-home"></i></span><strong>Home</strong></a><a class="navbar-item has-text-white"href="/blog"><span class="icon mr-1"><i class="gg-comment"></i></span><strong>Blog</strong></a><a class="navbar-item has-text-white"href="https://github.com/sponsors/jeaye"><span class="icon mr-1"style="color:#c96198"><i class="gg-heart"></i></span><strong>Sponsor</strong></a><a class="navbar-item has-text-white"href="https://github.com/jank-lang/jank"><span class="icon mr-1"><i class="gg-git-fork"></i></span><strong>Github</strong></a><a class="navbar-item has-text-white"href="https://clojurians.slack.com/archives/C03SRH97FDK"><span class="icon mr-1"><i class="gg-slack"></i></span>Slack</a><a class="navbar-item has-text-white"href="https://twitter.com/jeayewilkerson"><span class="icon mr-1"><i class="gg-twitter"></i></span>Twitter</a></div></div></div></nav></div><section class="section"><div class="container blog-container"><span class="is-size-1">jank development update - Multimethods!</span><div class="is-size-6 has-text-weight-light">Jun 29, 2024 · <a class="has-text-weight-normal"href="https://github.com/jeaye">Jeaye Wilkerson</a></div><hr><div class="content"><p>Welcome back to another jank development update! For the past month, I've been pushing jank closer to production readiness primarily by working on multimethods and by debugging issues with Clang 19 (currently unreleased). Much love to <a href="https://www.clojuriststogether.org/">Clojurists Together</a> and all of my <a href="https://github.com/sponsors/jeaye">Github sponsors</a> for their support this quarter.<h2>Multimethods</h2><p>I thought, going into this month, that I had a good idea of how multimethods work in Clojure. I figured we define a dispatch function with <code>defmulti</code>:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">(</span><span style="color:#f92672">defmulti</span><span style="color:#f8f8f2"> sauce-suggestion ::noodle-type)</span></span></code></pre><p>Then we define our catch-all method for handling types:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">(</span><span style="color:#f92672">defmethod</span><span style="color:#f8f8f2"> sauce-suggestion :default [noodle]</span></span>
<span class="line"><span style="color:#f8f8f2">  (</span><span style="color:#a6e22e">println</span><span style="color:#e6db74"> &quot;You can't go wrong with some butter and garlic.&quot;</span><span style="color:#f8f8f2">))</span></span></code></pre><p>Then we define some specializations for certain values which come out of our dispatch function.<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">(</span><span style="color:#f92672">defmethod</span><span style="color:#f8f8f2"> sauce-suggestion ::shell [noodle]</span></span>
<span class="line"><span style="color:#f8f8f2">  (</span><span style="color:#a6e22e">println</span><span style="color:#e6db74"> &quot;Cheeeeeeeese!&quot;</span><span style="color:#f8f8f2">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">(</span><span style="color:#f92672">defmethod</span><span style="color:#f8f8f2"> sauce-suggestion ::flate-white-rice [noodle]</span></span>
<span class="line"><span style="color:#f8f8f2">  (</span><span style="color:#a6e22e">println</span><span style="color:#e6db74"> &quot;Hor fun gravy.&quot;</span><span style="color:#f8f8f2">))</span></span></code></pre><p>Then, when you call the <code>sauce-suggestion</code> function, first the dispatch function is called and then the correct method is looked up and called.<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">sauce-suggestion</span><span style="color:#f8f8f2"> {::noodle-type ::shell})</span></span>
<span class="line"><span style="color:#f8f8f2">Cheeeeeeeese!</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">sauce-suggestion</span><span style="color:#f8f8f2"> {::noodle-type ::spaghetti})</span></span>
<span class="line"><span style="color:#f8f8f2">You can't go wrong with some butter and garlic.</span></span></code></pre><p>This is as much as I knew. But wait, there's more!<h3>Hierarchies</h3><p>It turns out that multimethods match dispatch values based on a couple of different hierarchies, too. If you're matching actual class types, like <code>String</code>, you could have a method which is parameterized on <code>Object</code> and it will be a catch-all. So this would allow you to match on everything which inherits from <code>IRenderable</code>, for example, and then use that interface to render the object. I wasn't concerned about this, since jank's object model isn't based on inheritance. I figured I could leave this whole feature out of multimethods.<p>However, it turns out that Clojure supports another form of hierarchies! Even crazier, we have full control over those hierarchies at run-time and we can build as many as we want. Check this out.<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#88846f">; We can classify spaghetti and penne as Italian.</span></span>
<span class="line"><span style="color:#88846f">; They will both be considered children of ::italian.</span></span>
<span class="line"><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">derive</span><span style="color:#f8f8f2"> ::spaghetti ::italian)</span></span>
<span class="line"><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">derive</span><span style="color:#f8f8f2"> ::penne ::italian)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">; Then we can define a method based on the parent.</span></span>
<span class="line"><span style="color:#f8f8f2">(</span><span style="color:#f92672">defmethod</span><span style="color:#f8f8f2"> sauce-suggestion ::italian [noodle]</span></span>
<span class="line"><span style="color:#f8f8f2">  (</span><span style="color:#a6e22e">println</span><span style="color:#e6db74"> &quot;Sugo al pomodoro.&quot;</span><span style="color:#f8f8f2">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">; This allows us to match multiple dispatch values in a</span></span>
<span class="line"><span style="color:#88846f">; deterministic and intuitive way.</span></span>
<span class="line"><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">sauce-suggestion</span><span style="color:#f8f8f2"> {::noodle-type ::penne})</span></span>
<span class="line"><span style="color:#f8f8f2">Sugo al pomodoro.</span></span></code></pre><p>There are a handful of related core functions for working with these hierarchies. jank now implements all of them.<ul><li><code>make-hierarchy</code><li><code>isa?</code><li><code>parents</code><li><code>ancestors</code><li><code>descendents</code><li><code>derive</code><li><code>underive</code></ul><p>As I was implementing multimethods, I needed a few more core functions, so those were all implemented as well:<ul><li><code>hash-set</code><li><code>disj</code><li><code>defmulti</code><li><code>alter-var-root</code><li><code>bound?</code><li><code>thread-bound?</code></ul><p>Notably, this includes <code>bound?</code>, which required me to actually create a dedicated unbound var object so I could distinguish between unbound vars and vars holding <code>nil</code>.<h2>Clang/LLVM 19</h2><p>Most of my time this past month was not spent developing new features for jank, which is why I only have multimethods and 13 new functions to report. Instead, my time was spent trying to get jank ported over to the latest Clang/LLVM version, which will allow us to leave Cling behind. jank uses these for JIT compiling C++ code and upgrading to the upstream Clang will unlock huge performance wins, make compiling jank easier, and will allow for jank to follow the bleeding edge of the native JIT space. However, before we get there, we have a couple of bugs to get past.<h3>Extern templates</h3><p>The <a href="https://github.com/llvm/llvm-project/issues/97137">first bug</a>, which was causing JIT linking issues, I reduced down to a simple test case involving an extern template which is linked either in the current process or in a loaded shared library. Clang will be unable to resolve the address of the definition of that function. As it happens, the fmt library uses this pattern to provide some optimized versions of certain templates. However, we can fortunately work around this, since fmt wraps those definitions in a <code>FMT_HEADER_ONLY</code> preprocessor flag. The relevant fmt source is <a href="https://github.com/fmtlib/fmt/blob/b61c8c3d23b7e6fdf9d44593877dba1c8a291be1/include/fmt/format.h#L4283">here</a>.<p>The process of narrowing this down from the entire jank runtime is cumbersome, ruling out chunks of code at a time while still trying to keep things compiling and correct.<h3>Optimization crash</h3><p>This is the <a href="https://github.com/llvm/llvm-project/issues/95581">blocking bug</a> preventing jank from switching to Clang. It only happens in release builds, which also makes it harder to debug. This month, I traced the bug down from a crash in jank all the way to a minimal test case involving assignments with an implicit constructor. However, when testing whether or not the bug existed in Clang 18, I found that it indeed did not. This meant that it's since been introduced in the yet unreleased Clang 19. So I bisected around 1300 commits, each time requiring a fresh Clang/LLVM compilation and taking ~30m. It was an entire day of all 32 cores on my machine being busy compiling, but fortunately I could script all of the hard work just using some bash. Bisecting allowed me to find the commit which introduced the issue. This has yet to be fixed and I don't have the expertise to know what's wrong with that commit, but I've provided a test case, pinged the relevant people, and now I'm hoping the real experts can come in for the save.<h3>Clang status</h3><p>Aside form those two issues, only one of them being a blocker, the port to Clang is ready. In debug builds (which avoid the second bug), jank can pass its full test suite using Clang 19. Even better, some early benchmarking has shown that Clang 19 is <strong>more than twice as fast</strong> as Cling when it comes to JIT compiling large amounts of generated C++ code (such as all of <code>clojure.core</code>). That will mean faster startup times and shorter REPL iteration loops.<h2>Community progress: characters</h2><p>This month, <a href="https://github.com/Samy-33">Saket Patel</a> has been working on adding character support to jank. This involves support for tokens such as <code>\a</code>, <code>\space</code>, and Unicode characters like <code>\u2764</code>. He has <a href="https://github.com/jank-lang/jank/pull/78">a PR open</a> for initial character support, which is still in review. It should be merged soon.<p>Aside from regexes and ratios, characters are the only remaining syntax objects which have not yet been implemented in jank!<h2>What's next?</h2><p>Implementing multimethods identified a couple of issues related to certain sequence types in jank which I'm still investigating. Once those are sorted, I'll continue working through the requirements to implement <code>clojure.test</code>, which is why I was implementing multimethods in the first place. From there, I can start testing my jank code using more jank code and the dogfooding cycle can really begin. Stay tuned, folks!<h2>Would you like to join in?</h2><ol><li>Join the community on <a href="https://clojurians.slack.com/archives/C03SRH97FDK">Slack</a><li>Join the design discussions or pick up a ticket on <a href="https://github.com/jank-lang/jank">GitHub</a><li>Considering becoming a <a href="https://github.com/sponsors/jeaye">Sponsor</a> <span class="icon"style="color:#c96198"><i class="gg-heart"></i></span><li><strong>Hire me full-time to work on jank!</strong></ol></div></div></section></div><footer class="footer"><div class="container"><div class="columns has-text-centered"></div><div class="container has-text-centered"><div class="content is-small"><p>© 2024 Jeaye Wilkerson | All rights reserved.</div></div></div></footer><noscript><p><img src="//matomo.jeaye.com/matomo.php?idsite=1&amp;rec=1"style="border:0"alt=""></p></noscript><script>for(var coll=document.getElementsByClassName("collapsible"),i=0;i<coll.length;i++)coll[i].addEventListener("click",function(){this.classList.toggle("active");var l=this.nextElementSibling;"block"===l.style.display?l.style.display="none":l.style.display="block"})</script>