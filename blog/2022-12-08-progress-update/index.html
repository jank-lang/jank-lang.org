<!DOCTYPE html>
<html><meta charset="utf-8"><meta content="width=device-width, initial-scale=1" name="viewport"><link href="/img/favicon.svg" rel="icon" type="image/svg+xml"><link href="/css/main.css" rel="stylesheet"><link href="https://css.gg/css?=home|sync|bulb|list|link|git-fork|info|slack|math-minus|check-o|heart|twitter|comment" rel="stylesheet"><title>jank: Development update - lots of new changes</title><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa" rel="stylesheet"> <!-- Matomo -->
    <script>
    var _paq = window._paq = window._paq || [];
    _paq.push(['trackPageView']);
    _paq.push(['enableLinkTracking']);
    (function() {
                 var u="//matomo.jeaye.com/";
                 _paq.push(['setTrackerUrl', u+'matomo.php']);
                 _paq.push(['setSiteId', '1']);
                 var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
                 g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
                 })();
    </script>
    <!-- End Matomo Code --><body><div><div><nav class="navbar is-primary"><div class="container"><div class="navbar-brand"><a class="navbar-item title has-text-black" href="/blog" style="font-family:Comfortaa;">jank blog</a></div><div class="navbar-menu is-active"><div class="navbar-end has-text-weight-semibold"><a class="navbar-item has-text-black" href="/"><span class="icon mr-1"><i class="gg-home"></i></span><strong>Home</strong></a><a class="navbar-item has-text-black" href="/blog"><span class="icon mr-1"><i class="gg-comment"></i></span><strong>Blog</strong></a><a class="navbar-item has-text-black" href="https://github.com/sponsors/jeaye"><span class="icon mr-1" style="color: rgb(201, 97, 152);"><i class="gg-heart"></i></span><strong>Sponsor</strong></a><a class="navbar-item has-text-black" href="https://github.com/jank-lang/jank"><span class="icon mr-1"><i class="gg-git-fork"></i></span><strong>Github</strong></a><a class="navbar-item has-text-black" href="https://clojurians.slack.com/archives/C03SRH97FDK"><span class="icon mr-1"><i class="gg-slack"></i></span>Slack</a><a class="navbar-item has-text-black" href="https://twitter.com/jeayewilkerson"><span class="icon mr-1"><i class="gg-twitter"></i></span>Twitter</a></div></div></div></nav></div><section class="section"><div class="container blog-container"><span class="is-size-1">Development update - lots of new changes</span><div class="is-size-6 has-text-weight-light">December 8, 2022 · <a class="has-text-weight-normal" href="https://github.com/jeaye">Jeaye Wilkerson</a></div><hr><div class="content"><p>I was previously giving updates only in the <a href="https://clojurians.slack.com/archives/C03SRH97FDK">#jank</a> Slack channel, but some of these are getting large enough to warrant more prose. Thus, happily, I can announce that jank has a new blog and I have a <i>lot</i> of new progress to report! Let's get into the details.</p><p>Over the past couple of months, jank has gained initial C++ interop, an upgrade of Cling to resolve Linux crashes, support for multiple fn arities, including variadic arities, support for <code>if</code> and <code>let*</code>, which involved a rework of the C++ codegen, and initial metadata support, among many smaller changes.</p><h2>Initial C++ interop</h2><p>When digging deep enough into <code>clojure.core</code> implementations, most things eventually just turn into Java. Crucial fns like <code>println</code>, for example, rely on Java streams, as well as direct interop. Something like <code>str</code>, as well, reaches right for <code>StringBuilder</code>. So jank needs a way to call into C++ to get the important things done.</p><p>C++ is syntactically and semantically more complicated than Java. Its reflection story is poorer and is made worse by <code>template</code> usage, which requires a C++ compiler to generate the necessary instantiations ahead of time. With all of this in mind, I figured jank's interop is not going to look like Clojure JVM's, or ClojureScript's. I did dive into what <a href="https://ferret-lang.org/#outline-container-sec-4">Ferret</a> and <a href="https://github.com/carp-lang/Carp/blob/master/docs/CInterop.md">Carp</a> are doing for this and came up with some <a href="https://github.com/jank-lang/jank/blob/main/DESIGN.md#interop">design notes</a> that may be of interest. The notes cover both approaches, some pros/cons, and the rationale for jank's approach.</p><p>In short, jank is introducing a special <code>native/raw</code> form which accepts inline C++ code. Within that code can be interpolated jank code, escaped using the <code>#{}</code> form.</p><h3>Example</h3><pre class="shiki" style="background-color: #272822"><code><span class="line"><span style="color: #88846F">; No macros yet, so no defn or fn.</span></span>
<span class="line"><span style="color: #F8F8F2">(</span><span style="color: #F92672">def</span><span style="color: #F8F8F2"> str</span></span>
<span class="line"><span style="color: #F8F8F2">  (</span><span style="color: #A6E22E">fn*</span></span>
<span class="line"><span style="color: #F8F8F2">    ([]</span></span>
<span class="line"><span style="color: #F8F8F2">     </span><span style="color: #E6DB74">&quot;&quot;</span><span style="color: #F8F8F2">)</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #88846F">; Unary case uses interop and interpolation to call</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #88846F">; the to_string fn on the object.</span></span>
<span class="line"><span style="color: #F8F8F2">    ([o]</span></span>
<span class="line"><span style="color: #F8F8F2">     (</span><span style="color: #A6E22E">native/raw</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">&quot;__value = make_box(#{ o }-&gt;to_string());&quot;</span><span style="color: #F8F8F2">))</span></span>
<span class="line"><span style="color: #F8F8F2">    </span><span style="color: #88846F">; Variadic case could recurse, but it just iterates instead.</span></span>
<span class="line"><span style="color: #F8F8F2">    ([o &amp; args]</span></span>
<span class="line"><span style="color: #F8F8F2">     (</span><span style="color: #A6E22E">native/raw</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">&quot;std::string ret(#{ o }-&gt;to_string().data);</span></span>
<span class="line"><span style="color: #E6DB74">                  auto const * const l(#{ args }-&gt;as_list());</span></span>
<span class="line"><span style="color: #E6DB74">                  for(auto const &amp;elem : l-&gt;data)</span></span>
<span class="line"><span style="color: #E6DB74">                  { ret += elem-&gt;to_string().data; }</span></span>
<span class="line"><span style="color: #E6DB74">                  __value = make_box(ret);&quot;</span><span style="color: #F8F8F2">))))</span></span>
<span class="line"></span>
<span class="line"><span style="color: #F8F8F2">(</span><span style="color: #A6E22E">assert</span><span style="color: #F8F8F2"> (</span><span style="color: #A6E22E">=</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">&quot;&quot;</span><span style="color: #F8F8F2"> (</span><span style="color: #A6E22E">str</span><span style="color: #F8F8F2">)))</span></span>
<span class="line"><span style="color: #F8F8F2">(</span><span style="color: #A6E22E">assert</span><span style="color: #F8F8F2"> (</span><span style="color: #A6E22E">=</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">&quot;1&quot;</span><span style="color: #F8F8F2"> (</span><span style="color: #A6E22E">str</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)))</span></span>
<span class="line"><span style="color: #F8F8F2">(</span><span style="color: #A6E22E">assert</span><span style="color: #F8F8F2"> (</span><span style="color: #A6E22E">=</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">&quot;12&quot;</span><span style="color: #F8F8F2"> (</span><span style="color: #A6E22E">str</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">1</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">2</span><span style="color: #F8F8F2">)))</span></span>
<span class="line"><span style="color: #F8F8F2">(</span><span style="color: #A6E22E">assert</span><span style="color: #F8F8F2"> (</span><span style="color: #A6E22E">=</span><span style="color: #F8F8F2"> </span><span style="color: #E6DB74">&quot;:foo:bar[2 3]&quot;</span><span style="color: #F8F8F2"> (</span><span style="color: #A6E22E">str</span><span style="color: #F8F8F2"> :foo :bar [</span><span style="color: #AE81FF">2</span><span style="color: #F8F8F2"> </span><span style="color: #AE81FF">3</span><span style="color: #F8F8F2">])))</span></span></code></pre><p>This is clearly a low-level primitive for interop and I'm interested to see how we can build on it. For now, it unlocks all the bits</p><h2>Cling upgrade to 0.9</h2><p>A crash on Linux was requiring jank to use Cling 0.7, which meant using Clang/LLVM 5. After dozens of hours of compiling Cling/Clang/LLVM different ways, to troubleshoot, I found the issue! Now jank's build system has been updated to build Cling 0.9 for both macOS and Linux.</p><p>What came out of this, as well, is that jank can now use a pre-compiled header (PCH) for improving Cling startup times. That PCH is packaged with jank. <strong>This changed dropped the Cling startup time from 1.4 seconds to 265 milliseconds!</strong> More similar improvements to come.</p><h2>Support for if/let*</h2><p>For a while, jank's codegen (to C++) was benefiting from the fact that Clojure is such an expression-based language. Code such as:</p><pre class="shiki" style="background-color: #272822"><code><span class="line"><span style="color: #F8F8F2">(</span><span style="color: #A6E22E">println</span><span style="color: #F8F8F2"> (</span><span style="color: #A6E22E">foo</span><span style="color: #F8F8F2"> (</span><span style="color: #A6E22E">bar</span><span style="color: #F8F8F2">)))</span></span></code></pre><p>Could be generated as something like:</p><pre class="shiki" style="background-color: #272822"><code><span class="line"><span style="color: #F8F8F2">println-&gt;</span><span style="color: #A6E22E">call</span><span style="color: #F8F8F2">(foo-&gt;</span><span style="color: #A6E22E">call</span><span style="color: #F8F8F2">(bar-&gt;</span><span style="color: #A6E22E">call</span><span style="color: #F8F8F2">()));</span></span></code></pre><p>But that breaks altogether with something like:</p><pre class="shiki" style="background-color: #272822"><code><span class="line"><span style="color: #F8F8F2">(</span><span style="color: #A6E22E">println</span><span style="color: #F8F8F2"> (</span><span style="color: #F92672">if</span><span style="color: #F8F8F2"> (</span><span style="color: #A6E22E">even?</span><span style="color: #F8F8F2"> n)</span></span>
<span class="line"><span style="color: #F8F8F2">           :foo</span></span>
<span class="line"><span style="color: #F8F8F2">           :bar))</span></span></code></pre><p>To address this, I've completely switched the codegen approach to be entirely statement based. Every sub-expression is now pulled up into a statement with a temporary and then each outer expression just refers to those symbols. So, the corresponding C++ for the above Clojure would look something like:</p><pre class="shiki" style="background-color: #272822"><code><span class="line"><span style="color: #88846F">// This is cleaned up a bit, to make it easier</span></span>
<span class="line"><span style="color: #88846F">// to read, but the shape of the code is the same.</span></span>
<span class="line"><span style="color: #F8F8F2">object_ptr if_result;</span></span>
<span class="line"><span style="color: #F8F8F2">object_ptr even_result{ even_QMARK-&gt;</span><span style="color: #A6E22E">call</span><span style="color: #F8F8F2">(n) };</span></span>
<span class="line"><span style="color: #F92672">if</span><span style="color: #F8F8F2">(</span><span style="color: #A6E22E">jank</span><span style="color: #F8F8F2">::</span><span style="color: #A6E22E">runtime</span><span style="color: #F8F8F2">::</span><span style="color: #A6E22E">detail</span><span style="color: #F8F8F2">::</span><span style="color: #A6E22E">truthy</span><span style="color: #F8F8F2">(even_result))</span></span>
<span class="line"><span style="color: #F8F8F2">{ if_result </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> kw_foo; }</span></span>
<span class="line"><span style="color: #F92672">else</span></span>
<span class="line"><span style="color: #F8F8F2">{ if_result </span><span style="color: #F92672">=</span><span style="color: #F8F8F2"> kw_bar; }</span></span>
<span class="line"><span style="color: #F8F8F2">println-&gt;</span><span style="color: #A6E22E">call</span><span style="color: #F8F8F2">(if_result);</span></span></code></pre><p>I have more detailed <a href="https://github.com/jank-lang/jank/blob/main/DESIGN.md#codegen">design notes</a> on my approach, and Clojure's approach, in case you're interested.</p><h2>What's next</h2><p>I'm working on macros next, since that will help clean up a lot of the jank code I'm writing. After that, there are some more special forms which would really help, such as <code>loop</code>. Finally, extending the runtime behaviors to add analogous abstractions for functionality like <code>clojure.lang.Associative</code>, as well as better <code>clojure.lang.Seqable</code> support within jank itself would mean I can start implementing fns like <code>assoc</code>, <code>map</code>, <code>filter</code>, <code>reduce</code>, etc.</p><h2>How can others help?</h2><p>Glad you asked!</p><ol><li>Join the community on <a href="https://clojurians.slack.com/archives/C03SRH97FDK">Slack</a></li><li>Join the design discussions on <a href="https://github.com/jank-lang/jank/discussions">Github</a></li><li>Considering becoming a <a href="https://github.com/sponsors/jeaye">Sponsor</a></li></ol></div></div></section></div><footer class="footer"><div class="container"><div class="columns has-text-centered"><div class="column has-text-centered"><aside class="menu"><p class="menu-label">Resources</p><ul class="menu-list"><li><a href="https://clojurians.slack.com/archives/C03SRH97FDK">Slack</a></li><li><a href="https://github.com/jank-lang/jank">Github</a></li></ul></aside></div></div><div class="container has-text-centered"><div class="content is-small"><p>© 2022 Jeaye Wilkerson | All rights reserved.</p></div></div></div></footer></body><!-- Matomo noscript -->
    <noscript><p><img src="//matomo.jeaye.com/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt="" /></p></noscript>
    <!-- End matomo noscript --><!-- Collapsible tables -->
    <script>
    var coll = document.getElementsByClassName('collapsible');
    var i;

    for(i = 0; i < coll.length; i++) {
      coll[i].addEventListener('click', function() {
        this.classList.toggle('active');
        var content = this.nextElementSibling;
        if(content.style.display === 'block')
        { content.style.display = 'none'; }
        else
        { content.style.display = 'block'; }
      });
    }
    </script>
    <!-- End collapsible tables --></html>