<!DOCTYPE html><meta charset="utf-8"><meta content="width=device-width,initial-scale=1"name="viewport"><link href="/img/favicon.svg"rel="icon"type="image/svg+xml"><link href="/css/main.css"rel="stylesheet"><link href="/blog/feed.xml"rel="alternate"title="RSS Feed"type="application/atom+xml"><title>jank development update - Lots of new changes</title><meta content="jank development update - Lots of new changes"property="og:title"><meta content="A new development update for the jank programming language."property="og:description"><meta content="https://jank-lang.org/img/logo-text-dark.png"property="og:image"><link href="/img/favicon/apple-touch-icon.png"rel="apple-touch-icon"sizes="180x180"><link href="/img/favicon/32.png"rel="icon"sizes="32x32"type="image/png"><link href="/img/favicon/16.png"rel="icon"sizes="16x16"type="image/png"><style>.gg-bulb{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:16px;height:16px;border:2px solid;border-bottom-color:transparent;border-radius:100px}.gg-bulb::after,.gg-bulb::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-bulb::before{border-top:0;border-bottom-left-radius:18px;border-bottom-right-radius:18px;top:10px;border-bottom:2px solid transparent;box-shadow:0 5px 0 -2px,inset 2px 0 0 0,inset -2px 0 0 0,inset 0 -4px 0 -2px;width:8px;height:8px;left:2px}.gg-bulb::after{width:12px;height:2px;border-left:3px solid;border-right:3px solid;border-radius:2px;bottom:0;left:0}.gg-check-o{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:22px;height:22px;border:2px solid;border-radius:100px}.gg-check-o::after{content:"";display:block;box-sizing:border-box;position:absolute;left:3px;top:-1px;width:6px;height:10px;border-color:currentColor;border-width:0 2px 2px 0;border-style:solid;transform-origin:bottom left;transform:rotate(45deg)}.gg-comment{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:16px;border:2px solid;border-bottom:0;box-shadow:-6px 8px 0 -6px,6px 8px 0 -6px}.gg-comment::after,.gg-comment::before{content:"";display:block;box-sizing:border-box;position:absolute;width:8px}.gg-comment::before{border:2px solid;border-top-color:transparent;border-bottom-left-radius:20px;right:4px;bottom:-6px;height:6px}.gg-comment::after{height:2px;background:currentColor;box-shadow:0 4px 0 0;left:4px;top:4px}.gg-git-fork{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:2px;height:14px;background:currentColor}.gg-git-fork::after,.gg-git-fork::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-git-fork::before{border-right:2px solid;border-bottom:2px solid;border-bottom-right-radius:4px;bottom:4px;width:8px;height:6px;left:0}.gg-git-fork::after{width:4px;height:4px;background:currentColor;box-shadow:0 12px 0 0,6px 2px 0 0;border-radius:100%;left:-1px;top:-1px}.gg-heart,.gg-heart::after{border:2px solid;border-top-left-radius:100px;border-top-right-radius:100px;width:10px;height:8px;border-bottom:0}.gg-heart{box-sizing:border-box;position:relative;transform:translate(calc(-10px / 2 * var(--ggs,1)),calc(-6px / 2 * var(--ggs,1))) rotate(-45deg) scale(var(--ggs,1));display:block}.gg-heart::after,.gg-heart::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-heart::after{right:-9px;transform:rotate(90deg);top:5px}.gg-heart::before{width:11px;height:11px;border-left:2px solid;border-bottom:2px solid;left:-2px;top:3px}.gg-home{background:linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 0 bottom/4px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat right bottom/4px 2px;box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:18px;height:14px;border:2px solid;border-top:0;border-bottom:0;border-top-right-radius:3px;border-top-left-radius:3px;border-bottom-right-radius:0;border-bottom-left-radius:0;margin-bottom:-2px}.gg-home::after,.gg-home::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-home::before{border-top:2px solid;border-left:2px solid;border-top-left-radius:4px;transform:rotate(45deg);top:-5px;border-radius:3px;width:14px;height:14px;left:0}.gg-home::after{width:8px;height:10px;border:2px solid;border-radius:100px;border-bottom-left-radius:0;border-bottom-right-radius:0;border-bottom:0;left:3px;bottom:0}.gg-info{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:20px;border:2px solid;border-radius:40px}.gg-info::after,.gg-info::before{content:"";display:block;box-sizing:border-box;position:absolute;border-radius:3px;width:2px;background:currentColor;left:7px}.gg-info::after{bottom:2px;height:8px}.gg-info::before{height:2px;top:2px}.gg-link{box-sizing:border-box;position:relative;display:block;transform:rotate(-45deg) scale(var(--ggs,1));width:8px;height:2px;background:currentColor;border-radius:4px}.gg-link::after,.gg-link::before{content:"";display:block;box-sizing:border-box;position:absolute;border-radius:3px;width:8px;height:10px;border:2px solid;top:-4px}.gg-link::before{border-right:0;border-top-left-radius:40px;border-bottom-left-radius:40px;left:-6px}.gg-link::after{border-left:0;border-top-right-radius:40px;border-bottom-right-radius:40px;right:-6px}.gg-list{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:22px;height:20px;border:2px solid;border-radius:3px}.gg-list::after,.gg-list::before{content:"";display:block;box-sizing:border-box;position:absolute;width:2px;height:2px;background:currentColor;top:3px;left:3px;box-shadow:0 4px 0,0 8px 0}.gg-list::after{border-radius:3px;width:8px;left:7px}.gg-math-minus{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:16px;height:2px;background:currentColor;border-radius:10px}.gg-slack{position:relative;box-sizing:border-box;transform:scale(var(--ggs,1));display:block;width:20px;height:20px;background:linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 7px 2px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 15px 7px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 2px 10px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 10px 15px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 10px 2px/4px 5px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 5px 12px/4px 5px}.gg-slack::after,.gg-slack::before{background:currentColor;content:"";position:absolute;box-sizing:border-box;display:block;height:4px;border-radius:22px}.gg-slack::before{width:9px;top:5px;box-shadow:10px 5px 0}.gg-slack::after{width:4px;left:5px;box-shadow:-5px 10px 0,0 10px 0,0 15px 0,5px 15px 0,5px 5px 0,5px 0 0,10px 5px 0}.gg-sync{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));border-radius:40px;border:2px solid;margin:1px;border-left-color:transparent;border-right-color:transparent;width:18px;height:18px}.gg-sync::after,.gg-sync::before{content:"";display:block;box-sizing:border-box;position:absolute;width:0;height:0;border-top:4px solid transparent;border-bottom:4px solid transparent;transform:rotate(-45deg)}.gg-sync::before{border-left:6px solid;bottom:-1px;right:-3px}.gg-sync::after{border-right:6px solid;top:-1px;left:-3px}.gg-twitter{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:20px}.gg-twitter::after,.gg-twitter::before{content:"";display:block;position:absolute;box-sizing:border-box;left:4px}.gg-twitter::before{width:9px;height:14px;border-left:4px solid;border-bottom:4px solid;border-bottom-left-radius:6px;background:linear-gradient(to left,currentColor 12px,transparent 0) no-repeat center 2px/10px 4px;top:4px}.gg-twitter::after{width:4px;height:4px;background:currentColor;border-radius:20px;top:2px;box-shadow:7px 4px 0,7px 12px 0}</style><link rel="preconnect"href="https://fonts.googleapis.com"><link rel="preconnect"href="https://fonts.gstatic.com"crossorigin><link href="https://fonts.googleapis.com/css2?family=Comfortaa"rel="stylesheet"><script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){var e="//matomo.jeaye.com/",a=(_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]),document),t=a.createElement("script"),a=a.getElementsByTagName("script")[0];t.async=!0,t.src=e+"matomo.js",a.parentNode.insertBefore(t,a)}()</script><div><div><nav class="navbar is-primary"><div class="container"><div class="navbar-brand"><a class="navbar-item title has-text-white"href="/blog"style="font-family:Comfortaa"><img src="/img/logo-transparent.png"style="margin-right:15px">jank blog</a></div><div class="navbar-menu is-active"><div class="navbar-end has-text-weight-semibold"><a class="navbar-item has-text-white"href="/"><span class="icon mr-1"><i class="gg-home"></i></span><strong>Home</strong></a><a class="navbar-item has-text-white"href="/blog"><span class="icon mr-1"><i class="gg-comment"></i></span><strong>Blog</strong></a><a class="navbar-item has-text-white"href="https://github.com/sponsors/jeaye"><span class="icon mr-1"style="color:#c96198"><i class="gg-heart"></i></span><strong>Sponsor</strong></a><a class="navbar-item has-text-white"href="https://github.com/jank-lang/jank"><span class="icon mr-1"><i class="gg-git-fork"></i></span><strong>Github</strong></a><a class="navbar-item has-text-white"href="https://clojurians.slack.com/archives/C03SRH97FDK"><span class="icon mr-1"><i class="gg-slack"></i></span>Slack</a><a class="navbar-item has-text-white"href="https://twitter.com/jeayewilkerson"><span class="icon mr-1"><i class="gg-twitter"></i></span>Twitter</a></div></div></div></nav></div><section class="section"><div class="container blog-container"><span class="is-size-1">jank development update - Lots of new changes</span><div class="is-size-6 has-text-weight-light">Dec 08, 2022 · <a class="has-text-weight-normal"href="https://github.com/jeaye">Jeaye Wilkerson</a></div><hr><div class="content"><p>I was previously giving updates only in the <a href="https://clojurians.slack.com/archives/C03SRH97FDK">#jank</a> Slack channel, but some of these are getting large enough to warrant more prose. Thus, happily, I can announce that jank has a new blog and I have a <i>lot</i> of new progress to report! Let's get into the details.<p>Over the past couple of months, jank has gained initial C++ interop, an upgrade of Cling to resolve Linux crashes, support for multiple fn arities, including variadic arities, support for <code>if</code> and <code>let*</code>, which involved a rework of the C++ codegen, and initial metadata support, and many smaller changes.<p>Before I get into the details, I'd like to point out that <strong>feedback is welcome on all of this</strong>. Very little of jank's design is set in stone right now, so that means your feedback can matter a lot.<h2>Initial C++ interop</h2><p>When digging deep enough into <code>clojure.core</code> implementations, most things eventually just turn into Java. Crucial fns like <code>println</code>, for example, rely on Java streams, as well as direct interop. Something like <code>str</code>, as well, reaches right for <code>StringBuilder</code>. So jank needs a way to call into C++ to get the important things done.<p>C++ is syntactically and semantically more complicated than Java. Its reflection story is poorer and is made worse by <code>template</code> usage, which requires a C++ compiler to generate the necessary instantiations ahead of time. With all of this in mind, I figured jank's interop is not going to look like Clojure JVM's, or ClojureScript's. I did dive into what <a href="https://ferret-lang.org/#outline-container-sec-4">Ferret</a> and <a href="https://github.com/carp-lang/Carp/blob/master/docs/CInterop.md">Carp</a> are doing for this and came up with some <a href="https://github.com/jank-lang/jank/blob/main/DESIGN.md#interop">design notes</a> that may be of interest. The notes cover both approaches, some pros/cons, and the rationale for jank's approach.<p>In short, jank is introducing a special <code>native/raw</code> form which accepts inline C++ code. Within that code can be interpolated jank code, escaped using the <code>#{}</code> form.<h3>Example</h3><pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#88846f">; No macros yet, so no defn or fn.</span></span>
<span class="line"><span style="color:#f8f8f2">(</span><span style="color:#f92672">def</span><span style="color:#f8f8f2"> str</span></span>
<span class="line"><span style="color:#f8f8f2">  (</span><span style="color:#a6e22e">fn*</span></span>
<span class="line"><span style="color:#f8f8f2">    ([]</span></span>
<span class="line"><span style="color:#e6db74">     &quot;&quot;</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#88846f">    ; Unary case uses interop and interpolation to call</span></span>
<span class="line"><span style="color:#88846f">    ; the to_string fn on the object.</span></span>
<span class="line"><span style="color:#f8f8f2">    ([o]</span></span>
<span class="line"><span style="color:#f8f8f2">     (</span><span style="color:#a6e22e">native/raw</span><span style="color:#e6db74"> &quot;__value = make_box(#{ o }-&gt;to_string());&quot;</span><span style="color:#f8f8f2">))</span></span>
<span class="line"><span style="color:#88846f">    ; Variadic case could recurse, but we can iterate</span></span>
<span class="line"><span style="color:#88846f">    ; and avoid extra boxing of each intermediate.</span></span>
<span class="line"><span style="color:#f8f8f2">    ([o &amp; args]</span></span>
<span class="line"><span style="color:#f8f8f2">     (</span><span style="color:#a6e22e">native/raw</span><span style="color:#e6db74"> &quot;std::string ret(#{ o }-&gt;to_string().data);</span></span>
<span class="line"><span style="color:#e6db74">                  auto const * const l(#{ args }-&gt;as_list());</span></span>
<span class="line"><span style="color:#e6db74">                  for(auto const &amp;elem : l-&gt;data)</span></span>
<span class="line"><span style="color:#e6db74">                  { ret += elem-&gt;to_string().data; }</span></span>
<span class="line"><span style="color:#e6db74">                  __value = make_box(ret);&quot;</span><span style="color:#f8f8f2">))))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">assert</span><span style="color:#f8f8f2"> (</span><span style="color:#a6e22e">=</span><span style="color:#e6db74"> &quot;&quot;</span><span style="color:#f8f8f2"> (</span><span style="color:#a6e22e">str</span><span style="color:#f8f8f2">)))</span></span>
<span class="line"><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">assert</span><span style="color:#f8f8f2"> (</span><span style="color:#a6e22e">=</span><span style="color:#e6db74"> &quot;1&quot;</span><span style="color:#f8f8f2"> (</span><span style="color:#a6e22e">str</span><span style="color:#ae81ff"> 1</span><span style="color:#f8f8f2">)))</span></span>
<span class="line"><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">assert</span><span style="color:#f8f8f2"> (</span><span style="color:#a6e22e">=</span><span style="color:#e6db74"> &quot;12&quot;</span><span style="color:#f8f8f2"> (</span><span style="color:#a6e22e">str</span><span style="color:#ae81ff"> 1</span><span style="color:#ae81ff"> 2</span><span style="color:#f8f8f2">)))</span></span>
<span class="line"><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">assert</span><span style="color:#f8f8f2"> (</span><span style="color:#a6e22e">=</span><span style="color:#e6db74"> &quot;:foo:bar[2 3]&quot;</span><span style="color:#f8f8f2"> (</span><span style="color:#a6e22e">str</span><span style="color:#f8f8f2"> :foo :bar [</span><span style="color:#ae81ff">2</span><span style="color:#ae81ff"> 3</span><span style="color:#f8f8f2">])))</span></span></code></pre><p>This is clearly a low-level primitive for interop and I'm interested to see how we can build on it. For now, it unlocks all the bits<h2>Cling upgrade to 0.9</h2><p>A crash on Linux was requiring jank to use Cling 0.7, which meant using Clang/LLVM 5. After dozens of hours of compiling Cling/Clang/LLVM different ways, to troubleshoot, I found the <a href="https://github.com/root-project/cling/issues/470">issue</a>! Now jank's build system has been updated to build Cling 0.9 for both macOS and Linux.<p>What came out of this, as well, is that jank can now use a pre-compiled header (PCH) for improving Cling startup times. That PCH is packaged with jank. <strong>This changed dropped the Cling startup time from 1.4 seconds to 265 milliseconds!</strong> More similar improvements to come.<h2>Support for if/let*</h2><p>For a while, jank's codegen (to C++) was benefiting from the fact that Clojure is such an expression-based language. Code such as:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">println</span><span style="color:#f8f8f2"> (</span><span style="color:#a6e22e">foo</span><span style="color:#f8f8f2"> (</span><span style="color:#a6e22e">bar</span><span style="color:#f8f8f2">)))</span></span></code></pre><p>Could be generated as something like:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">println-&gt;</span><span style="color:#a6e22e">call</span><span style="color:#f8f8f2">(foo-&gt;</span><span style="color:#a6e22e">call</span><span style="color:#f8f8f2">(bar-&gt;</span><span style="color:#a6e22e">call</span><span style="color:#f8f8f2">()));</span></span></code></pre><p>But that breaks altogether with something like:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">(</span><span style="color:#a6e22e">println</span><span style="color:#f8f8f2"> (</span><span style="color:#f92672">if</span><span style="color:#f8f8f2"> (</span><span style="color:#a6e22e">even?</span><span style="color:#f8f8f2"> n)</span></span>
<span class="line"><span style="color:#f8f8f2">           :foo</span></span>
<span class="line"><span style="color:#f8f8f2">           :bar))</span></span></code></pre><p>To address this, I've completely switched the codegen approach to be entirely statement based. Every sub-expression is now pulled up into a statement with a temporary and then each outer expression just refers to those symbols. So, the corresponding C++ for the above Clojure would look something like:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#88846f">// This is cleaned up a bit, to make it easier</span></span>
<span class="line"><span style="color:#88846f">// to read, but the shape of the code is the same.</span></span>
<span class="line"><span style="color:#f8f8f2">object_ptr if_result;</span></span>
<span class="line"><span style="color:#f8f8f2">object_ptr even_result{ even_QMARK-&gt;</span><span style="color:#a6e22e">call</span><span style="color:#f8f8f2">(n) };</span></span>
<span class="line"><span style="color:#f92672">if</span><span style="color:#f8f8f2">(</span><span style="color:#a6e22e;text-decoration:underline">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e;text-decoration:underline">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e;text-decoration:underline">detail</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">truthy</span><span style="color:#f8f8f2">(even_result))</span></span>
<span class="line"><span style="color:#f8f8f2">{ if_result </span><span style="color:#f92672">=</span><span style="color:#f8f8f2"> kw_foo; }</span></span>
<span class="line"><span style="color:#f92672">else</span></span>
<span class="line"><span style="color:#f8f8f2">{ if_result </span><span style="color:#f92672">=</span><span style="color:#f8f8f2"> kw_bar; }</span></span>
<span class="line"><span style="color:#f8f8f2">println-&gt;</span><span style="color:#a6e22e">call</span><span style="color:#f8f8f2">(if_result);</span></span></code></pre><p>The way this manifests in the compiler is really clean, since every jank expression resolves to a single C++ symbol, which is its temporary. Could be a <code>let*</code>, <code>if</code>, fn call, or anything else, but it's all boiled down to a symbol for that value. I have more detailed <a href="https://github.com/jank-lang/jank/blob/main/DESIGN.md#codegen">design notes</a> on my approach, and Clojure's approach, in case you're interested.<h2>What's next</h2><p>I'm working on macros next, since that will help clean up a lot of the jank code I'm writing. After that, there are some more special forms which would really help, such as <code>loop</code>. Finally, extending the runtime behaviors to add analogous abstractions for functionality like <code>clojure.lang.Associative</code>, as well as better <code>clojure.lang.Seqable</code> support within jank itself would mean I can start implementing fns like <code>assoc</code>, <code>map</code>, <code>filter</code>, <code>reduce</code>, etc.<h2>Would you like to join in?</h2><ol><li>Join the community on <a href="https://clojurians.slack.com/archives/C03SRH97FDK">Slack</a><li>Join the design discussions on <a href="https://github.com/jank-lang/jank/discussions">Github</a><li>Considering becoming a <a href="https://github.com/sponsors/jeaye">Sponsor</a></ol></div></div></section></div><footer class="footer"><div class="container"><div class="columns has-text-centered"></div><div class="container has-text-centered"><div class="content is-small"><p>© 2024 Jeaye Wilkerson | All rights reserved.</div></div></div></footer><noscript><p><img src="//matomo.jeaye.com/matomo.php?idsite=1&amp;rec=1"style="border:0"alt=""></p></noscript><script>for(var coll=document.getElementsByClassName("collapsible"),i=0;i<coll.length;i++)coll[i].addEventListener("click",function(){this.classList.toggle("active");var l=this.nextElementSibling;"block"===l.style.display?l.style.display="none":l.style.display="block"})</script>