<!DOCTYPE html><meta charset="utf-8"><meta content="width=device-width,initial-scale=1"name="viewport"><link href="/css/main.css"rel="stylesheet"><link href="/blog/feed.xml"rel="alternate"title="RSS Feed"type="application/atom+xml"><title>jank development update - Optimizing a ray tracer</title><meta content="jank development update - Optimizing a ray tracer"property="og:title"><meta content="A deep dive into the internals of Clojure and jank to optimize a ray tracer."property="og:description"><meta content="https://jank-lang.org/img/2023-04-07-big.png"property="og:image"><link href="/img/favicon/apple-touch-icon.png"rel="apple-touch-icon"sizes="180x180"><link href="/img/favicon/32.png"rel="icon"sizes="32x32"type="image/png"><link href="/img/favicon/16.png"rel="icon"sizes="16x16"type="image/png"><link href="/img/favicon/site.webmanifest"rel="manifest"><style>.gg-bulb{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:16px;height:16px;border:2px solid;border-bottom-color:transparent;border-radius:100px}.gg-bulb::after,.gg-bulb::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-bulb::before{border-top:0;border-bottom-left-radius:18px;border-bottom-right-radius:18px;top:10px;border-bottom:2px solid transparent;box-shadow:0 5px 0 -2px,inset 2px 0 0 0,inset -2px 0 0 0,inset 0 -4px 0 -2px;width:8px;height:8px;left:2px}.gg-bulb::after{width:12px;height:2px;border-left:3px solid;border-right:3px solid;border-radius:2px;bottom:0;left:0}.gg-check-o{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:22px;height:22px;border:2px solid;border-radius:100px}.gg-check-o::after{content:"";display:block;box-sizing:border-box;position:absolute;left:3px;top:-1px;width:6px;height:10px;border-color:currentColor;border-width:0 2px 2px 0;border-style:solid;transform-origin:bottom left;transform:rotate(45deg)}.gg-comment{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:16px;border:2px solid;border-bottom:0;box-shadow:-6px 8px 0 -6px,6px 8px 0 -6px}.gg-comment::after,.gg-comment::before{content:"";display:block;box-sizing:border-box;position:absolute;width:8px}.gg-comment::before{border:2px solid;border-top-color:transparent;border-bottom-left-radius:20px;right:4px;bottom:-6px;height:6px}.gg-comment::after{height:2px;background:currentColor;box-shadow:0 4px 0 0;left:4px;top:4px}.gg-git-fork{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:2px;height:14px;background:currentColor}.gg-git-fork::after,.gg-git-fork::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-git-fork::before{border-right:2px solid;border-bottom:2px solid;border-bottom-right-radius:4px;bottom:4px;width:8px;height:6px;left:0}.gg-git-fork::after{width:4px;height:4px;background:currentColor;box-shadow:0 12px 0 0,6px 2px 0 0;border-radius:100%;left:-1px;top:-1px}.gg-heart,.gg-heart::after{border:2px solid;border-top-left-radius:100px;border-top-right-radius:100px;width:10px;height:8px;border-bottom:0}.gg-heart{box-sizing:border-box;position:relative;transform:translate(calc(-10px / 2 * var(--ggs,1)),calc(-6px / 2 * var(--ggs,1))) rotate(-45deg) scale(var(--ggs,1));display:block}.gg-heart::after,.gg-heart::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-heart::after{right:-9px;transform:rotate(90deg);top:5px}.gg-heart::before{width:11px;height:11px;border-left:2px solid;border-bottom:2px solid;left:-2px;top:3px}.gg-home{background:linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 0 bottom/4px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat right bottom/4px 2px;box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:18px;height:14px;border:2px solid;border-top:0;border-bottom:0;border-top-right-radius:3px;border-top-left-radius:3px;border-bottom-right-radius:0;border-bottom-left-radius:0;margin-bottom:-2px}.gg-home::after,.gg-home::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-home::before{border-top:2px solid;border-left:2px solid;border-top-left-radius:4px;transform:rotate(45deg);top:-5px;border-radius:3px;width:14px;height:14px;left:0}.gg-home::after{width:8px;height:10px;border:2px solid;border-radius:100px;border-bottom-left-radius:0;border-bottom-right-radius:0;border-bottom:0;left:3px;bottom:0}.gg-info{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:20px;border:2px solid;border-radius:40px}.gg-info::after,.gg-info::before{content:"";display:block;box-sizing:border-box;position:absolute;border-radius:3px;width:2px;background:currentColor;left:7px}.gg-info::after{bottom:2px;height:8px}.gg-info::before{height:2px;top:2px}.gg-link{box-sizing:border-box;position:relative;display:block;transform:rotate(-45deg) scale(var(--ggs,1));width:8px;height:2px;background:currentColor;border-radius:4px}.gg-link::after,.gg-link::before{content:"";display:block;box-sizing:border-box;position:absolute;border-radius:3px;width:8px;height:10px;border:2px solid;top:-4px}.gg-link::before{border-right:0;border-top-left-radius:40px;border-bottom-left-radius:40px;left:-6px}.gg-link::after{border-left:0;border-top-right-radius:40px;border-bottom-right-radius:40px;right:-6px}.gg-list{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:22px;height:20px;border:2px solid;border-radius:3px}.gg-list::after,.gg-list::before{content:"";display:block;box-sizing:border-box;position:absolute;width:2px;height:2px;background:currentColor;top:3px;left:3px;box-shadow:0 4px 0,0 8px 0}.gg-list::after{border-radius:3px;width:8px;left:7px}.gg-math-minus{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:16px;height:2px;background:currentColor;border-radius:10px}.gg-slack{position:relative;box-sizing:border-box;transform:scale(var(--ggs,1));display:block;width:20px;height:20px;background:linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 7px 2px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 15px 7px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 2px 10px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 10px 15px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 10px 2px/4px 5px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 5px 12px/4px 5px}.gg-slack::after,.gg-slack::before{background:currentColor;content:"";position:absolute;box-sizing:border-box;display:block;height:4px;border-radius:22px}.gg-slack::before{width:9px;top:5px;box-shadow:10px 5px 0}.gg-slack::after{width:4px;left:5px;box-shadow:-5px 10px 0,0 10px 0,0 15px 0,5px 15px 0,5px 5px 0,5px 0 0,10px 5px 0}.gg-sync{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));border-radius:40px;border:2px solid;margin:1px;border-left-color:transparent;border-right-color:transparent;width:18px;height:18px}.gg-sync::after,.gg-sync::before{content:"";display:block;box-sizing:border-box;position:absolute;width:0;height:0;border-top:4px solid transparent;border-bottom:4px solid transparent;transform:rotate(-45deg)}.gg-sync::before{border-left:6px solid;bottom:-1px;right:-3px}.gg-sync::after{border-right:6px solid;top:-1px;left:-3px}.gg-twitter{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:20px}.gg-twitter::after,.gg-twitter::before{content:"";display:block;position:absolute;box-sizing:border-box;left:4px}.gg-twitter::before{width:9px;height:14px;border-left:4px solid;border-bottom:4px solid;border-bottom-left-radius:6px;background:linear-gradient(to left,currentColor 12px,transparent 0) no-repeat center 2px/10px 4px;top:4px}.gg-twitter::after{width:4px;height:4px;background:currentColor;border-radius:20px;top:2px;box-shadow:7px 4px 0,7px 12px 0}</style><script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),(()=>{var a="//matomo.jeaye.com/";_paq.push(["setTrackerUrl",a+"matomo.php"]),_paq.push(["setSiteId","1"]);var e=(p=document).createElement("script"),p=p.getElementsByTagName("script")[0];e.async=!0,e.src=a+"matomo.js",p.parentNode.insertBefore(e,p)})()</script><div><div><nav class="navbar is-primary"><div class="container"><div class="navbar-brand"><a class="navbar-item title has-text-white"href="/blog"style="font-family:Comfortaa"><img src="/img/logo-transparent.png"style="margin-right:15px">jank blog</a></div><div class="navbar-menu is-active"><div class="navbar-end has-text-weight-semibold"><a class="navbar-item has-text-white"href="/"><span class="icon mr-1"><i class="gg-home"></i></span><strong>Home</strong></a><a class="navbar-item has-text-white"href="/blog"><span class="icon mr-1"><i class="gg-comment"></i></span><strong>Blog</strong></a><a class="navbar-item has-text-white"href="https://github.com/sponsors/jeaye"><span class="icon mr-1"style="color:#c96198"><i class="gg-heart"></i></span><strong>Sponsor</strong></a><a class="navbar-item has-text-white"href="https://github.com/jank-lang/jank"><span class="icon mr-1"><i class="gg-git-fork"></i></span><strong>Github</strong></a><a class="navbar-item has-text-white"href="https://clojurians.slack.com/archives/C03SRH97FDK"><span class="icon mr-1"><i class="gg-slack"></i></span>Slack</a><a class="navbar-item has-text-white"href="https://twitter.com/jeayewilkerson"><span class="icon mr-1"><i class="gg-twitter"></i></span>Twitter</a></div></div></div></nav></div><section class="section"><div class="container blog-container"><span class="is-size-1">jank development update - Optimizing a ray tracer</span><div class="is-size-6 has-text-weight-light">Apr 07, 2023 Â· <a class="has-text-weight-normal"href="https://github.com/jeaye">Jeaye Wilkerson</a></div><hr><div class="content"><p>After the <a href="/blog/2023-01-13-optimizing-sequences">last post</a>, which focused on optimizing jank's sequences, I wanted to get jank running a ray tracer I had previously written in Clojure. In this post, I document what was required to start ray tracing in jank and, more importantly, how I chased down the run time in a fierce battle with Clojure's performance.<h2>Missing Clojure functions</h2><p>Coming out of the last blog post, there were quite a few functions which the ray tracer required that jank did not yet have. A lot of this was tedium, but there are some interesting points.<h3>Polymorphic arithmetic</h3><p>In Clojure JVM, since everything can be an object, and Clojure's dynamically typed, we can't know what something like <code>(+ a b)</code> actually does. For example, it's possible that either <code>a</code> or <code>b</code> is not a number, but it's also possible that they're an unboxed <code>long</code> or <code>double</code>, or a boxed <code>Long</code> or a <code>Double</code>, or maybe even a <code>BigInteger</code> or <code>Ratio</code>. Each of these will handle <code>+</code> slightly differently. Clojure (and now jank) handles this using a neat polymorphic design. In jank, it starts with this <code>number_ops</code> interface:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> number_ops</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#f8f8f2">  virtual number_ops const</span><span style="color:#fb4934;font-weight:700">&amp;</span><span style="color:#a6e22e"> combine</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">number_ops const</span><span style="color:#fb4934;font-weight:700">&amp;</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2"> const </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#f8f8f2">  virtual number_ops const</span><span style="color:#fb4934;font-weight:700">&amp;</span><span style="color:#a6e22e"> with</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">integer_ops const</span><span style="color:#fb4934;font-weight:700">&amp;</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2"> const </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#f8f8f2">  virtual number_ops const</span><span style="color:#fb4934;font-weight:700">&amp;</span><span style="color:#a6e22e"> with</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">real_ops const</span><span style="color:#fb4934;font-weight:700">&amp;</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2"> const </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">  virtual </span><span style="color:#a6e22e">object_ptr</span><span style="color:#a6e22e"> add</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2"> const </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#f8f8f2">  virtual </span><span style="color:#a6e22e">object_ptr</span><span style="color:#a6e22e"> subtract</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2"> const </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#f8f8f2">  virtual </span><span style="color:#a6e22e">object_ptr</span><span style="color:#a6e22e"> multiply</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2"> const </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#f8f8f2">  virtual </span><span style="color:#a6e22e">object_ptr</span><span style="color:#a6e22e"> divide</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2"> const </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#f8f8f2">  virtual </span><span style="color:#a6e22e">object_ptr</span><span style="color:#a6e22e"> remainder</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2"> const </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#f8f8f2">  virtual </span><span style="color:#a6e22e">object_ptr</span><span style="color:#a6e22e"> inc</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2"> const </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#f8f8f2">  virtual </span><span style="color:#a6e22e">object_ptr</span><span style="color:#a6e22e"> dec</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2"> const </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#88846f">  /* ... and so on ... */</span></span>
<span class="line"><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span></code></pre><p>jank then has different implementations of this interface, like <code>integer_ops</code> and <code>real_ops</code>. The trick here is to use the correct &quot;ops&quot; for the combination of left and right. By left and right, I mean, when looking at the expression <code>(+ a b)</code>, we see the left side, <code>a</code>, and the right side, <code>b</code>. So if they're both integers, we can use the <code>integer_ops</code>, which returns more integers. But if one is an integer and the other is a real, we need to return a real. You can see this in Clojure, since <code>(+ 1 2)</code> is <code>3</code>, but <code>(+ 1 2.0)</code> is <code>3.0</code>.<p>The way this comes together is something like this:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#a6e22e">object_ptr</span><span style="color:#a6e22e"> add</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">object_ptr</span><span style="color:#f8f8f2"> const </span><span style="color:#fd971f;font-style:italic">l</span><span style="color:#f8f8f2">, </span><span style="color:#a6e22e">object_ptr</span><span style="color:#f8f8f2"> const </span><span style="color:#fd971f;font-style:italic">r</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">{</span><span style="color:#fb4934;font-weight:700"> return</span><span style="color:#a6e22e"> with</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">left_ops</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">l</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">, </span><span style="color:#a6e22e">right_ops</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">r</span><span style="color:#fd971f">))</span><span style="color:#f8f8f2">.</span><span style="color:#a6e22e">add</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2">; </span><span style="color:#fd971f">}</span></span></code></pre><p>You can see the Clojure source for this <a href="https://github.com/clojure/clojure/blob/master/src/jvm/clojure/lang/Numbers.java">here</a> and the jank source for this <a href="https://github.com/jank-lang/jank/blob/main/src/cpp/jank/runtime/obj/number.cpp#L99">here</a>.<h2>Running the ray tracer</h2><p>This ray tracer is a partial port of the very fun <a href="https://raytracing.github.io/books/RayTracingInOneWeekend.html">Ray tracing in one weekend</a> project. It's not meant to be fast; it's a learning tool. However, it was a pure Clojure project I had lying around and seemed like a good next goal for jank. The scene is mostly random, but generally look like this:<p><figure width="50%"><img src="/img/2023-04-07-big.png"></figure><p><p>The source code for both the jank and the Clojure versions are in this <a href="https://gist.github.com/jeaye/77e1d8874c8e76e7335ccf71ef53785c">gist</a>. They vary only in the math functions used; each one uses its host interop for them. Note that this is not the most idiomatic Clojure; it was written to work with the limitations of a previous iteration of jank, then somewhat upgraded. jank still doesn't support some idiomatic things like using keywords as functions, so there are many calls to <code>get</code>.<p>After giving that code a tolerant scan, let's take a look at the initial numbers.<h3>First timing results</h3><p>I'm ray tracing a tiny image. It's only 10x6 pixels. However, in order to create this tiny image, we need to cast 265 rays. Here's the image:<p><figure><img src="/img/2023-04-07-small.png"></figure><p><p>Now, the initial timing for this (using <a href="https://github.com/martinus/nanobench">nanobench</a>) for jank is here:<table><thead><tr><th style="text-align:right">ms/op<th style="text-align:right">op/s<th style="text-align:right">err%<th style="text-align:right">ins/op<th style="text-align:right">bra/op<th style="text-align:right">miss%<th style="text-align:right">total<th style="text-align:left">benchmark<tbody><tr><td style="text-align:right">797.49<td style="text-align:right">1.25<td style="text-align:right">2.1%<td style="text-align:right">4,864,568,466.00<td style="text-align:right">873,372,774.00<td style="text-align:right">1.3%<td style="text-align:right">8.61<td style="text-align:left"><code>ray</code></table><p>Just shy of 800 milliseconds. It's less than a second, yes, but it's also a trivially tiny image. Let's see how Clojure does with the same code (using <a href="https://github.com/hugoduncan/criterium/">criterium</a>).<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#88846f">; (out) Evaluation count : 12 in 6 samples of 2 calls.</span></span>
<span class="line"><span style="color:#88846f">; (out)              Execution time mean : 69.441424 ms</span></span>
<span class="line"><span style="color:#88846f">; (out)     Execution time std-deviation : 8.195639 ms</span></span>
<span class="line"><span style="color:#88846f">; (out)    Execution time lower quantile : 63.812357 ms ( 2.5%)</span></span>
<span class="line"><span style="color:#88846f">; (out)    Execution time upper quantile : 83.135203 ms (97.5%)</span></span>
<span class="line"><span style="color:#88846f">; (out)                    Overhead used : 11.626368 ns</span></span></code></pre><p><strong>Yikes.</strong> Clojure only takes 69 ms. jank takes 11.6x as long as Clojure to render the same image. That's ok, though. We didn't want this to be easy.<h2>Profile, change, benchmark, repeat</h2><p>My general understanding of the ray tracer was that we would spend most of our time:<ul><li>Crunching numbers (using that polymorphic arithmetic I outlined above)<li>Creating maps (for rays, mainly)<li>Looking up data in maps (for rays, mainly)</ul><h3>Keywords with identity for equal and hash</h3><p>Going into this, I knew one thing I could tackle right out of the gate. Map lookups were just using equality checks, but keywords can be compared using identity (pointer value), since they're interned.<p>The changes: <a href="https://github.com/jank-lang/jank/commit/067e0ee400bffea010cf8bfad0e81a75134f7771">067e0ee400bffea010cf8bfad0e81a75134f7771</a><table><thead><tr><th style="text-align:right">ms/op<th style="text-align:right">op/s<th style="text-align:right">err%<th style="text-align:right">ins/op<th style="text-align:right">bra/op<th style="text-align:right">miss%<th style="text-align:right">total<th style="text-align:left">benchmark<tbody><tr><td style="text-align:right">559.31<td style="text-align:right">1.79<td style="text-align:right">2.2%<td style="text-align:right">3,317,176,052.00<td style="text-align:right">613,115,971.00<td style="text-align:right">1.7%<td style="text-align:right">6.10<td style="text-align:left"><code>ray</code></table><p>Very nice. We're coming out swinging. From 797.49 ms to 559.31 ms is a big win.<h4>Compare generated code</h4><p>After this, I didn't have other optimizations planned, so the next reasonable step was to just take a look at the generated code from both jank and Clojure and try to spot some differences. For decompiling Clojure code, I'll use the excellent <a href="https://github.com/clojure-goes-fast/clj-java-decompiler">clj-java-decompiler</a>.<p>Given the three expected time sinks I listed above, I chose a function which had map creation, map lookups, and arithmetic. Should be the exact sort of thing we need to optimize. Here's the function:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#fd971f">(</span><span style="color:#fb4934;font-weight:700">defn</span><span style="color:#f8f8f2"> vec3-scale </span><span style="color:#fd971f">[</span><span style="color:#f8f8f2">l n</span><span style="color:#fd971f">]</span></span>
<span class="line"><span style="color:#fd971f">  {</span><span style="color:#819aff">:r</span><span style="color:#fd971f"> (</span><span style="color:#a6e22e">*</span><span style="color:#fd971f"> (</span><span style="color:#a6e22e">get</span><span style="color:#f8f8f2"> l </span><span style="color:#819aff">:r</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2"> n</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#819aff">   :g</span><span style="color:#fd971f"> (</span><span style="color:#a6e22e">*</span><span style="color:#fd971f"> (</span><span style="color:#a6e22e">get</span><span style="color:#f8f8f2"> l </span><span style="color:#819aff">:g</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2"> n</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#819aff">   :b</span><span style="color:#fd971f"> (</span><span style="color:#a6e22e">*</span><span style="color:#fd971f"> (</span><span style="color:#a6e22e">get</span><span style="color:#f8f8f2"> l </span><span style="color:#819aff">:b</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2"> n</span><span style="color:#fd971f">)})</span></span></code></pre><p>Let's see the jank code for this first. I've annotated it for readability.<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#88846f">/* Our function was turned into a struct which implements</span></span>
<span class="line"><span style="color:#88846f">   some jank interfaces. */</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> vec3_scale579</span><span style="color:#f8f8f2"> : jank::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">object</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">                       jank::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">behavior</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">callable</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">                       jank::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">behavior</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">metadatable</span><span style="color:#fd971f"> {</span></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::context </span><span style="color:#fb4934;font-weight:700">&amp;</span><span style="color:#f8f8f2">__rt_ctx;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">  /* Vars referenced within the fn are lifted to members.</span></span>
<span class="line"><span style="color:#88846f">     In this case, * and get. */</span></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::var_ptr const _STAR_595;</span></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::var_ptr const get596;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">  /* Constants are lifted to members. */</span></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::object_ptr const const600;</span></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::object_ptr const const594;</span></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::object_ptr const const598;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">  /* Constructor which initializes all lifted vars and constants. */</span></span>
<span class="line"><span style="color:#a6e22e">  vec3_scale579</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">context</span><span style="color:#f8f8f2"> &amp;</span><span style="color:#fd971f;font-style:italic">__rt_ctx</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#f8f8f2">      : </span><span style="color:#a6e22e">__rt_ctx</span><span style="color:#fd971f">{</span><span style="color:#f8f8f2">__rt_ctx</span><span style="color:#fd971f">}</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#a6e22e">        _STAR_595</span><span style="color:#fd971f">{</span><span style="color:#f8f8f2">__rt_ctx.</span><span style="color:#a6e22e">intern_var</span><span style="color:#fd971f">(</span><span style="color:#e6db74">&quot;clojure.core&quot;</span><span style="color:#f8f8f2">, </span><span style="color:#e6db74">&quot;*&quot;</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">.</span><span style="color:#a6e22e">expect_ok</span><span style="color:#fd971f">()}</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#a6e22e">        get596</span><span style="color:#fd971f">{</span><span style="color:#f8f8f2">__rt_ctx.</span><span style="color:#a6e22e">intern_var</span><span style="color:#fd971f">(</span><span style="color:#e6db74">&quot;clojure.core&quot;</span><span style="color:#f8f8f2">, </span><span style="color:#e6db74">&quot;get&quot;</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">.</span><span style="color:#a6e22e">expect_ok</span><span style="color:#fd971f">()}</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#a6e22e">        const600</span><span style="color:#fd971f">{</span><span style="color:#f8f8f2">__rt_ctx.</span><span style="color:#a6e22e">intern_keyword</span><span style="color:#fd971f">(</span><span style="color:#e6db74">&quot;&quot;</span><span style="color:#f8f8f2">, </span><span style="color:#e6db74">&quot;b&quot;</span><span style="color:#f8f8f2">, </span><span style="color:#ae81ff">true</span><span style="color:#fd971f">)}</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#a6e22e">        const594</span><span style="color:#fd971f">{</span><span style="color:#f8f8f2">__rt_ctx.</span><span style="color:#a6e22e">intern_keyword</span><span style="color:#fd971f">(</span><span style="color:#e6db74">&quot;&quot;</span><span style="color:#f8f8f2">, </span><span style="color:#e6db74">&quot;r&quot;</span><span style="color:#f8f8f2">, </span><span style="color:#ae81ff">true</span><span style="color:#fd971f">)}</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#a6e22e">        const598</span><span style="color:#fd971f">{</span><span style="color:#f8f8f2">__rt_ctx.</span><span style="color:#a6e22e">intern_keyword</span><span style="color:#fd971f">(</span><span style="color:#e6db74">&quot;&quot;</span><span style="color:#f8f8f2">, </span><span style="color:#e6db74">&quot;g&quot;</span><span style="color:#f8f8f2">, </span><span style="color:#ae81ff">true</span><span style="color:#fd971f">)}</span></span>
<span class="line"><span style="color:#fd971f">  {</span><span style="color:#fd971f"> }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">  /* This is where the actual jank code we wrote runs. */</span></span>
<span class="line"><span style="color:#a6e22e">  jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::object_ptr call</span></span>
<span class="line"><span style="color:#fd971f">  (</span></span>
<span class="line"><span style="color:#a6e22e">    jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::object_ptr l,</span></span>
<span class="line"><span style="color:#a6e22e">    jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::object_ptr n</span></span>
<span class="line"><span style="color:#fd971f">  )</span><span style="color:#f8f8f2"> const override </span><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#88846f">    /* First we call (* (get l :r) n). We can see the calls to get and * here. */</span></span>
<span class="line"><span style="color:#f8f8f2">    object_ptr call607;</span></span>
<span class="line"><span style="color:#fd971f">    {</span></span>
<span class="line"><span style="color:#f8f8f2">      object_ptr call608;</span></span>
<span class="line"><span style="color:#fd971f">      {</span><span style="color:#f8f8f2"> call608 </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#a6e22e"> jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">dynamic_call</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">get596-&gt;</span><span style="color:#a6e22e">get_root</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2">, l, const594</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">; </span><span style="color:#fd971f">}</span></span>
<span class="line"><span style="color:#f8f8f2">      call607 </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#a6e22e"> jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">dynamic_call</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">_STAR_595-&gt;</span><span style="color:#a6e22e">get_root</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2">, call608, n</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">    /* Same thing for calling (* (get l :g) n). */</span></span>
<span class="line"><span style="color:#f8f8f2">    object_ptr call609;</span></span>
<span class="line"><span style="color:#fd971f">    {</span></span>
<span class="line"><span style="color:#f8f8f2">      object_ptr call610;</span></span>
<span class="line"><span style="color:#fd971f">      {</span><span style="color:#f8f8f2"> call610 </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#a6e22e"> jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">dynamic_call</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">get596-&gt;</span><span style="color:#a6e22e">get_root</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2">, l, const598</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">; </span><span style="color:#fd971f">}</span></span>
<span class="line"><span style="color:#f8f8f2">      call609 </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#a6e22e"> jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">dynamic_call</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">_STAR_595-&gt;</span><span style="color:#a6e22e">get_root</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2">, call610, n</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">    /* Same thing for calling (* (get l :b) n). */</span></span>
<span class="line"><span style="color:#f8f8f2">    object_ptr call611;</span></span>
<span class="line"><span style="color:#fd971f">    {</span></span>
<span class="line"><span style="color:#f8f8f2">      object_ptr call612;</span></span>
<span class="line"><span style="color:#fd971f">      {</span><span style="color:#f8f8f2"> call612 </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#a6e22e"> jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">dynamic_call</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">get596-&gt;</span><span style="color:#a6e22e">get_root</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2">, l, const600</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">; </span><span style="color:#fd971f">}</span></span>
<span class="line"><span style="color:#f8f8f2">      call611 </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#a6e22e"> jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">dynamic_call</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">_STAR_595-&gt;</span><span style="color:#a6e22e">get_root</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2">, call612, n</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">    /* Finally, we create a map from all of this and return it. */</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">    auto</span><span style="color:#f8f8f2"> const map613</span></span>
<span class="line"><span style="color:#fd971f">    (</span></span>
<span class="line"><span style="color:#a6e22e">      jank</span><span style="color:#f8f8f2">::make_box</span><span style="color:#fb4934;font-weight:700">&lt;</span><span style="color:#a6e22e">jank</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">runtime</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">obj</span><span style="color:#f8f8f2">::map</span><span style="color:#fb4934;font-weight:700">&gt;</span></span>
<span class="line"><span style="color:#fd971f">      (</span><span style="color:#a6e22e">std</span><span style="color:#f8f8f2">::in_place, const594, call607, const598, call609, const600, call611</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">    )</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    return</span><span style="color:#f8f8f2"> map613;</span></span>
<span class="line"><span style="color:#fd971f">  }</span></span>
<span class="line"><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span></code></pre><p>No big surprises there. Each var is dereferenced (with <code>-&gt;get_root()</code>) when it's used, since vars can change at any time, from any thread. Let's see what Clojure generates for the same function.<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#88846f">/* Just like in jank, a class was generated for this function. */</span></span>
<span class="line"><span style="color:#f8f8f2">public final class </span><span style="color:#a6e22e">core$vec3_scale</span><span style="color:#f8f8f2"> extends </span><span style="color:#a6e22e;font-style:italic">AFunction</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#88846f">    /* Just like in jank, the constants were lifted to be members. */</span></span>
<span class="line"><span style="color:#f8f8f2">    public static final </span><span style="color:#66d9ef;font-style:italic">Keyword</span><span style="color:#f8f8f2"> const__0;</span></span>
<span class="line"><span style="color:#f8f8f2">    public static final </span><span style="color:#66d9ef;font-style:italic">Keyword</span><span style="color:#f8f8f2"> const__3;</span></span>
<span class="line"><span style="color:#f8f8f2">    public static final </span><span style="color:#66d9ef;font-style:italic">Keyword</span><span style="color:#f8f8f2"> const__4;</span></span>
<span class="line"><span style="color:#f8f8f2">    </span></span>
<span class="line"><span style="color:#f8f8f2">    public static </span><span style="color:#66d9ef;font-style:italic">Object</span><span style="color:#a6e22e"> invokeStatic</span><span style="color:#f8f8f2">(final </span><span style="color:#66d9ef;font-style:italic">Object</span><span style="color:#fd971f;font-style:italic"> l</span><span style="color:#f8f8f2">, final </span><span style="color:#66d9ef;font-style:italic">Object</span><span style="color:#fd971f;font-style:italic"> n</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#fd971f">    {</span></span>
<span class="line"><span style="color:#88846f">      /* Wait... no var derefs. Clojure didn't generate calls to clojure.core/*</span></span>
<span class="line"><span style="color:#88846f">         at all. It replaced them with calls to `Numbers.multiply`. Same with</span></span>
<span class="line"><span style="color:#88846f">         `RT.get`.*/</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      return</span><span style="color:#f8f8f2"> RT.mapUniqueKeys</span></span>
<span class="line"><span style="color:#f8f8f2">      (</span></span>
<span class="line"><span style="color:#f8f8f2">        const__0, Numbers.</span><span style="color:#a6e22e">multiply</span><span style="color:#f8f8f2">(RT.</span><span style="color:#a6e22e">get</span><span style="color:#f8f8f2">(l, const__0), n),</span></span>
<span class="line"><span style="color:#f8f8f2">        const__3, Numbers.</span><span style="color:#a6e22e">multiply</span><span style="color:#f8f8f2">(RT.</span><span style="color:#a6e22e">get</span><span style="color:#f8f8f2">(l, const__3), n),</span></span>
<span class="line"><span style="color:#f8f8f2">        const__4, Numbers.</span><span style="color:#a6e22e">multiply</span><span style="color:#f8f8f2">(RT.</span><span style="color:#a6e22e">get</span><span style="color:#f8f8f2">(l, const__4), n)</span></span>
<span class="line"><span style="color:#f8f8f2">      );</span></span>
<span class="line"><span style="color:#fd971f">    }</span></span>
<span class="line"><span style="color:#f8f8f2">    </span></span>
<span class="line"><span style="color:#f8f8f2">    @</span><span style="color:#66d9ef;font-style:italic">Override</span></span>
<span class="line"><span style="color:#f8f8f2">    public </span><span style="color:#66d9ef;font-style:italic">Object</span><span style="color:#a6e22e"> invoke</span><span style="color:#f8f8f2">(final </span><span style="color:#66d9ef;font-style:italic">Object</span><span style="color:#fd971f;font-style:italic"> l</span><span style="color:#f8f8f2">, final </span><span style="color:#66d9ef;font-style:italic">Object</span><span style="color:#fd971f;font-style:italic"> n</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#fd971f">    {</span><span style="color:#fb4934;font-weight:700"> return</span><span style="color:#a6e22e"> invokeStatic</span><span style="color:#f8f8f2">(l, n); </span><span style="color:#fd971f">}</span></span>
<span class="line"><span style="color:#f8f8f2">    </span></span>
<span class="line"><span style="color:#88846f">    /* We initialize the constants here, instead of in the function's</span></span>
<span class="line"><span style="color:#88846f">       constructor. This is a small performance win, since it only needs to</span></span>
<span class="line"><span style="color:#88846f">       happen once. */</span></span>
<span class="line"><span style="color:#f8f8f2">    static </span><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#f8f8f2">      const__0 </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#f8f8f2"> RT.</span><span style="color:#a6e22e">keyword</span><span style="color:#f8f8f2">(</span><span style="color:#ae81ff">null</span><span style="color:#f8f8f2">, </span><span style="color:#e6db74">&quot;r&quot;</span><span style="color:#f8f8f2">);</span></span>
<span class="line"><span style="color:#f8f8f2">      const__3 </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#f8f8f2"> RT.</span><span style="color:#a6e22e">keyword</span><span style="color:#f8f8f2">(</span><span style="color:#ae81ff">null</span><span style="color:#f8f8f2">, </span><span style="color:#e6db74">&quot;g&quot;</span><span style="color:#f8f8f2">);</span></span>
<span class="line"><span style="color:#f8f8f2">      const__4 </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#f8f8f2"> RT.</span><span style="color:#a6e22e">keyword</span><span style="color:#f8f8f2">(</span><span style="color:#ae81ff">null</span><span style="color:#f8f8f2">, </span><span style="color:#e6db74">&quot;b&quot;</span><span style="color:#f8f8f2">);</span></span>
<span class="line"><span style="color:#fd971f">    }</span></span>
<span class="line"><span style="color:#fd971f">}</span></span></code></pre><p>Ok, that's cheating! Clojure skipped past the actual implementation of <code>clojure.core/*</code> and generated something else in its place. This not only skips the var dereference, but it allows for calling right into a Java function which is going to be faster than something written in Clojure. It also skipped past the var for <code>clojure.core/get</code> and instead generated in a call to <code>RT.get</code>. While what I said about vars changing all the time is true, Clojure makes an exception for some functions within <code>clojure.core</code>.<p>Fine. I can cheat, too. The changes:<ul><li>Optimize calls to get: <a href="https://github.com/jank-lang/jank/commit/7258ddd3c58debf09070a71a4a1149bd1170d440">7258ddd3c58debf09070a71a4a1149bd1170d440</a><li>Optimize math calls: <a href="https://github.com/jank-lang/jank/commit/cde89658cec801ae54a4858d75e99ad9fde4bd2a">cde89658cec801ae54a4858d75e99ad9fde4bd2a</a></ul><p>But before we look at the new time, there was another thing Clojure is doing. Clojure unboxes numbers whenever possible. Unboxing means to use automatic memory, rather than dynamic memory for storing something; this is frequently referred to as using &quot;the stack&quot;. Take a look at this function here:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#fd971f">(</span><span style="color:#fb4934;font-weight:700">defn</span><span style="color:#f8f8f2"> reflectance </span><span style="color:#fd971f">[</span><span style="color:#f8f8f2">cosine ref-idx</span><span style="color:#fd971f">]</span></span>
<span class="line"><span style="color:#fd971f">  (</span><span style="color:#fb4934;font-weight:700">let</span><span style="color:#fd971f"> [</span><span style="color:#f8f8f2">r </span><span style="color:#fd971f">(</span><span style="color:#a6e22e">/</span><span style="color:#fd971f"> (</span><span style="color:#a6e22e">-</span><span style="color:#ae81ff"> 1.0</span><span style="color:#f8f8f2"> ref-idx</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">             (</span><span style="color:#a6e22e">+</span><span style="color:#ae81ff"> 1.0</span><span style="color:#f8f8f2"> ref-idx</span><span style="color:#fd971f">))</span></span>
<span class="line"><span style="color:#f8f8f2">        r2 </span><span style="color:#fd971f">(</span><span style="color:#a6e22e">*</span><span style="color:#f8f8f2"> r r</span><span style="color:#fd971f">)]</span></span>
<span class="line"><span style="color:#fd971f">    (</span><span style="color:#a6e22e">*</span><span style="color:#fd971f"> (</span><span style="color:#a6e22e">+</span><span style="color:#f8f8f2"> r2 </span><span style="color:#fd971f">(</span><span style="color:#a6e22e">-</span><span style="color:#ae81ff"> 1.0</span><span style="color:#f8f8f2"> r2</span><span style="color:#fd971f">))</span></span>
<span class="line"><span style="color:#fd971f">       (</span><span style="color:#a6e22e">Math/pow</span><span style="color:#fd971f"> (</span><span style="color:#a6e22e">-</span><span style="color:#ae81ff"> 1.0</span><span style="color:#f8f8f2"> cosine</span><span style="color:#fd971f">)</span><span style="color:#ae81ff"> 5.0</span><span style="color:#fd971f">))))</span></span></code></pre><p>Because <code>(- 1.0 ref-idx)</code> contains a <code>double</code>, Clojure can know that the whole expression will return a <code>double</code>. By then tracking how <code>r</code> is used, we can see if it requires boxing at all. In this case, <code>r</code> is only used with <code>*</code>, which doesn't require boxing. So <code>r</code> can actually just be a <code>double</code> instead of a <code>Double</code>. The same applies for everything else. Take a look at the generated code.<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">public final class </span><span style="color:#a6e22e">core$reflectance</span><span style="color:#f8f8f2"> extends </span><span style="color:#a6e22e;font-style:italic">AFunction</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#f8f8f2">  public static </span><span style="color:#66d9ef;font-style:italic">Object</span><span style="color:#a6e22e"> invokeStatic</span><span style="color:#f8f8f2">(final </span><span style="color:#66d9ef;font-style:italic">Object</span><span style="color:#fd971f;font-style:italic"> cosine</span><span style="color:#f8f8f2">, final </span><span style="color:#66d9ef;font-style:italic">Object</span><span style="color:#fd971f;font-style:italic"> ref_idx</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#fd971f">  {</span></span>
<span class="line"><span style="color:#f8f8f2">    final </span><span style="color:#66d9ef;font-style:italic">double</span><span style="color:#f8f8f2"> r </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#f8f8f2"> Numbers.</span><span style="color:#a6e22e">minus</span><span style="color:#f8f8f2">(</span><span style="color:#ae81ff">1.0</span><span style="color:#f8f8f2">, ref_idx) </span><span style="color:#fb4934;font-weight:700">/</span><span style="color:#f8f8f2"> Numbers.</span><span style="color:#a6e22e">add</span><span style="color:#f8f8f2">(</span><span style="color:#ae81ff">1.0</span><span style="color:#f8f8f2">, ref_idx);</span></span>
<span class="line"><span style="color:#f8f8f2">    final </span><span style="color:#66d9ef;font-style:italic">double</span><span style="color:#f8f8f2"> r2 </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#f8f8f2"> r </span><span style="color:#fb4934;font-weight:700">*</span><span style="color:#f8f8f2"> r;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    return</span><span style="color:#f8f8f2"> Numbers.</span><span style="color:#a6e22e">multiply</span><span style="color:#f8f8f2">(r2 </span><span style="color:#fb4934;font-weight:700">+</span><span style="color:#f8f8f2"> (</span><span style="color:#ae81ff">1.0</span><span style="color:#fb4934;font-weight:700"> -</span><span style="color:#f8f8f2"> r2), Math.</span><span style="color:#a6e22e">pow</span><span style="color:#f8f8f2">(Numbers.</span><span style="color:#a6e22e">minus</span><span style="color:#f8f8f2">(</span><span style="color:#ae81ff">1.0</span><span style="color:#f8f8f2">, cosine), </span><span style="color:#ae81ff">5.0</span><span style="color:#f8f8f2">));</span></span>
<span class="line"><span style="color:#fd971f">  }</span></span>
<span class="line"><span style="color:#fd971f">}</span></span></code></pre><p>One last point about this: you may note that we're not boxing the <code>double</code> we're returning. The call to <code>Numbers.multiply</code> with two <code>double</code> inputs returns a <code>double</code>, but our function returns an <code>Object</code>. This works because Java supports auto-boxing and unboxing. In short, it will allow you to implicitly treat boxed and unboxed objects the same, injecting in the necessary code when it compiles. So, don't be fooled, the final return value here is boxed.<p>To do a similar thing in jank, I broke it into some steps:<h5>Generate more type info</h5><p>Changes: <a href="https://github.com/jank-lang/jank/commit/3e18c1025f3a6db2028d55f819594208197e1a78">3e18c1025f3a6db2028d55f819594208197e1a78</a><p>The goal here is to use boxed types (<code>integer_ptr</code>, <code>keyword_ptr</code>, etc) during codegen, whenever we have them, rather than just <code>object_ptr</code> everywhere. Also, whenever possible, use <code>auto</code> to allow the propagation of richer types.<h5>Add boxed typed overloads for math fns</h5><p>Changes: <a href="https://github.com/jank-lang/jank/commit/083f08374dd371dacf6b854decbada83d336fbd6">083f08374dd371dacf6b854decbada83d336fbd6</a><p>Even without unboxing, if we can know we're adding a <code>real_ptr</code> and a <code>real_ptr</code>, for example, we can skip the polymorphic dance and get right at their internal data. We don't do that yet, here, but we add the right overloads.<h5>Extend the codegen to convey, for any expression, whether a box is needed</h5><p>Changes: <a href="https://github.com/jank-lang/jank/commit/626680ecdb09d9007378e5f17bd06f8bcfd285ff">626680ecdb09d9007378e5f17bd06f8bcfd285ff</a><p>This sets the stage for unboxed math, <code>if</code> conditions, <code>let</code> bindings, etc.<h5>Remove polymorphism from boxed math ops, when possible</h5><p>Changes: <a href="https://github.com/jank-lang/jank/commit/87715f9a711e0e0bd667afce221ccbe4a85b5501">87715f9a711e0e0bd667afce221ccbe4a85b5501</a><p>This utilizes the typed overloads to optimize the calls where we have a typed box like <code>integer_ptr</code> or <code>real_ptr</code>.<h5>Add unboxed math overloads</h5><p>Changes: <a href="https://github.com/jank-lang/jank/commit/d6d97e9a58f6a40dcc425b8da80c9bd69faa0886">d6d97e9a58f6a40dcc425b8da80c9bd69faa0886</a><p>Wrapping everything together, this allows expressions like <code>(/ 1.0 (+ n 0.5))</code> to avoid boxing, at least for the <code>(+ n 0.5)</code>. Conditions for <code>if</code> don't require boxing, so something like <code>(if (&lt; y (/ 1.0 (+ n 0.5))) ...)</code> wouldn't box at all.<p>I didn't implement unboxed <code>let</code> bindings, since that requires tracking binding usages to know if each one requires a box and I'm lazy. Still, let's see what we won.<table><thead><tr><th style="text-align:right">ms/op<th style="text-align:right">op/s<th style="text-align:right">err%<th style="text-align:right">ins/op<th style="text-align:right">bra/op<th style="text-align:right">miss%<th style="text-align:right">total<th style="text-align:left">benchmark<tbody><tr><td style="text-align:right">312.78<td style="text-align:right">3.20<td style="text-align:right">3.4%<td style="text-align:right">1,817,289,100.00<td style="text-align:right">350,618,740.00<td style="text-align:right">1.4%<td style="text-align:right">3.39<td style="text-align:left"><code>ray</code></table><p>Nice! That was a lot of work, but it gets us down from 559.31 ms to 312.78 ms.<h4>Profile results</h4><p>At this point, inspecting the generated code wasn't showing any clear opportunities, so I profiled again and looked for the primary culprits. They were:<ul><li><code>get</code><li><code>mul</code>, <code>add</code>, <code>sub</code><li>map constructor</ul><p>Hm, strikingly similar to the expectations set when we started. Sometimes it's unfortunate not to find surprises. Still, let's see what we can do about those maps.<h4>Faster map</h4><p>jank's array map implementation was using a vector of pairs. Note that both jank and Clojure distinguish between array maps and hash maps. Array maps are a specialization for short maps (i.e. few keys) which don't have the overhead of trees. Rather than <code>O(log32 n)</code> access with some constant overhead, they have <code>O(n)</code> access with very little overhead. When <code>n</code> is small enough, it ends up being faster. Once array maps get too big, they convert automatically into hash maps. For this ray tracer, all the maps are very small, so we're only looking at the array map implementation. jank's array map looked like this:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">template</span><span style="color:#fd971f"> &lt;</span><span style="color:#66d9ef;font-style:italic">typename</span><span style="color:#a6e22e"> K</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">typename</span><span style="color:#a6e22e"> V</span><span style="color:#fd971f">&gt;</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> map_type_impl</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#88846f">  /* Storing a vector of key/value pairs. */</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  using</span><span style="color:#a6e22e"> value_type</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#a6e22e"> native_vector</span><span style="color:#fd971f">&lt;</span><span style="color:#a6e22e">std</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">pair</span><span style="color:#fd971f">&lt;</span><span style="color:#a6e22e">K</span><span style="color:#f8f8f2">, </span><span style="color:#a6e22e">V</span><span style="color:#fd971f">&gt;&gt;</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  using</span><span style="color:#a6e22e"> iterator</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#fb4934;font-weight:700"> typename</span><span style="color:#a6e22e"> value_type</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">iterator</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  using</span><span style="color:#a6e22e"> const_iterator</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#fb4934;font-weight:700"> typename</span><span style="color:#a6e22e"> value_type</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">const_iterator</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#a6e22e">  map_type_impl</span><span style="color:#fd971f">()</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#fb4934;font-weight:700"> default</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#a6e22e">  map_type_impl</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">map_type_impl</span><span style="color:#f8f8f2"> const &amp;</span><span style="color:#fd971f;font-style:italic">s</span><span style="color:#fd971f">)</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#fb4934;font-weight:700"> default</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#a6e22e">  map_type_impl</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">map_type_impl</span><span style="color:#f8f8f2"> &amp;&amp;</span><span style="color:#fd971f;font-style:italic">s</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2"> noexcept </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#fb4934;font-weight:700"> default</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#a6e22e">  map_type_impl</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">in_place_unique</span><span style="color:#f8f8f2">, </span><span style="color:#a6e22e">value_type</span><span style="color:#f8f8f2"> &amp;&amp;</span><span style="color:#fd971f;font-style:italic">kvs</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#f8f8f2">    : </span><span style="color:#a6e22e">data</span><span style="color:#fd971f">{</span><span style="color:#a6e22e"> std</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">move</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">kvs</span><span style="color:#fd971f">)</span><span style="color:#fd971f"> }</span></span>
<span class="line"><span style="color:#fd971f">  {</span><span style="color:#fd971f"> }</span></span>
<span class="line"><span style="color:#a6e22e">  ~map_type_impl</span><span style="color:#fd971f">()</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#fb4934;font-weight:700"> default</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">  /* ... insert fns ... */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">  /* Note the linear search. */</span></span>
<span class="line"><span style="color:#a6e22e">  V</span><span style="color:#a6e22e"> find</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">K</span><span style="color:#f8f8f2"> const &amp;</span><span style="color:#fd971f;font-style:italic">key</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2"> const</span></span>
<span class="line"><span style="color:#fd971f">  {</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    if</span><span style="color:#fd971f">(</span><span style="color:#66d9ef;font-style:italic">auto</span><span style="color:#f8f8f2"> const kw </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#f8f8f2"> key-&gt;</span><span style="color:#a6e22e">as_keyword</span><span style="color:#fd971f">())</span></span>
<span class="line"><span style="color:#fd971f">    {</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      for</span><span style="color:#fd971f">(</span><span style="color:#66d9ef;font-style:italic">auto</span><span style="color:#f8f8f2"> const </span><span style="color:#fb4934;font-weight:700">&amp;</span><span style="color:#f8f8f2">kv : data</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">      {</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">        if</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">kv.first </span><span style="color:#fb4934;font-weight:700">==</span><span style="color:#f8f8f2"> key</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">        {</span><span style="color:#fb4934;font-weight:700"> return</span><span style="color:#f8f8f2"> kv.second; </span><span style="color:#fd971f">}</span></span>
<span class="line"><span style="color:#fd971f">      }</span></span>
<span class="line"><span style="color:#fd971f">    }</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    else</span></span>
<span class="line"><span style="color:#fd971f">    {</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      for</span><span style="color:#fd971f">(</span><span style="color:#66d9ef;font-style:italic">auto</span><span style="color:#f8f8f2"> const </span><span style="color:#fb4934;font-weight:700">&amp;</span><span style="color:#f8f8f2">kv : data</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">      {</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">        if</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">kv.first-&gt;</span><span style="color:#a6e22e">equal</span><span style="color:#fd971f">(</span><span style="color:#fb4934;font-weight:700">*</span><span style="color:#f8f8f2">key</span><span style="color:#fd971f">))</span></span>
<span class="line"><span style="color:#fd971f">        {</span><span style="color:#fb4934;font-weight:700"> return</span><span style="color:#f8f8f2"> kv.second; </span><span style="color:#fd971f">}</span></span>
<span class="line"><span style="color:#fd971f">      }</span></span>
<span class="line"><span style="color:#fd971f">    }</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    return</span><span style="color:#ae81ff"> nullptr</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">  /* ... hashing, iterators, size, etc ... */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">  value_type data;</span></span>
<span class="line"><span style="color:#f8f8f2">  mutable </span><span style="color:#66d9ef;font-style:italic">size_t</span><span style="color:#f8f8f2"> hash</span><span style="color:#fd971f">{}</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span></code></pre><p>This is using <a href="https://github.com/facebook/folly/blob/main/folly/docs/FBVector.md">folly's vector</a>, a more optimized version of <code>std::vector</code>. Turns out it's still very slow to create, compared to just an array. I ended up benchmarking both vector types, <code>std::array</code>, and finally C arrays, each with pairs and without. C arrays, without pairs, clearly won. Since there are no pairs, keys and values are interleaved. Turns out this is exactly what Clojure does in <a href="https://github.com/clojure/clojure/blob/master/src/jvm/clojure/lang/PersistentArrayMap.java#L34">PersistentArrayMap.java</a>.<p>The new array map is quite similar:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">template</span><span style="color:#fd971f"> &lt;</span><span style="color:#66d9ef;font-style:italic">typename</span><span style="color:#a6e22e"> KV</span><span style="color:#fd971f">&gt;</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">struct</span><span style="color:#a6e22e"> map_type_impl</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#88846f">  /* Just a C array and a length. */</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  using</span><span style="color:#a6e22e"> value_type</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#a6e22e"> KV</span><span style="color:#f8f8f2">*;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#a6e22e">  map_type_impl</span><span style="color:#fd971f">()</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#fb4934;font-weight:700"> default</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#a6e22e">  map_type_impl</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">map_type_impl</span><span style="color:#f8f8f2"> const &amp;</span><span style="color:#fd971f;font-style:italic">s</span><span style="color:#fd971f">)</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#fb4934;font-weight:700"> default</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#a6e22e">  map_type_impl</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">map_type_impl</span><span style="color:#f8f8f2"> &amp;&amp;</span><span style="color:#fd971f;font-style:italic">s</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2"> noexcept </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#fb4934;font-weight:700"> default</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#a6e22e">  map_type_impl</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">in_place_unique</span><span style="color:#f8f8f2">, </span><span style="color:#a6e22e">value_type</span><span style="color:#f8f8f2"> const </span><span style="color:#fd971f;font-style:italic">kvs</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">size_t</span><span style="color:#f8f8f2"> const </span><span style="color:#fd971f;font-style:italic">length</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#f8f8f2">    : </span><span style="color:#a6e22e">data</span><span style="color:#fd971f">{</span><span style="color:#f8f8f2"> kvs </span><span style="color:#fd971f">}</span><span style="color:#f8f8f2">, </span><span style="color:#a6e22e">length</span><span style="color:#fd971f">{</span><span style="color:#f8f8f2"> length </span><span style="color:#fd971f">}</span></span>
<span class="line"><span style="color:#fd971f">  {</span><span style="color:#fd971f"> }</span></span>
<span class="line"><span style="color:#a6e22e">  ~map_type_impl</span><span style="color:#fd971f">()</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#fb4934;font-weight:700"> default</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">  /* ... insert fns ... */</span></span>
<span class="line"></span>
<span class="line"><span style="color:#a6e22e">  KV</span><span style="color:#a6e22e"> find</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">KV</span><span style="color:#f8f8f2"> const </span><span style="color:#fd971f;font-style:italic">key</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2"> const</span></span>
<span class="line"><span style="color:#fd971f">  {</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    if</span><span style="color:#fd971f">(</span><span style="color:#66d9ef;font-style:italic">auto</span><span style="color:#f8f8f2"> const kw </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#f8f8f2"> key-&gt;</span><span style="color:#a6e22e">as_keyword</span><span style="color:#fd971f">())</span></span>
<span class="line"><span style="color:#fd971f">    {</span></span>
<span class="line"><span style="color:#88846f">      /* Interleaved key/values changes iteration. */</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      for</span><span style="color:#fd971f">(</span><span style="color:#66d9ef;font-style:italic">size_t</span><span style="color:#f8f8f2"> i{}; i </span><span style="color:#fb4934;font-weight:700">&lt;</span><span style="color:#f8f8f2"> length; i </span><span style="color:#fb4934;font-weight:700">+=</span><span style="color:#ae81ff"> 2</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">      {</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">        if</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">data[i] </span><span style="color:#fb4934;font-weight:700">==</span><span style="color:#f8f8f2"> key</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">        {</span><span style="color:#fb4934;font-weight:700"> return</span><span style="color:#f8f8f2"> data[i </span><span style="color:#fb4934;font-weight:700">+</span><span style="color:#ae81ff"> 1</span><span style="color:#f8f8f2">]; </span><span style="color:#fd971f">}</span></span>
<span class="line"><span style="color:#fd971f">      }</span></span>
<span class="line"><span style="color:#fd971f">    }</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    else</span></span>
<span class="line"><span style="color:#fd971f">    {</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      for</span><span style="color:#fd971f">(</span><span style="color:#66d9ef;font-style:italic">size_t</span><span style="color:#f8f8f2"> i{}; i </span><span style="color:#fb4934;font-weight:700">&lt;</span><span style="color:#f8f8f2"> length; i </span><span style="color:#fb4934;font-weight:700">+=</span><span style="color:#ae81ff"> 2</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">      {</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">        if</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">data[i]-&gt;</span><span style="color:#a6e22e">equal</span><span style="color:#fd971f">(</span><span style="color:#fb4934;font-weight:700">*</span><span style="color:#f8f8f2">key</span><span style="color:#fd971f">))</span></span>
<span class="line"><span style="color:#fd971f">        {</span><span style="color:#fb4934;font-weight:700"> return</span><span style="color:#f8f8f2"> data[i </span><span style="color:#fb4934;font-weight:700">+</span><span style="color:#ae81ff"> 1</span><span style="color:#f8f8f2">]; </span><span style="color:#fd971f">}</span></span>
<span class="line"><span style="color:#fd971f">      }</span></span>
<span class="line"><span style="color:#fd971f">    }</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    return</span><span style="color:#ae81ff"> nullptr</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">  /* Custom iteration is needed, due to the interleaving. */</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">  struct</span><span style="color:#a6e22e"> iterator</span></span>
<span class="line"><span style="color:#fd971f">  {</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    using</span><span style="color:#a6e22e"> iterator_category</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#a6e22e"> std</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">input_iterator_tag</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    using</span><span style="color:#a6e22e"> difference_type</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#a6e22e"> std</span><span style="color:#f8f8f2">::</span><span style="color:#66d9ef;font-style:italic">ptrdiff_t</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    using</span><span style="color:#a6e22e"> value_type</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#a6e22e"> std</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">pair</span><span style="color:#fd971f">&lt;</span><span style="color:#a6e22e">KV</span><span style="color:#f8f8f2">, </span><span style="color:#a6e22e">KV</span><span style="color:#fd971f">&gt;</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    using</span><span style="color:#a6e22e"> pointer</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#a6e22e"> value_type</span><span style="color:#f8f8f2">*;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">    using</span><span style="color:#a6e22e"> reference</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#a6e22e"> value_type</span><span style="color:#f8f8f2">&amp;;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#a6e22e">    value_type</span><span style="color:#fb4934;font-weight:700"> operator</span><span style="color:#f8f8f2"> *</span><span style="color:#fd971f">()</span><span style="color:#f8f8f2"> const</span></span>
<span class="line"><span style="color:#fd971f">    {</span><span style="color:#fb4934;font-weight:700"> return</span><span style="color:#fd971f"> {</span><span style="color:#f8f8f2"> data[index], data[index </span><span style="color:#fb4934;font-weight:700">+</span><span style="color:#ae81ff"> 1</span><span style="color:#f8f8f2">] </span><span style="color:#fd971f">}</span><span style="color:#f8f8f2">; </span><span style="color:#fd971f">}</span></span>
<span class="line"><span style="color:#a6e22e">    iterator</span><span style="color:#f8f8f2">&amp; </span><span style="color:#fb4934;font-weight:700">operator</span><span style="color:#f8f8f2"> ++</span><span style="color:#fd971f">()</span></span>
<span class="line"><span style="color:#fd971f">    {</span></span>
<span class="line"><span style="color:#f8f8f2">      index </span><span style="color:#fb4934;font-weight:700">+=</span><span style="color:#ae81ff"> 2</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      return</span><span style="color:#fb4934;font-weight:700"> *</span><span style="color:#fd971f">this</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">    }</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">    bool</span><span style="color:#fb4934;font-weight:700"> operator</span><span style="color:#f8f8f2"> !=</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">iterator</span><span style="color:#f8f8f2"> const &amp;</span><span style="color:#fd971f;font-style:italic">rhs</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2"> const</span></span>
<span class="line"><span style="color:#fd971f">    {</span><span style="color:#fb4934;font-weight:700"> return</span><span style="color:#f8f8f2"> data </span><span style="color:#fb4934;font-weight:700">!=</span><span style="color:#f8f8f2"> rhs.data </span><span style="color:#fb4934;font-weight:700">||</span><span style="color:#f8f8f2"> index </span><span style="color:#fb4934;font-weight:700">!=</span><span style="color:#f8f8f2"> rhs.index; </span><span style="color:#fd971f">}</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">    bool</span><span style="color:#fb4934;font-weight:700"> operator</span><span style="color:#f8f8f2"> ==</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">iterator</span><span style="color:#f8f8f2"> const &amp;</span><span style="color:#fd971f;font-style:italic">rhs</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2"> const</span></span>
<span class="line"><span style="color:#fd971f">    {</span><span style="color:#fb4934;font-weight:700"> return</span><span style="color:#fb4934;font-weight:700"> !</span><span style="color:#fd971f">(</span><span style="color:#fb4934;font-weight:700">*</span><span style="color:#fd971f">this</span><span style="color:#fb4934;font-weight:700"> !=</span><span style="color:#f8f8f2"> rhs</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">; </span><span style="color:#fd971f">}</span></span>
<span class="line"><span style="color:#a6e22e">    iterator</span><span style="color:#f8f8f2">&amp; </span><span style="color:#fb4934;font-weight:700">operator</span><span style="color:#f8f8f2">=</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">iterator</span><span style="color:#f8f8f2"> const &amp;</span><span style="color:#fd971f;font-style:italic">rhs</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">    {</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      if</span><span style="color:#fd971f">(this</span><span style="color:#fb4934;font-weight:700"> ==</span><span style="color:#fb4934;font-weight:700"> &amp;</span><span style="color:#f8f8f2">rhs</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">      {</span><span style="color:#fb4934;font-weight:700"> return</span><span style="color:#fb4934;font-weight:700"> *</span><span style="color:#fd971f">this</span><span style="color:#f8f8f2">; </span><span style="color:#fd971f">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">      data </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#f8f8f2"> rhs.data;</span></span>
<span class="line"><span style="color:#f8f8f2">      index </span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#f8f8f2"> rhs.index;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      return</span><span style="color:#fb4934;font-weight:700"> *</span><span style="color:#fd971f">this</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">    KV const</span><span style="color:#fb4934;font-weight:700">*</span><span style="color:#f8f8f2"> data</span><span style="color:#fd971f">{}</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">    size_t</span><span style="color:#f8f8f2"> index</span><span style="color:#fd971f">{}</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">  }</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  using</span><span style="color:#a6e22e"> const_iterator</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#a6e22e"> iterator</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#f8f8f2">  value_type data</span><span style="color:#fd971f">{}</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">  size_t</span><span style="color:#f8f8f2"> length</span><span style="color:#fd971f">{}</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#f8f8f2">  mutable </span><span style="color:#66d9ef;font-style:italic">size_t</span><span style="color:#f8f8f2"> hash</span><span style="color:#fd971f">{}</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span></code></pre><p>Let's take a look at the new numbers.<table><thead><tr><th style="text-align:right">ms/op<th style="text-align:right">op/s<th style="text-align:right">err%<th style="text-align:right">ins/op<th style="text-align:right">bra/op<th style="text-align:right">miss%<th style="text-align:right">total<th style="text-align:left">benchmark<tbody><tr><td style="text-align:right">199.31<td style="text-align:right">5.02<td style="text-align:right">4.7%<td style="text-align:right">1,000,518,223.00<td style="text-align:right">241,479,412.00<td style="text-align:right">1.2%<td style="text-align:right">2.20<td style="text-align:left"><code>ray</code></table><p>From 312.78 ms to 199.31 ms. This actually optimized both map creation and map lookup. We're still in the 3x territory, compared to Clojure, though. We need some more big wins.<h2>Compiler flags</h2><p>Big wins in the code were getting tough to come by, at this point, so I started looking elsewhere. What flags are we using for the compiler? What about the JIT compiler? We had <code>-O1</code> for both, due to some <a href="https://github.com/root-project/cling">Cling</a> issues which prevented me from going higher. I spent some time working around those and was able to get jank compiling with <code>-O3</code>. This alone was a huge win, but I was able to tweak Cling's flags as well, to balance the trade-off between run time and compile time. We can't go to <code>-O3</code> for Cling, but we can do better than just <code>-O1</code>. That can mean <code>-ffast-math</code>, <code>-march=native</code>, etc. More importantly, we can make this configurable with a command line flag.<table><thead><tr><th style="text-align:right">ms/op<th style="text-align:right">op/s<th style="text-align:right">err%<th style="text-align:right">ins/op<th style="text-align:right">bra/op<th style="text-align:right">miss%<th style="text-align:right">total<th style="text-align:left">benchmark<tbody><tr><td style="text-align:right">124.46<td style="text-align:right">8.03<td style="text-align:right">0.7%<td style="text-align:right">737,637,716.35<td style="text-align:right">155,270,134.60<td style="text-align:right">1.5%<td style="text-align:right">30.11<td style="text-align:left"><code>ray</code></table><p>Very nice. This gets us within the 2x range from Clojure, so it's time to pull out a card I've been hanging onto for a while.<h2>Disable incremental GC</h2><p>I've been running all of this with Boehm's GC set to incremental mode, which actually does some garbage collection on every allocation. This is sometimes preferable for more deterministic frame rate, for example, but jank needs to provide this as a run-time option rather than hard-coding it. The default Boehm GC mode, which is what the JVM is doing for Clojure, collects far less frequently, but it &quot;stops the world&quot; for longer in order to do so. If we switch back to that mode:<table><thead><tr><th style="text-align:right">ms/op<th style="text-align:right">op/s<th style="text-align:right">err%<th style="text-align:right">ins/op<th style="text-align:right">bra/op<th style="text-align:right">miss%<th style="text-align:right">total<th style="text-align:left">benchmark<tbody><tr><td style="text-align:right">73.07<td style="text-align:right">13.69<td style="text-align:right">0.7%<td style="text-align:right">492,708,225.76<td style="text-align:right">101,461,032.29<td style="text-align:right">0.2%<td style="text-align:right">17.89<td style="text-align:left"><code>ray</code></table><p>Oh yeah. We're about 4 ms away from beating Clojure and we haven't changed a single line of the ray tracer.<h2>Final stretch</h2><p>I tried a lot of things here. Profiling wasn't giving me much, mostly due to issues with Cling, which don't allow me to profile with optimizations above <code>-O1</code>. Though I'm confident that unboxing those <code>let</code> bindings would likely do the trick, I was still too lazy, so I looked elsewhere.<p>Starting at 73.07 ms, I ran through some optimizations I could see:<ol><li>Use <code>final</code> everywhere, to encourage devirtualization (<a href="https://github.com/jank-lang/jank/commit/86e0ff8512c07720f735b40c772074158a2e9661">changes</a>): 72.32 ms<li>Unbox constants wherever possible (<a href="https://github.com/jank-lang/jank/commit/b557dcb24b48d947f83f4effdac09ba3508392d0">changes</a>): 70.72 ms<li>Unboxed, direct fn calls when possible (<a href="https://github.com/jank-lang/jank/commit/6f26fdda89e385c9edb43b8f8696e9aded8795e7">changes</a>): no change<li>Unboxed <code>integer_range</code> instead of polymorphic <code>range</code> (didn't commit): no change<li>Remove excess <code>option&lt;T&gt;</code> use, showing up in profiler (<a href="https://github.com/jank-lang/jank/commit/5b34e9dd57229efe9959f332602c57f0614fddd0">changes</a>): no change</ol><p>Finally, I noticed through more careful profiling that <code>reduce*</code> was showing up. Let's see how it was written.<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#fd971f">(</span><span style="color:#fb4934;font-weight:700">defn</span><span style="color:#f8f8f2"> reduce*</span></span>
<span class="line"><span style="color:#88846f">  ; ... Ignoring the binary version ...</span></span>
<span class="line"><span style="color:#fd971f">  ([</span><span style="color:#f8f8f2">f val coll</span><span style="color:#fd971f">]</span></span>
<span class="line"><span style="color:#fd971f">    (</span><span style="color:#fb4934;font-weight:700">let</span><span style="color:#fd971f"> [</span><span style="color:#f8f8f2">s </span><span style="color:#fd971f">(</span><span style="color:#a6e22e">seq</span><span style="color:#f8f8f2"> coll</span><span style="color:#fd971f">)]</span></span>
<span class="line"><span style="color:#fd971f">      (</span><span style="color:#fb4934;font-weight:700">if</span><span style="color:#f8f8f2"> s</span></span>
<span class="line"><span style="color:#fd971f">        (</span><span style="color:#fb4934;font-weight:700">recur</span><span style="color:#f8f8f2"> f </span><span style="color:#fd971f">(</span><span style="color:#a6e22e">f</span><span style="color:#f8f8f2"> val </span><span style="color:#fd971f">(</span><span style="color:#a6e22e">first</span><span style="color:#f8f8f2"> s</span><span style="color:#fd971f">))</span><span style="color:#fd971f"> (</span><span style="color:#a6e22e">next</span><span style="color:#f8f8f2"> s</span><span style="color:#fd971f">))</span></span>
<span class="line"><span style="color:#f8f8f2">        val</span><span style="color:#fd971f">))))</span></span></code></pre><p>Ah, this was one of the few jank functions in <code>clojure.core</code> which didn't yet have a native implementation. Also, let's take a look at some key points here:<ol><li>Each iteration, we call <code>seq</code> on <code>coll</code><li>We call <code>next</code> on the sequence, since we don't have <code>next-in-place</code> exposed in jank; this would only be safe if we know it's a fresh sequence, though</ol><p>In the last optimization post, we added the <code>next_in_place</code> function to the <code>sequence</code> object, which allows us to iterate without another allocation. By default, Clojure's sequences allocate a new seq for each iteration. But this in-place update can only be done if we're 100% certain we have a fresh sequence which nobody else is hanging onto. Right now, this can be known in three ways:<ol><li>Implicitly, if we're in a variadic function, since we know that the packed args will be a sequence created just for this function<li>Also implicitly, if we have the result of calling <code>next</code> on a sequence, which is required to return a fresh sequence<li>Explicitly, if we just made the sequence ourselves</ol><p>I think we need another explicit way to do this and that we should remove the second implicit way by allowing <code>next</code> to not return fresh sequences. This would allow a <code>range</code> to pre-allocate sequences, for example. So, I added a <code>fresh_seq</code> function to the <code>seqable</code> behavior, which must explicitly return a fresh sequence which can then be updated in place. Both <code>fresh-seq</code> and <code>next-in-place</code> were added to <code>clojure.core</code>, too, though they may end up in a different namespace eventually. The new version of <code>reduce*</code> only has one allocation (the fresh seq), regardless of the size of <code>coll</code>, and looks like this:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#fd971f">(</span><span style="color:#fb4934;font-weight:700">defn</span><span style="color:#f8f8f2"> reduce*</span></span>
<span class="line"><span style="color:#88846f">  ; ... Ignoring the binary version ...</span></span>
<span class="line"><span style="color:#fd971f">  ([</span><span style="color:#f8f8f2">f val coll</span><span style="color:#fd971f">]</span></span>
<span class="line"><span style="color:#fd971f">    (</span><span style="color:#a6e22e">native/raw</span><span style="color:#e6db74"> &quot;__value = #{ val }#;</span></span>
<span class="line"><span style="color:#e6db74">                 for</span></span>
<span class="line"><span style="color:#e6db74">                 (</span></span>
<span class="line"><span style="color:#e6db74">                   auto it(#{ coll }#-&gt;as_seqable()-&gt;fresh_seq());</span></span>
<span class="line"><span style="color:#e6db74">                   it != nullptr;</span></span>
<span class="line"><span style="color:#e6db74">                   it = it-&gt;next_in_place()</span></span>
<span class="line"><span style="color:#e6db74">                 )</span></span>
<span class="line"><span style="color:#e6db74">                 { __value = dynamic_call(f, __value, it-&gt;first()); }&quot;</span><span style="color:#fd971f">)))</span></span></code></pre><p>The changes: <a href="https://github.com/jank-lang/jank/commit/93626ac79919d9280985e90746fbc229554e5788">93626ac79919d9280985e90746fbc229554e5788</a><table><thead><tr><th style="text-align:right">ms/op<th style="text-align:right">op/s<th style="text-align:right">err%<th style="text-align:right">ins/op<th style="text-align:right">bra/op<th style="text-align:right">miss%<th style="text-align:right">total<th style="text-align:left">benchmark<tbody><tr><td style="text-align:right">69.00<td style="text-align:right">14.49<td style="text-align:right">0.6%<td style="text-align:right">468,098,714.62<td style="text-align:right">95,721,617.90<td style="text-align:right">0.4%<td style="text-align:right">16.70<td style="text-align:left"><code>ray</code></table><p>Phew. From 70.72 ms down to 69.00 ms with this change. We have successfully beat Clojure's 69.44 ms, albeit by less than half of a millisecond.<h3>Summary</h3><p>jank is getting faster and faster and it's also getting more and more functionality. Still, I need to note some things. This was all benchmarked in a REPL. Clojure supports AOT compilation, direct linking, type hints, etc, which would make it even faster. I will benchmark against those when jank supports them. For this exercise, I was only focused on how Clojure and jank ran the same code out of the box.<p>There's a lot more which jank could do in order to drop this time further. We already mentioned tracking <code>let</code> bindings, so we could unbox them. Each jank-defined function, right now, is limited to accepting <code>object_ptr</code> inputs and returning one <code>object_ptr</code> output. Also, my benchmarking has shown that trying to mimic Clojure's Java hierarchy in C++ is just not going to pan out well, so a different solution will be required. Early prototyping of that has been <em>very</em> promising, but more will be shared in a future post.<p>I'm confident jank can consistently be faster than Clojure, and I will work to make that happen. But I also realize that speed is only one metric; jank needs to be easily usable, be as simple as possible, have great tooling, and embrace the culture of stability which Clojure has. Future posts will also be focusing on these metrics.<h2>Would you like to join in?</h2><ol><li>Join the community on <a href="https://clojurians.slack.com/archives/C03SRH97FDK">Slack</a><li>Join the design discussions on <a href="https://github.com/jank-lang/jank/discussions">GitHub</a><li>Considering becoming a <a href="https://github.com/sponsors/jeaye">Sponsor</a></ol></div></div></section></div><footer class="footer"><div class="container"><div class="columns has-text-centered"></div><div class="container has-text-centered"><div class="content is-small"><p>Â© 2025 Jeaye Wilkerson | All rights reserved.</div></div></div></footer><noscript><p><img src="//matomo.jeaye.com/matomo.php?idsite=1&amp;rec=1"style="border:0"alt=""></p></noscript><script>for(var coll=document.getElementsByClassName("collapsible"),i=0;i<coll.length;i++)coll[i].addEventListener("click",function(){this.classList.toggle("active");var l=this.nextElementSibling;"block"===l.style.display?l.style.display="none":l.style.display="block"})</script>