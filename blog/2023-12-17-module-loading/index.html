<!DOCTYPE html><meta charset="utf-8"><meta content="width=device-width,initial-scale=1"name="viewport"><link href="/css/main.css"rel="stylesheet"><link href="/blog/feed.xml"rel="alternate"title="RSS Feed"type="application/atom+xml"><link href="https://fonts.googleapis.com"rel="preconnect"><link crossorigin href="https://fonts.gstatic.com"rel="preconnect"><link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300..700&amp;display=swap"rel="stylesheet"><title>jank development update - Load all the modules!</title><meta content="jank development update - Load all the modules!"property="og:title"><meta content="jank now supports module loading, class paths, aliases, and referred vars. It&apos;s a big leap closer to becoming your favorite Clojure dialect."property="og:description"><meta content="https://jank-lang.org/img/logo-text-dark.png"property="og:image"><link href="/img/favicon/apple-touch-icon.png"rel="apple-touch-icon"sizes="180x180"><link href="/img/favicon/32.png"rel="icon"sizes="32x32"type="image/png"><link href="/img/favicon/16.png"rel="icon"sizes="16x16"type="image/png"><link href="/img/favicon/site.webmanifest"rel="manifest"><style>.gg-bulb{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:16px;height:16px;border:2px solid;border-bottom-color:transparent;border-radius:100px}.gg-bulb::after,.gg-bulb::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-bulb::before{border-top:0;border-bottom-left-radius:18px;border-bottom-right-radius:18px;top:10px;border-bottom:2px solid transparent;box-shadow:0 5px 0 -2px,inset 2px 0 0 0,inset -2px 0 0 0,inset 0 -4px 0 -2px;width:8px;height:8px;left:2px}.gg-bulb::after{width:12px;height:2px;border-left:3px solid;border-right:3px solid;border-radius:2px;bottom:0;left:0}.gg-check-o{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:22px;height:22px;border:2px solid;border-radius:100px}.gg-check-o::after{content:"";display:block;box-sizing:border-box;position:absolute;left:3px;top:-1px;width:6px;height:10px;border-color:currentColor;border-width:0 2px 2px 0;border-style:solid;transform-origin:bottom left;transform:rotate(45deg)}.gg-comment{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:16px;border:2px solid;border-bottom:0;box-shadow:-6px 8px 0 -6px,6px 8px 0 -6px}.gg-comment::after,.gg-comment::before{content:"";display:block;box-sizing:border-box;position:absolute;width:8px}.gg-comment::before{border:2px solid;border-top-color:transparent;border-bottom-left-radius:20px;right:4px;bottom:-6px;height:6px}.gg-comment::after{height:2px;background:currentColor;box-shadow:0 4px 0 0;left:4px;top:4px}.gg-git-fork{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:2px;height:14px;background:currentColor}.gg-git-fork::after,.gg-git-fork::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-git-fork::before{border-right:2px solid;border-bottom:2px solid;border-bottom-right-radius:4px;bottom:4px;width:8px;height:6px;left:0}.gg-git-fork::after{width:4px;height:4px;background:currentColor;box-shadow:0 12px 0 0,6px 2px 0 0;border-radius:100%;left:-1px;top:-1px}.gg-heart,.gg-heart::after{border:2px solid;border-top-left-radius:100px;border-top-right-radius:100px;width:10px;height:8px;border-bottom:0}.gg-heart{box-sizing:border-box;position:relative;transform:translate(calc(-10px / 2 * var(--ggs,1)),calc(-6px / 2 * var(--ggs,1))) rotate(-45deg) scale(var(--ggs,1));display:block}.gg-heart::after,.gg-heart::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-heart::after{right:-9px;transform:rotate(90deg);top:5px}.gg-heart::before{width:11px;height:11px;border-left:2px solid;border-bottom:2px solid;left:-2px;top:3px}.gg-home{background:linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 0 bottom/4px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat right bottom/4px 2px;box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:18px;height:14px;border:2px solid;border-top:0;border-bottom:0;border-top-right-radius:3px;border-top-left-radius:3px;border-bottom-right-radius:0;border-bottom-left-radius:0;margin-bottom:-2px}.gg-home::after,.gg-home::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-home::before{border-top:2px solid;border-left:2px solid;border-top-left-radius:4px;transform:rotate(45deg);top:-5px;border-radius:3px;width:14px;height:14px;left:0}.gg-home::after{width:8px;height:10px;border:2px solid;border-radius:100px;border-bottom-left-radius:0;border-bottom-right-radius:0;border-bottom:0;left:3px;bottom:0}.gg-info{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:20px;border:2px solid;border-radius:40px}.gg-info::after,.gg-info::before{content:"";display:block;box-sizing:border-box;position:absolute;border-radius:3px;width:2px;background:currentColor;left:7px}.gg-info::after{bottom:2px;height:8px}.gg-info::before{height:2px;top:2px}.gg-link{box-sizing:border-box;position:relative;display:block;transform:rotate(-45deg) scale(var(--ggs,1));width:8px;height:2px;background:currentColor;border-radius:4px}.gg-link::after,.gg-link::before{content:"";display:block;box-sizing:border-box;position:absolute;border-radius:3px;width:8px;height:10px;border:2px solid;top:-4px}.gg-link::before{border-right:0;border-top-left-radius:40px;border-bottom-left-radius:40px;left:-6px}.gg-link::after{border-left:0;border-top-right-radius:40px;border-bottom-right-radius:40px;right:-6px}.gg-list{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:22px;height:20px;border:2px solid;border-radius:3px}.gg-list::after,.gg-list::before{content:"";display:block;box-sizing:border-box;position:absolute;width:2px;height:2px;background:currentColor;top:3px;left:3px;box-shadow:0 4px 0,0 8px 0}.gg-list::after{border-radius:3px;width:8px;left:7px}.gg-math-minus{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:16px;height:2px;background:currentColor;border-radius:10px}.gg-slack{position:relative;box-sizing:border-box;transform:scale(var(--ggs,1));display:block;width:20px;height:20px;background:linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 7px 2px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 15px 7px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 2px 10px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 10px 15px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 10px 2px/4px 5px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 5px 12px/4px 5px}.gg-slack::after,.gg-slack::before{background:currentColor;content:"";position:absolute;box-sizing:border-box;display:block;height:4px;border-radius:22px}.gg-slack::before{width:9px;top:5px;box-shadow:10px 5px 0}.gg-slack::after{width:4px;left:5px;box-shadow:-5px 10px 0,0 10px 0,0 15px 0,5px 15px 0,5px 5px 0,5px 0 0,10px 5px 0}.gg-sync{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));border-radius:40px;border:2px solid;margin:1px;border-left-color:transparent;border-right-color:transparent;width:18px;height:18px}.gg-sync::after,.gg-sync::before{content:"";display:block;box-sizing:border-box;position:absolute;width:0;height:0;border-top:4px solid transparent;border-bottom:4px solid transparent;transform:rotate(-45deg)}.gg-sync::before{border-left:6px solid;bottom:-1px;right:-3px}.gg-sync::after{border-right:6px solid;top:-1px;left:-3px}.gg-twitter{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:20px}.gg-twitter::after,.gg-twitter::before{content:"";display:block;position:absolute;box-sizing:border-box;left:4px}.gg-twitter::before{width:9px;height:14px;border-left:4px solid;border-bottom:4px solid;border-bottom-left-radius:6px;background:linear-gradient(to left,currentColor 12px,transparent 0) no-repeat center 2px/10px 4px;top:4px}.gg-twitter::after{width:4px;height:4px;background:currentColor;border-radius:20px;top:2px;box-shadow:7px 4px 0,7px 12px 0}</style><script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),(()=>{var a="//matomo.jeaye.com/";_paq.push(["setTrackerUrl",a+"matomo.php"]),_paq.push(["setSiteId","1"]);var e=(p=document).createElement("script"),p=p.getElementsByTagName("script")[0];e.async=!0,e.src=a+"matomo.js",p.parentNode.insertBefore(e,p)})()</script><div><div><nav class="navbar is-primary"><div class="container"><div class="navbar-brand"><a class="navbar-item title has-text-white"href="/blog"style="font-family:Comfortaa"><img src="/img/logo-transparent.png"style="margin-right:15px">jank blog</a></div><div class="navbar-menu is-active"><div class="navbar-end has-text-weight-semibold"><a class="navbar-item has-text-white"href="/"><span class="icon mr-1"><i class="gg-home"></i></span><strong>Home</strong></a><a class="navbar-item has-text-white"href="/blog"><span class="icon mr-1"><i class="gg-comment"></i></span><strong>Blog</strong></a><a class="navbar-item has-text-white"href="https://github.com/sponsors/jeaye"><span class="icon mr-1"style="color:#c96198"><i class="gg-heart"></i></span><strong>Sponsor</strong></a><a class="navbar-item has-text-white"href="https://github.com/jank-lang/jank"><span class="icon mr-1"><i class="gg-git-fork"></i></span><strong>Github</strong></a><a class="navbar-item has-text-white"href="https://clojurians.slack.com/archives/C03SRH97FDK"><span class="icon mr-1"><i class="gg-slack"></i></span>Slack</a><a class="navbar-item has-text-white"href="https://twitter.com/jeayewilkerson"><span class="icon mr-1"><i class="gg-twitter"></i></span>Twitter</a></div></div></div></nav></div><section class="section"><div class="container blog-container"><span class="is-size-1">jank development update - Load all the modules!</span><div class="is-size-6 has-text-weight-light">Dec 17, 2023 · <a class="has-text-weight-normal"href="https://github.com/jeaye">Jeaye Wilkerson</a></div><hr><div class="content"><p>I've been quiet for the past couple of months, finishing up this work on jank's module loading, class path handling, aliasing, and var referring. Along the way, I ran into some very interesting bugs and we're in for a treat of technical detail in this holiday edition of jank development updates! A warm shout out to my <a href="https://github.com/sponsors/jeaye">Github sponsors</a> and <a href="https://www.clojuriststogether.org/">Clojurists Together</a> for sponsoring this work.<h2>Module loading progress</h2><p>Ok, first and foremost, where is jank now with regard to module loading? I'm very pleased to say that everything I wanted to tackle this quarter has been finished and even more on top of that. There's a PR up for the full changes <a href="https://github.com/jank-lang/jank/pull/49">here</a>.<p>Let's break this down by section.<h3>Class paths</h3><p>jank traverses a user-defined class path, which supports directories and JAR files, and can use that to find modules when you use <code>require</code> and friends. This is specifically designed to be compatible with the JVM, so once we hook in Leiningen or Clojure CLI, your existing dependency management should work just fine.<h3>Necessary core functions</h3><p>The following functions have all been implemented, which were required for module loading:<ul><li><code>require</code><li><code>alias</code><li><code>use</code><li><code>refer</code><li><code>load</code></ul><p>These take into account modules that are already loaded, flags for things like reloading, excluding, etc. For most use cases, they're at functional parity with Clojure on the happy path. Error handling will improve once I have some better mechanisms for it.<p>Still, that's not a very big list of functions, I know. How about this one?<ul><li><code>compile</code><li><code>create-ns</code><li><code>find-ns</code><li><code>remove-ns</code><li><code>the-ns</code><li><code>ns-name</code><li><code>ns-map</code><li><code>ns-publics</code><li><code>var?</code><li><code>var-get</code><li><code>keys</code> (note - not using a custom seq yet)<li><code>vals</code> (note - not using a custom seq yet)<li><code>name</code><li><code>namespace</code><li><code>subs</code><li><code>gensym</code><li><code>concat</code><li><code>contains?</code><li><code>find</code><li><code>select-keys</code><li><code>map</code> (note - not lazy yet, no transducers)<li><code>mapv</code> (note - not lazy yet, no transducers)<li><code>mapcat</code> (note - not lazy yet, no transducers)<li><code>filter</code> (note - not lazy yet, no transducers)<li><code>complement</code><li><code>remove</code><li><code>set?</code><li><code>set</code><li><code>vector</code><li><code>doseq</code> (note - not supporting fancy <code>for</code> features yet)<li><code>list*</code><li><code>apply</code><li><code>some</code><li><code>not-any?</code><li><code>not=</code><li><code>symbol</code><li><code>var?</code><li><code>cond</code><li><code>and</code><li><code>or</code><li><code>ns</code></ul><p>All of these were needed by some of the above necessary functions, so I implemented them as much as possible. Most of them have complete functional parity with Clojure, but a few have interim implementations, especially since jank doesn't yet have have an equivalent object type to Clojure JVM's <code>LazySeq</code>. Still, jank feels, and looks, more and more like a proper Clojure every day.<h3>(Bonus) Initial AOT compilation</h3><p>You may have noticed, in that list, that <code>compile</code> has been implemented. This is an initial step toward AOT compilation and it compiles jank files into C++ files on the class path. Those can then be loaded in lieu of the jank files for a performance win. I also added a CMake job to jank's build system to build the jank Clojure libs along with the compiler, so we can always have those pre-compiled and also always know they actually compile.<p>I'm currently working with the Cling developers to get support added to Cling for jank to pre-compile these C++ files into a closer equivalent to JVM class files. In my local testing, the startup time improvements by doing this were 10x. I'll have more info on this once the work picks up.<h3>(Bonus) CLI argument parsing</h3><p>In order to support things like user-defined class paths, I've added a proper CLI arg parser to jank. You can see the current options in the help output here:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#a6e22e">❯</span><span style="color:#e6db74"> ./build/jank</span><span style="color:#ae81ff"> -h</span></span>
<span class="line"><span style="color:#a6e22e">jank</span><span style="color:#e6db74"> compiler</span></span>
<span class="line"><span style="color:#a6e22e">Usage:</span><span style="color:#e6db74"> ./build/jank</span><span style="color:#f8f8f2"> [OPTIONS] SUBCOMMAND</span></span>
<span class="line"></span>
<span class="line"><span style="color:#a6e22e">Options:</span></span>
<span class="line"><span style="color:#a6e22e">  -h,--help</span><span style="color:#e6db74">                   Print</span><span style="color:#e6db74"> this</span><span style="color:#e6db74"> help</span><span style="color:#e6db74"> message</span><span style="color:#e6db74"> and</span><span style="color:#e6db74"> exit</span></span>
<span class="line"><span style="color:#a6e22e">  --class-path</span><span style="color:#e6db74"> TEXT</span><span style="color:#e6db74">           A</span><span style="color:#e6db74"> :</span><span style="color:#e6db74"> separated</span><span style="color:#e6db74"> list</span><span style="color:#e6db74"> of</span><span style="color:#e6db74"> directories,</span><span style="color:#e6db74"> JAR</span><span style="color:#e6db74"> files,</span><span style="color:#e6db74"> and</span><span style="color:#e6db74"> ZIP</span><span style="color:#e6db74"> files</span><span style="color:#e6db74"> to</span><span style="color:#e6db74"> search</span><span style="color:#e6db74"> for</span><span style="color:#e6db74"> modules</span></span>
<span class="line"><span style="color:#a6e22e">  --output-dir</span><span style="color:#e6db74"> TEXT</span><span style="color:#e6db74">           The</span><span style="color:#e6db74"> base</span><span style="color:#e6db74"> directory</span><span style="color:#e6db74"> where</span><span style="color:#e6db74"> compiled</span><span style="color:#e6db74"> modules</span><span style="color:#e6db74"> are</span><span style="color:#e6db74"> written</span></span>
<span class="line"><span style="color:#a6e22e">  --profile</span><span style="color:#e6db74">                   Enable</span><span style="color:#e6db74"> compiler</span><span style="color:#e6db74"> and</span><span style="color:#e6db74"> runtime</span><span style="color:#e6db74"> profiling</span></span>
<span class="line"><span style="color:#a6e22e">  --profile-output</span><span style="color:#e6db74"> TEXT</span><span style="color:#e6db74">       The</span><span style="color:#e6db74"> file</span><span style="color:#e6db74"> to</span><span style="color:#e6db74"> write</span><span style="color:#e6db74"> profile</span><span style="color:#e6db74"> entries</span><span style="color:#f8f8f2"> (will </span><span style="color:#e6db74">be</span><span style="color:#e6db74"> overwritten</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#a6e22e">  --gc-incremental</span><span style="color:#e6db74">            Enable</span><span style="color:#e6db74"> incremental</span><span style="color:#e6db74"> GC</span><span style="color:#e6db74"> collection</span></span>
<span class="line"><span style="color:#a6e22e">  -O,--optimization</span><span style="color:#e6db74"> INT:INT</span><span style="color:#e6db74"> in</span><span style="color:#f8f8f2"> [0 </span><span style="color:#e6db74">-</span><span style="color:#e6db74"> 3]</span></span>
<span class="line"><span style="color:#a6e22e">                              The</span><span style="color:#e6db74"> optimization</span><span style="color:#e6db74"> level</span><span style="color:#e6db74"> to</span><span style="color:#e6db74"> use</span></span>
<span class="line"></span>
<span class="line"><span style="color:#a6e22e">Subcommands:</span></span>
<span class="line"><span style="color:#a6e22e">  run</span><span style="color:#e6db74">                         Load</span><span style="color:#e6db74"> and</span><span style="color:#e6db74"> run</span><span style="color:#e6db74"> a</span><span style="color:#e6db74"> file</span></span>
<span class="line"><span style="color:#a6e22e">  compile</span><span style="color:#e6db74">                     Compile</span><span style="color:#e6db74"> a</span><span style="color:#e6db74"> file</span><span style="color:#e6db74"> and</span><span style="color:#e6db74"> its</span><span style="color:#e6db74"> dependencies</span></span>
<span class="line"><span style="color:#a6e22e">  repl</span><span style="color:#e6db74">                        Start</span><span style="color:#e6db74"> up</span><span style="color:#e6db74"> a</span><span style="color:#e6db74"> terminal</span><span style="color:#e6db74"> REPL</span><span style="color:#e6db74"> and</span><span style="color:#e6db74"> optional</span><span style="color:#e6db74"> server</span></span></code></pre><p>Each subcommand has its own help output, too. Speaking of subcommands, however, jank now has a <code>repl</code> subcommand which spins up a terminal REPL client with readline enabled for (single session) history and improved editing. This has been very handy for me as I'm testing out new things and was something that just came naturally after implementing the CLI argument parsing.<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">❯ ./build/jank repl</span></span>
<span class="line"><span style="color:#f8f8f2">&gt; </span><span style="color:#fd971f">(</span><span style="color:#fb4934;font-weight:700">ns</span><span style="color:#f8f8f2"> foo.bar</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#ae81ff">nil</span></span>
<span class="line"><span style="color:#f8f8f2">&gt; *ns*</span></span>
<span class="line"><span style="color:#f8f8f2">foo.bar</span></span>
<span class="line"><span style="color:#f8f8f2">&gt; </span><span style="color:#fd971f">(</span><span style="color:#fb4934;font-weight:700">def</span><span style="color:#f8f8f2"> wow </span><span style="color:#e6db74">&quot;WOW!&quot;</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#f8f8f2">#'foo.bar/wow</span></span>
<span class="line"><span style="color:#f8f8f2">&gt; </span><span style="color:#fd971f">(</span><span style="color:#fb4934;font-weight:700">def</span><span style="color:#f8f8f2"> nice </span><span style="color:#e6db74">&quot;NICE!&quot;</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#f8f8f2">#'foo.bar/nice</span></span>
<span class="line"><span style="color:#f8f8f2">&gt; </span><span style="color:#fd971f">(</span><span style="color:#fb4934;font-weight:700">ns</span><span style="color:#f8f8f2"> main</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#ae81ff">nil</span></span>
<span class="line"><span style="color:#f8f8f2">&gt; *ns*</span></span>
<span class="line"><span style="color:#f8f8f2">main</span></span>
<span class="line"><span style="color:#f8f8f2">&gt; </span><span style="color:#fd971f">(</span><span style="color:#a6e22e">refer</span><span style="color:#f8f8f2"> 'foo.bar </span><span style="color:#819aff">:only</span><span style="color:#f8f8f2"> '</span><span style="color:#fd971f">[</span><span style="color:#f8f8f2">wow</span><span style="color:#fd971f">])</span></span>
<span class="line"><span style="color:#ae81ff">nil</span></span>
<span class="line"><span style="color:#f8f8f2">&gt; wow</span></span>
<span class="line"><span style="color:#f8f8f2">WOW!</span></span>
<span class="line"><span style="color:#f8f8f2">&gt; </span><span style="color:#fd971f">(</span><span style="color:#a6e22e">alias</span><span style="color:#f8f8f2"> 'fb 'foo.bar</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#ae81ff">nil</span></span>
<span class="line"><span style="color:#f8f8f2">&gt; fb/nice</span></span>
<span class="line"><span style="color:#f8f8f2">NICE!</span></span>
<span class="line"><span style="color:#f8f8f2">&gt; </span><span style="color:#fd971f">(</span><span style="color:#fb4934;font-weight:700">ns</span><span style="color:#f8f8f2"> omg.wow </span><span style="color:#fd971f">(</span><span style="color:#819aff">:use</span><span style="color:#fd971f"> [</span><span style="color:#f8f8f2">foo.bar </span><span style="color:#819aff">:exclude</span><span style="color:#fd971f"> [</span><span style="color:#f8f8f2">wow</span><span style="color:#fd971f">]]))</span></span>
<span class="line"><span style="color:#ae81ff">nil</span></span>
<span class="line"><span style="color:#f8f8f2">&gt; *ns*</span></span>
<span class="line"><span style="color:#f8f8f2">omg.wow</span></span>
<span class="line"><span style="color:#f8f8f2">&gt; nice</span></span>
<span class="line"><span style="color:#f8f8f2">NICE!</span></span>
<span class="line"><span style="color:#f8f8f2">&gt; </span><span style="color:#fd971f">(</span><span style="color:#a6e22e">native/raw</span><span style="color:#e6db74"> &quot;*((char*)0) = 0;&quot;</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#f8f8f2">Segmentation fault </span><span style="color:#fd971f">(</span><span style="color:#a6e22e">core</span><span style="color:#f8f8f2"> dumped</span><span style="color:#fd971f">)</span></span></code></pre><h3>(Bonus) Maps, sets, keywords as functions</h3><p>As part of implementing all of the new core functions this quarter, I also tackled these particular objects which behave as functions. Fortunately, because of the new object model design, these objects can have this behavior without the need for dynamic dispatch!<h3>There will be bugs</h3><p>jank is still pre-alpha software. I have an ever growing test suite, but no battle testing yet. As I develop more functionality, I find more issues and introduce more yet. That will remain the case until development can settle down and stable APIs can be decided. jank still isn't ready to compile most Clojure programs, since it lacks support for some basic features like destructuring, lazy sequences, and even doc strings. While we're talking about bugs, though, and since I've shown everything else I've built this quarter, let me tell you about such an interesting bug I found and how I fixed it.<h2>Variadic argument matching bug</h2><p>I fixed a few interesting bugs in the past couple of months, but this one was the most intriguing by far. So, the problem showed up in this case:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#fd971f">(</span><span style="color:#fb4934;font-weight:700">defn</span><span style="color:#f8f8f2"> ambiguous</span></span>
<span class="line"><span style="color:#fd971f">  ([</span><span style="color:#f8f8f2">a</span><span style="color:#fd971f">]</span></span>
<span class="line"><span style="color:#819aff">   :fixed</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">  ([</span><span style="color:#f8f8f2">a &amp; args</span><span style="color:#fd971f">]</span></span>
<span class="line"><span style="color:#819aff">   :variadic</span><span style="color:#fd971f">))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#fd971f">(</span><span style="color:#a6e22e">ambiguous</span><span style="color:#819aff"> :a</span><span style="color:#fd971f">)</span><span style="color:#88846f"> ; =&gt; should be :fixed</span></span></code></pre><p>What jank was trying to do was call the variadic arity, with an empty seq for <code>args</code>, rather than to call the fixed arity. This is because both of them require one fixed argument first and the information I was storing for each function object was the required fixed args prior to variadic arg packing.<p>The equivalent function in Clojure JVM is <code>RestFn.getRequiredArity</code>, which returns the required fixed position arguments prior to the packed args. However, where Clojure JVM differs from jank is that Clojure uses dynamic dispatch to solve this ambiguity whereas jank does its own fixed vs variadic overload matching, for performance reasons.<p>To actually solve this problem, we need to know three things:<ol><li>Is the function variadic?<li>Is there an ambiguous fixed overload?<li>How many fixed arguments are required before the packed args?</ol><p>We cannot perform the correct call without <em>all</em> of this information. Also, function calls in a functional programming language like Clojure are on the hottest of hot code paths, so I can't exactly add two more virtual functions to jank's <code>callable</code> interface to get this data. In truth, even keeping one function but putting all of this data in a struct proved too much of an impact on the performance. Thus, we need to encode the data more compactly.<p>jank now packs all of this into a single byte. Questions 1 and 2 each get a high bit and question 3 gets the 6 remaining bits (of which it uses 4) to store the fixed arg count. So, this byte for our <code>ambiguous</code> function above would look like this:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#ae81ff">1</span><span style="color:#ae81ff">  1</span><span style="color:#ae81ff">  0</span><span style="color:#ae81ff">  0</span><span style="color:#ae81ff">  0</span><span style="color:#ae81ff">  0</span><span style="color:#ae81ff">  0</span><span style="color:#ae81ff">  1</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">^</span><span style="color:#fb4934;font-weight:700">  ^</span><span style="color:#fb4934;font-weight:700">  ^---------------</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">|</span><span style="color:#fb4934;font-weight:700">  |</span><span style="color:#fb4934;font-weight:700">  |</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">|</span><span style="color:#fb4934;font-weight:700">  |</span><span style="color:#88846f">  /* How many fixed arguments are required before the packed args? */</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">|</span><span style="color:#88846f">  /* Is there an ambiguous overload? */</span></span>
<span class="line"><span style="color:#88846f">/* Is the function variadic? */</span></span></code></pre><p>From there, when we use it, we disable the bit for question 2 and we <code>switch</code> on the rest. This allows us to do a <code>O(1)</code> jump on the combination of whether it's variadic and the required fixed args. Finally, we only need the question 2 bit to disambiguate one branch of each switch, which is the branch equal to however many arguments we received.<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#a6e22e">object_ptr</span><span style="color:#a6e22e"> dynamic_call</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">object_ptr</span><span style="color:#f8f8f2"> const </span><span style="color:#fd971f;font-style:italic">source</span><span style="color:#f8f8f2">, </span><span style="color:#a6e22e">object_ptr</span><span style="color:#f8f8f2"> const </span><span style="color:#fd971f;font-style:italic">a1</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  return</span><span style="color:#f8f8f2"> visit_object</span></span>
<span class="line"><span style="color:#fd971f">  (</span></span>
<span class="line"><span style="color:#f8f8f2">    [</span><span style="color:#fb4934;font-weight:700">=</span><span style="color:#f8f8f2">](</span><span style="color:#66d9ef;font-style:italic">auto</span><span style="color:#f8f8f2"> const </span><span style="color:#fd971f;font-style:italic">typed_source</span><span style="color:#f8f8f2">) -&gt; </span><span style="color:#66d9ef;font-style:italic">object_ptr</span></span>
<span class="line"><span style="color:#fd971f">    {</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      using</span><span style="color:#a6e22e"> T</span><span style="color:#fb4934;font-weight:700"> =</span><span style="color:#fb4934;font-weight:700"> typename</span><span style="color:#66d9ef;font-style:italic"> decltype</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">typed_source</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">::value_type;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      if</span><span style="color:#f8f8f2"> constexpr</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">function_like</span><span style="color:#fb4934;font-weight:700">&lt;</span><span style="color:#f8f8f2">T</span><span style="color:#fb4934;font-weight:700">&gt;</span><span style="color:#fb4934;font-weight:700"> ||</span><span style="color:#a6e22e"> std</span><span style="color:#f8f8f2">::is_base_of_v</span><span style="color:#fb4934;font-weight:700">&lt;</span><span style="color:#f8f8f2">callable, T</span><span style="color:#fb4934;font-weight:700">&gt;</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">      {</span></span>
<span class="line"><span style="color:#88846f">        /* This is the whole byte, answering all three questions. */</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">        auto</span><span style="color:#f8f8f2"> const </span><span style="color:#a6e22e">arity_flags</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">typed_source-&gt;</span><span style="color:#a6e22e">get_arity_flags</span><span style="color:#fd971f">())</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#88846f">        /* We strip out the bit for ambiguous checking and switch on it. */</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">        auto</span><span style="color:#f8f8f2"> const </span><span style="color:#a6e22e">mask</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">callable</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">extract_variadic_arity_mask</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">arity_flags</span><span style="color:#fd971f">))</span><span style="color:#f8f8f2">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">        /* We're matching on variadic + required arg position. */</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">        switch</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">mask</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">        {</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">          case</span><span style="color:#a6e22e"> callable</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">mask_variadic_arity</span><span style="color:#fd971f">(</span><span style="color:#ae81ff">0</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">:</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">            return</span><span style="color:#f8f8f2"> typed_source-&gt;</span><span style="color:#a6e22e">call</span><span style="color:#fd971f">(</span><span style="color:#a6e22e">make_box</span><span style="color:#fd971f">&lt;</span><span style="color:#a6e22e">obj</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">native_array_sequence</span><span style="color:#fd971f">&gt;(</span><span style="color:#f8f8f2">a1</span><span style="color:#fd971f">))</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">          case</span><span style="color:#a6e22e"> callable</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">mask_variadic_arity</span><span style="color:#fd971f">(</span><span style="color:#ae81ff">1</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">:</span></span>
<span class="line"><span style="color:#88846f">            /* Only in the case where the arg count == the required arity do we</span></span>
<span class="line"><span style="color:#88846f">               check the extra bit in the flags. */</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">            if</span><span style="color:#fd971f">(</span><span style="color:#fb4934;font-weight:700">!</span><span style="color:#a6e22e">callable</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">is_variadic_ambiguous</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">arity_flags</span><span style="color:#fd971f">))</span></span>
<span class="line"><span style="color:#fd971f">            {</span><span style="color:#fb4934;font-weight:700"> return</span><span style="color:#f8f8f2"> typed_source-&gt;</span><span style="color:#a6e22e">call</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">a1, </span><span style="color:#a6e22e">obj</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">nil</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">nil_const</span><span style="color:#fd971f">())</span><span style="color:#f8f8f2">; </span><span style="color:#fd971f">}</span></span>
<span class="line"><span style="color:#88846f">            /* We're falling through! */</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">          default</span><span style="color:#f8f8f2">:</span></span>
<span class="line"><span style="color:#88846f">            /* The default case is not variadic. */</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">            return</span><span style="color:#f8f8f2"> typed_source-&gt;</span><span style="color:#a6e22e">call</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">a1</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">        }</span></span>
<span class="line"><span style="color:#fd971f">      }</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">      else</span></span>
<span class="line"><span style="color:#fd971f">      {</span><span style="color:#88846f"> /* ... redacted error handling ... */</span><span style="color:#fd971f"> }</span></span>
<span class="line"><span style="color:#fd971f">    }</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#f8f8f2">    source</span></span>
<span class="line"><span style="color:#fd971f">  )</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">}</span></span></code></pre><p>The special case, which needs to check the ambiguous flag, incurs a performance cost, due to the if. Every other case is unaffected. This was a challenge to wrap my head around at first, but after I wrote out all the things I need to know, as well as a test suite for each of the cases, I could work toward a solution which addressed everything.<h2>What's next?</h2><p>Firstly, dynamic vars. Once those are implemented, I'll need to go through all of the different parts of the compiler and runtime to start filling in vars. This will allow everything from improved error messages by tracking file/line/function to cyclical dependency checks on module loading.<p>Also, in order for jank to operate alongside other Clojure dialects, we'll need to support reader conditionals on the <code>:jank</code> key. Currently, jank doesn't support any reader macros, so getting that system going will open up the door to things like <code>#()</code> and <code>#{}</code> being supported.<p>Finally, I'll be improving the interop interpolation syntax to be consistent with ClojureScript, adding meta hint support, and more. Stay tuned!<h2>Would you like to join in?</h2><ol><li>Join the community on <a href="https://clojurians.slack.com/archives/C03SRH97FDK">Slack</a><li>Join the design discussions or pick up a ticket on <a href="https://github.com/jank-lang/jank">GitHub</a><li>Considering becoming a <a href="https://github.com/sponsors/jeaye">Sponsor</a> <span class="icon mr-1"style="color:#c96198"><i class="gg-heart"></i></span><li><strong>Hire me full-time to work on jank!</strong></ol></div></div></section></div><footer class="footer"><div class="container"><div class="columns has-text-centered"></div><div class="container has-text-centered"><div class="content is-small"><p>© 2025 Jeaye Wilkerson | All rights reserved.</div></div></div></footer><noscript><p><img src="//matomo.jeaye.com/matomo.php?idsite=1&amp;rec=1"style="border:0"alt=""></p></noscript><script>for(var coll=document.getElementsByClassName("collapsible"),i=0;i<coll.length;i++)coll[i].addEventListener("click",function(){this.classList.toggle("active");var l=this.nextElementSibling;"block"===l.style.display?l.style.display="none":l.style.display="block"})</script>