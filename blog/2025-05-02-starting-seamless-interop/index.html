<!DOCTYPE html><meta charset="utf-8"><meta content="width=device-width,initial-scale=1"name="viewport"><link href="/css/main.css"rel="stylesheet"><link href="/blog/feed.xml"rel="alternate"title="RSS Feed"type="application/atom+xml"><title>Starting on seamless C++ interop in jank</title><meta content="Starting on seamless C++ interop in jank"property="og:title"><meta content="jank is the first Lisp to be able to seamlessly reach into C++. Check it out!"property="og:description"><meta content="https://jank-lang.org/img/logo-text-dark.png"property="og:image"><link href="/img/favicon/apple-touch-icon.png"rel="apple-touch-icon"sizes="180x180"><link href="/img/favicon/32.png"rel="icon"sizes="32x32"type="image/png"><link href="/img/favicon/16.png"rel="icon"sizes="16x16"type="image/png"><link href="/img/favicon/site.webmanifest"rel="manifest"><style>.gg-bulb{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:16px;height:16px;border:2px solid;border-bottom-color:transparent;border-radius:100px}.gg-bulb::after,.gg-bulb::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-bulb::before{border-top:0;border-bottom-left-radius:18px;border-bottom-right-radius:18px;top:10px;border-bottom:2px solid transparent;box-shadow:0 5px 0 -2px,inset 2px 0 0 0,inset -2px 0 0 0,inset 0 -4px 0 -2px;width:8px;height:8px;left:2px}.gg-bulb::after{width:12px;height:2px;border-left:3px solid;border-right:3px solid;border-radius:2px;bottom:0;left:0}.gg-check-o{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:22px;height:22px;border:2px solid;border-radius:100px}.gg-check-o::after{content:"";display:block;box-sizing:border-box;position:absolute;left:3px;top:-1px;width:6px;height:10px;border-color:currentColor;border-width:0 2px 2px 0;border-style:solid;transform-origin:bottom left;transform:rotate(45deg)}.gg-comment{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:16px;border:2px solid;border-bottom:0;box-shadow:-6px 8px 0 -6px,6px 8px 0 -6px}.gg-comment::after,.gg-comment::before{content:"";display:block;box-sizing:border-box;position:absolute;width:8px}.gg-comment::before{border:2px solid;border-top-color:transparent;border-bottom-left-radius:20px;right:4px;bottom:-6px;height:6px}.gg-comment::after{height:2px;background:currentColor;box-shadow:0 4px 0 0;left:4px;top:4px}.gg-git-fork{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:2px;height:14px;background:currentColor}.gg-git-fork::after,.gg-git-fork::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-git-fork::before{border-right:2px solid;border-bottom:2px solid;border-bottom-right-radius:4px;bottom:4px;width:8px;height:6px;left:0}.gg-git-fork::after{width:4px;height:4px;background:currentColor;box-shadow:0 12px 0 0,6px 2px 0 0;border-radius:100%;left:-1px;top:-1px}.gg-heart,.gg-heart::after{border:2px solid;border-top-left-radius:100px;border-top-right-radius:100px;width:10px;height:8px;border-bottom:0}.gg-heart{box-sizing:border-box;position:relative;transform:translate(calc(-10px / 2 * var(--ggs,1)),calc(-6px / 2 * var(--ggs,1))) rotate(-45deg) scale(var(--ggs,1));display:block}.gg-heart::after,.gg-heart::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-heart::after{right:-9px;transform:rotate(90deg);top:5px}.gg-heart::before{width:11px;height:11px;border-left:2px solid;border-bottom:2px solid;left:-2px;top:3px}.gg-home{background:linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 0 bottom/4px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat right bottom/4px 2px;box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:18px;height:14px;border:2px solid;border-top:0;border-bottom:0;border-top-right-radius:3px;border-top-left-radius:3px;border-bottom-right-radius:0;border-bottom-left-radius:0;margin-bottom:-2px}.gg-home::after,.gg-home::before{content:"";display:block;box-sizing:border-box;position:absolute}.gg-home::before{border-top:2px solid;border-left:2px solid;border-top-left-radius:4px;transform:rotate(45deg);top:-5px;border-radius:3px;width:14px;height:14px;left:0}.gg-home::after{width:8px;height:10px;border:2px solid;border-radius:100px;border-bottom-left-radius:0;border-bottom-right-radius:0;border-bottom:0;left:3px;bottom:0}.gg-info{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:20px;border:2px solid;border-radius:40px}.gg-info::after,.gg-info::before{content:"";display:block;box-sizing:border-box;position:absolute;border-radius:3px;width:2px;background:currentColor;left:7px}.gg-info::after{bottom:2px;height:8px}.gg-info::before{height:2px;top:2px}.gg-link{box-sizing:border-box;position:relative;display:block;transform:rotate(-45deg) scale(var(--ggs,1));width:8px;height:2px;background:currentColor;border-radius:4px}.gg-link::after,.gg-link::before{content:"";display:block;box-sizing:border-box;position:absolute;border-radius:3px;width:8px;height:10px;border:2px solid;top:-4px}.gg-link::before{border-right:0;border-top-left-radius:40px;border-bottom-left-radius:40px;left:-6px}.gg-link::after{border-left:0;border-top-right-radius:40px;border-bottom-right-radius:40px;right:-6px}.gg-list{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:22px;height:20px;border:2px solid;border-radius:3px}.gg-list::after,.gg-list::before{content:"";display:block;box-sizing:border-box;position:absolute;width:2px;height:2px;background:currentColor;top:3px;left:3px;box-shadow:0 4px 0,0 8px 0}.gg-list::after{border-radius:3px;width:8px;left:7px}.gg-math-minus{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:16px;height:2px;background:currentColor;border-radius:10px}.gg-slack{position:relative;box-sizing:border-box;transform:scale(var(--ggs,1));display:block;width:20px;height:20px;background:linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 7px 2px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 15px 7px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 2px 10px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 10px 15px/2px 2px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 10px 2px/4px 5px,linear-gradient(to left,currentColor 5px,transparent 0) no-repeat 5px 12px/4px 5px}.gg-slack::after,.gg-slack::before{background:currentColor;content:"";position:absolute;box-sizing:border-box;display:block;height:4px;border-radius:22px}.gg-slack::before{width:9px;top:5px;box-shadow:10px 5px 0}.gg-slack::after{width:4px;left:5px;box-shadow:-5px 10px 0,0 10px 0,0 15px 0,5px 15px 0,5px 5px 0,5px 0 0,10px 5px 0}.gg-sync{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));border-radius:40px;border:2px solid;margin:1px;border-left-color:transparent;border-right-color:transparent;width:18px;height:18px}.gg-sync::after,.gg-sync::before{content:"";display:block;box-sizing:border-box;position:absolute;width:0;height:0;border-top:4px solid transparent;border-bottom:4px solid transparent;transform:rotate(-45deg)}.gg-sync::before{border-left:6px solid;bottom:-1px;right:-3px}.gg-sync::after{border-right:6px solid;top:-1px;left:-3px}.gg-twitter{box-sizing:border-box;position:relative;display:block;transform:scale(var(--ggs,1));width:20px;height:20px}.gg-twitter::after,.gg-twitter::before{content:"";display:block;position:absolute;box-sizing:border-box;left:4px}.gg-twitter::before{width:9px;height:14px;border-left:4px solid;border-bottom:4px solid;border-bottom-left-radius:6px;background:linear-gradient(to left,currentColor 12px,transparent 0) no-repeat center 2px/10px 4px;top:4px}.gg-twitter::after{width:4px;height:4px;background:currentColor;border-radius:20px;top:2px;box-shadow:7px 4px 0,7px 12px 0}</style><script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),(()=>{var a="//matomo.jeaye.com/";_paq.push(["setTrackerUrl",a+"matomo.php"]),_paq.push(["setSiteId","1"]);var e=(p=document).createElement("script"),p=p.getElementsByTagName("script")[0];e.async=!0,e.src=a+"matomo.js",p.parentNode.insertBefore(e,p)})()</script><div><div><nav class="navbar is-primary"><div class="container"><div class="navbar-brand"><a class="navbar-item title has-text-white"href="/blog"style="font-family:Comfortaa"><img src="/img/logo-transparent.png"style="margin-right:15px">jank blog</a></div><div class="navbar-menu is-active"><div class="navbar-end has-text-weight-semibold"><a class="navbar-item has-text-white"href="/"><span class="icon mr-1"><i class="gg-home"></i></span><strong>Home</strong></a><a class="navbar-item has-text-white"href="/blog"><span class="icon mr-1"><i class="gg-comment"></i></span><strong>Blog</strong></a><a class="navbar-item has-text-white"href="https://github.com/sponsors/jeaye"><span class="icon mr-1"style="color:#c96198"><i class="gg-heart"></i></span><strong>Sponsor</strong></a><a class="navbar-item has-text-white"href="https://github.com/jank-lang/jank"><span class="icon mr-1"><i class="gg-git-fork"></i></span><strong>Github</strong></a><a class="navbar-item has-text-white"href="https://clojurians.slack.com/archives/C03SRH97FDK"><span class="icon mr-1"><i class="gg-slack"></i></span>Slack</a><a class="navbar-item has-text-white"href="https://twitter.com/jeayewilkerson"><span class="icon mr-1"><i class="gg-twitter"></i></span>Twitter</a></div></div></div></nav></div><section class="section"><div class="container blog-container"><span class="is-size-1">Starting on seamless C++ interop in jank</span><div class="is-size-6 has-text-weight-light">May 02, 2025 · <a class="has-text-weight-normal"href="https://github.com/jeaye">Jeaye Wilkerson</a></div><hr><div class="content"><p>Howdy, folks! We're one month into me working on jank's seamless C++ interop and I have some exciting progress to share. This quarter's work is being sponsored not only by all of my individual Github sponsors, but also by Clojurists Together. Thank you for the support!<h2>Seamless interop</h2><p>Clojure's interop with Java isn't sold as being &quot;seamless&quot;, but it really is. Using Clojure's existing syntax, we can create Java objects, access their members, call their methods, and there's no ceremony involved. This is a super power of Clojure and I think it's critical that each Clojure dialect reproduces it for its host. In fact, we've seen how this can impact the user experience, in earlier ClojureScript days. For jank, I want to do this right from the beginning.<p>However, jank's host is C++. How many statically typed languages can you name which have seamless C++ interop? Only <a href="https://www.swift.org/documentation/cxx-interop/">Swift</a> comes to mind. Even worse, doing this from a dynamically typed and JIT compiled language? This is new ground we're treading, alongside <a href="https://cppyy.readthedocs.io/en/latest/">cpppy</a>. I'll confidently say jank is the first Lisp to ever do this. So, one month in, what can jank do?<h2>C++ values</h2><p>Let's start with a simple example. We'll say there's an existing global C++ value which we want to access.<p><p><div class="wide-figure"><figure><img src="/img/blog/2025-05-02-starting-seamless-interop/npos.png"></figure></div><p><p>The <a href="https://en.cppreference.com/w/cpp/string/basic_string/npos">npos</a> of C++'s string is used to represent the index of something which isn't present. Its value is <code>-1</code>, but since it's in an unsigned type, we get the largest possible value (all bits are <code>1</code>). However, jank's integral type is an <code>i64</code>, so we end up keeping the signage.<p>Now, in order to access this from jank, we need to first include the C++ standard <code>&lt;string&gt;</code> header. We use <code>cpp/raw</code> for this, which allows us to globally issue C++ declarations. We can do this from anywhere and it will only affect the global C++ JIT compiler. jank also supports <code>-I</code> and <code>-l</code> CLI flags for locating headers and linking to libs, in case we want to use our own C++ libs.<p>Once we've included this header, we have access to all declarations and definitions within it. The next line, <code>cpp/std.string.npos</code> accesses the value <code>std::string::npos</code>. We use a <code>.</code> instead of <code>::</code> here since the latter wouldn't be valid Clojure. Note, also, everything is still under the <code>cpp/</code> namespace, which is a special namespace reserved for C++ interop in jank.<p>However, once we've accessed the value, we need to return it through the jank runtime so we can show the value in the REPL client. This is where some more magic happens. jank's runtime works with its own object model. There is a &quot;base&quot; object of sorts and then a bunch of typed objects. However, <code>std::string::npos</code> isn't one of those. It's just a <code>size_t</code>, which is a native <code>unsigned long</code>. jank has a conversion <a href="https://www.internalpointers.com/post/quick-primer-type-traits-modern-cpp">trait</a> which can be specialized for any type, to provide conversions to/from jank's objects. By default, jank has some built-in type conversions already specialized.<p>When the jank compiler sees we're trying to return a <code>size_t</code>, it'll try to JIT instantiate the <code>jank::runtime::convert&lt;size_t&gt;</code> template, to see if we have a valid conversion trait. If that instantiation fails, we get a compiler error. For example, there is no conversion for this <code>foo</code> type:<p><p><div class="wide-figure"><figure><img src="/img/blog/2025-05-02-starting-seamless-interop/invalid-conversion.png"></figure></div><p><p>So, accessing a single value from the REPL is not as simple as it may seem. This is easier in Clojure, since both Clojure and Java share the same base <code>Object</code>. Since every class instance is an <code>Object</code>, we can freely pass any Java value through any Clojure function or store it in a Clojure data structure. In the native world, we don't have such niceties. Each top-level type is concretely separate. This means that, in order to cross function boundaries, conversions or type-erasure must be done.<h2>Constructors</h2><p>In jank, we can now construct stack-allocated C++ objects directly. There is no additional allocation, boxing, or conversions done by the jank compiler unless that value is returned from a jank function or passed as a parameter to a jank function.<p><p><div class="wide-figure"><figure><img src="/img/blog/2025-05-02-starting-seamless-interop/ctor-1.png"></figure></div><p><p>In this case, there are three different constructor overloads for <code>bar</code>.<ul><li><code>bar(bar const &amp;)</code> =&gt; The default copy constructor.<li><code>bar(bar &amp;&amp;)</code> =&gt; The default move constructor.<li><code>bar(size_t)</code> =&gt; Our user-defined constructor.</ul><p>When we try to create <code>b</code>, we need to match the correct overload, given the arguments. jank will determine the argument types, find all of the overloads, and them ask Clang to find the best match. Clang will consider the argument types, implicit conversions, default arguments, etc. However, let's say we provide a jank value instead of <code>std::string::npos</code>.<p><p><div class="wide-figure"><figure><img src="/img/blog/2025-05-02-starting-seamless-interop/ctor-2.png"></figure></div><p><p>In this case, <code>17</code> is a <code>jank::runtime::object_ref</code>. Clang will not find any matching constructor overload. Instead of giving up, jank will do a second pass, where it checks each argument type to see if an automatic jank conversion can happen. If multiple overloads can support a jank conversion for the same argument, we have an ambiguity and jank will fail. However, if we can narrow down a matching overload, jank will choose that and automatically do the conversions for us.<h2>Casting</h2><p>Finally, I've implemented casting so we can explicitly cast a value to another type. This works both as the equivalent of a C++ <code>static_cast</code> and also as a way of opting into jank's conversion trait. A helpful trick here is to cast in order to disambiguate an overloaded call. Let's consider this example. Note that I haven't actually built out the error messages for these yet, so it shows as an internal analysis error and the message itself is lacking helpful details. It's sufficient for me to know that the right error has been triggered, though.<p><p><div class="wide-figure"><figure><img src="/img/blog/2025-05-02-starting-seamless-interop/cast-1.png"></figure></div><p><p>We can see that <code>bar</code> has two user-defined constructors. One takes a <code>float</code> and another takes a <code>size_t</code>. Both of those are already specialized for jank's conversion trait, so jank can't know which constructor to choose. Now, if we add a cast, we can clear up this ambiguity.<p><p><div class="wide-figure"><figure><img src="/img/blog/2025-05-02-starting-seamless-interop/cast-2.png"></figure></div><p><h2>Interlude</h2><p>Before I go into exactly how we're stitching together JIT compiled C++ code with jank's LLVM IR, please consider subscribing to jank's mailing list. This is going to be the best way to make sure you stay up to date with jank's releases, jank-related talks, workshops, and so on.<p><div style="margin:auto;text-align:center"><form action="https://listmonk.jank-lang.org/subscription/form"class="listmonk-form"method="post"target="blank_"><div><input name="nonce"type="hidden"><p><input name="email"placeholder="E-mail"required=""type="email"><p><input name="name"placeholder="Name (optional)"type="hidden"><p><input id="a132c"name="l"type="hidden"value="a132cb7d-6dc0-450c-8789-41d4fd880548"><p><button class="subscribe-button"type="submit">Subscribe</button></div></form></div><p><h2>LLVM IR</h2><p>Let's go back to our simple example of just evaluating <code>cpp/std.string.npos</code> from the terminal REPL client. The REPL client will automatically wrap many expressions we give it in a function, which is then JIT compiled, and immediately invoked. <a href="https://en.wikipedia.org/wiki/Immediately_invoked_function_expression">IIFE</a> is the term for this. Since our C++ value is wrapped in a function, we end up with the implicit conversion being required, since the function is going to return our value. The function needs to:<ol><li>Look up the value from C++ land<li>Convert the value into a jank object<li>Return the value</ol><p>Let's take these one at a time.<h3>Looking up the value</h3><p>Reaching into C++ requires an understanding of C++ structs, classes, templates, padding, alignment, and so much more. There's no way we can reasonably do all of that ourselves, so we rely on Clang to do it for us. To do this, we generate some C++ code at run-time and give it to Clang to JIT compile. To get our value, the C++ code will look <i>something</i> like this:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">extern</span><span style="color:#e6db74"> &quot;C&quot;</span></span>
<span class="line"><span style="color:#f8f8f2">inline </span><span style="color:#66d9ef;font-style:italic">void</span><span style="color:#a6e22e"> jank_generated_helper_0</span><span style="color:#fd971f">(</span><span style="color:#66d9ef;font-style:italic">void</span><span style="color:#f8f8f2"> *, </span><span style="color:#66d9ef;font-style:italic">int</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">void</span><span style="color:#f8f8f2"> **, </span><span style="color:#66d9ef;font-style:italic">void</span><span style="color:#f8f8f2"> *</span><span style="color:#fd971f;font-style:italic">ret</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">{</span><span style="color:#fb4934;font-weight:700"> new</span><span style="color:#fd971f"> (</span><span style="color:#f8f8f2">ret</span><span style="color:#fd971f">)</span><span style="color:#66d9ef;font-style:italic"> size_t</span><span style="color:#fd971f">{</span><span style="color:#a6e22e"> std</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">string</span><span style="color:#f8f8f2">::npos </span><span style="color:#fd971f">}</span><span style="color:#f8f8f2">; </span><span style="color:#fd971f">}</span></span></code></pre><p>Ignore all of the parameters except for the last, for right now. When we call this function, we pass in a pointer to a buffer which is large enough to hold a <code>size_t</code>. The function then initializes that memory with the value held in <code>std::string::npos</code>. We can generate this knowing the type of <code>std::string::npos</code> ahead of time. Clang will compile this to a C function, which we can then call from our IR. We pass a pointer to a buffer rather than dealing with return values, since that's an <a href="https://yorickpeterse.com/articles/the-mess-that-is-handling-structure-arguments-and-returns-in-llvm/">ABI nightmare</a>.<p>Given the C++ code above, Clang gives an IR function like this:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">define linkonce_odr dso_local </span><span style="color:#66d9ef;font-style:italic">void</span><span style="color:#fd971f"> @jank_generated_helper_0</span><span style="color:#f8f8f2">(</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">          ptr</span><span style="color:#f8f8f2"> noundef </span><span style="color:#fd971f">%0</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">          i32</span><span style="color:#f8f8f2"> noundef </span><span style="color:#fd971f">%1</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">          ptr</span><span style="color:#f8f8f2"> noundef </span><span style="color:#fd971f">%2</span><span style="color:#f8f8f2">,</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">          ptr</span><span style="color:#f8f8f2"> noundef nonnull </span><span style="color:#fd971f">%3</span><span style="color:#f8f8f2">) #</span><span style="color:#ae81ff">0</span><span style="color:#f8f8f2"> comdat {</span></span>
<span class="line"><span style="color:#fd971f">  %5</span><span style="color:#f8f8f2"> = </span><span style="color:#fb4934;font-weight:700">alloca</span><span style="color:#66d9ef;font-style:italic"> ptr</span><span style="color:#f8f8f2">, align </span><span style="color:#ae81ff">8</span></span>
<span class="line"><span style="color:#fd971f">  %6</span><span style="color:#f8f8f2"> = </span><span style="color:#fb4934;font-weight:700">alloca</span><span style="color:#66d9ef;font-style:italic"> i32</span><span style="color:#f8f8f2">, align </span><span style="color:#ae81ff">4</span></span>
<span class="line"><span style="color:#fd971f">  %7</span><span style="color:#f8f8f2"> = </span><span style="color:#fb4934;font-weight:700">alloca</span><span style="color:#66d9ef;font-style:italic"> ptr</span><span style="color:#f8f8f2">, align </span><span style="color:#ae81ff">8</span></span>
<span class="line"><span style="color:#fd971f">  %8</span><span style="color:#f8f8f2"> = </span><span style="color:#fb4934;font-weight:700">alloca</span><span style="color:#66d9ef;font-style:italic"> ptr</span><span style="color:#f8f8f2">, align </span><span style="color:#ae81ff">8</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  store</span><span style="color:#66d9ef;font-style:italic"> ptr</span><span style="color:#fd971f"> %0</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> %5</span><span style="color:#f8f8f2">, align </span><span style="color:#ae81ff">8</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  store</span><span style="color:#66d9ef;font-style:italic"> i32</span><span style="color:#fd971f"> %1</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> %6</span><span style="color:#f8f8f2">, align </span><span style="color:#ae81ff">4</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  store</span><span style="color:#66d9ef;font-style:italic"> ptr</span><span style="color:#fd971f"> %2</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> %7</span><span style="color:#f8f8f2">, align </span><span style="color:#ae81ff">8</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  store</span><span style="color:#66d9ef;font-style:italic"> ptr</span><span style="color:#fd971f"> %3</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> %8</span><span style="color:#f8f8f2">, align </span><span style="color:#ae81ff">8</span></span>
<span class="line"><span style="color:#fd971f">  %9</span><span style="color:#f8f8f2"> = </span><span style="color:#fb4934;font-weight:700">load</span><span style="color:#66d9ef;font-style:italic"> ptr</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> %8</span><span style="color:#f8f8f2">, align </span><span style="color:#ae81ff">8</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  store</span><span style="color:#66d9ef;font-style:italic"> i64</span><span style="color:#f8f8f2"> -</span><span style="color:#ae81ff">1</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> %9</span><span style="color:#f8f8f2">, align </span><span style="color:#ae81ff">8</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  ret</span><span style="color:#66d9ef;font-style:italic"> void</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>There's a whole lot of hoopla and then ultimately a <code>store i64 -1, ptr %9</code>, which is really all we care about.<p>Given this helper, we can start building our own function to wrap our C++ value. We need to (stack) allocate space which is large enough to hold a <code>size_t</code> and then we can call our C++ helper in order to initialize the memory.<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">define </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> @clojure_core_cpp_value_7603_0</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">entry:</span></span>
<span class="line"><span style="color:#fd971f">  %0</span><span style="color:#f8f8f2"> = </span><span style="color:#fb4934;font-weight:700">alloca</span><span style="color:#66d9ef;font-style:italic"> i8</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">i32</span><span style="color:#ae81ff"> 8</span><span style="color:#f8f8f2">, align </span><span style="color:#ae81ff">8</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  call</span><span style="color:#66d9ef;font-style:italic"> void</span><span style="color:#fd971f"> @jank_generated_helper_0</span><span style="color:#f8f8f2">(</span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#f8f8f2"> null, </span><span style="color:#66d9ef;font-style:italic">i32</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#f8f8f2"> null, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> %0</span><span style="color:#f8f8f2">)</span></span></code></pre><h3>Converting our value</h3><p>This is a good start. After this, we'll have <code>-1</code> in the allocated memory. Now, however, we need to convert this into a jank object. In order to do that, we'll generate another C++ helper. This one will do the necessary conversion using jank's trait. It'll look something like this:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#66d9ef;font-style:italic">extern</span><span style="color:#e6db74"> &quot;C&quot;</span></span>
<span class="line"><span style="color:#f8f8f2">inline </span><span style="color:#66d9ef;font-style:italic">void</span><span style="color:#a6e22e"> jank_generated_helper_1</span><span style="color:#fd971f">(</span><span style="color:#66d9ef;font-style:italic">void</span><span style="color:#f8f8f2"> *, </span><span style="color:#66d9ef;font-style:italic">int</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">void</span><span style="color:#f8f8f2"> **</span><span style="color:#fd971f;font-style:italic">args</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">void</span><span style="color:#f8f8f2"> *</span><span style="color:#fd971f;font-style:italic">ret</span><span style="color:#fd971f">)</span></span>
<span class="line"><span style="color:#fd971f">{</span></span>
<span class="line"><span style="color:#66d9ef;font-style:italic">  auto</span><span style="color:#f8f8f2"> const arg0</span><span style="color:#fd971f">{</span><span style="color:#fb4934;font-weight:700"> *</span><span style="color:#fd971f">(</span><span style="color:#66d9ef;font-style:italic">size_t</span><span style="color:#fb4934;font-weight:700">*</span><span style="color:#fd971f">)</span><span style="color:#f8f8f2">args[</span><span style="color:#ae81ff">0</span><span style="color:#f8f8f2">] </span><span style="color:#fd971f">}</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  new</span><span style="color:#fd971f"> (</span><span style="color:#f8f8f2">ret</span><span style="color:#fd971f">)</span><span style="color:#a6e22e"> obj</span><span style="color:#f8f8f2">::integer_ref</span><span style="color:#fd971f">{</span><span style="color:#a6e22e"> convert</span><span style="color:#fd971f">&lt;</span><span style="color:#66d9ef;font-style:italic">size_t</span><span style="color:#fd971f">&gt;</span><span style="color:#f8f8f2">::</span><span style="color:#a6e22e">into_object</span><span style="color:#fd971f">(</span><span style="color:#f8f8f2">arg0</span><span style="color:#fd971f">)</span><span style="color:#fd971f"> }</span><span style="color:#f8f8f2">;</span></span>
<span class="line"><span style="color:#fd971f">}</span></span></code></pre><p>That'll generate into a rather large IR function which I'm not going to paste here. You'll see we end up using another of the parameters, though, which is our <code>args</code>. The <code>args</code> parameter is a pointer to an array of pointers to arguments. Again, when generating this C++ helper, we know the type that everything will be, so we can do some dirty casting from <code>void*</code> to get it there.<p>Now we can extend our IR function to call into this second helper.<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">define </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> @clojure_core_cpp_value_7603_0</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">entry:</span></span>
<span class="line"><span style="color:#88846f">  ; Store our -1 in %0.</span></span>
<span class="line"><span style="color:#fd971f">  %0</span><span style="color:#f8f8f2"> = </span><span style="color:#fb4934;font-weight:700">alloca</span><span style="color:#66d9ef;font-style:italic"> i8</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">i32</span><span style="color:#ae81ff"> 8</span><span style="color:#f8f8f2">, align </span><span style="color:#ae81ff">8</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  call</span><span style="color:#66d9ef;font-style:italic"> void</span><span style="color:#fd971f"> @jank_generated_helper_0</span><span style="color:#f8f8f2">(</span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#f8f8f2"> null, </span><span style="color:#66d9ef;font-style:italic">i32</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#f8f8f2"> null, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> %0</span><span style="color:#f8f8f2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">  ; Now convert our -1 into a jank object.</span></span>
<span class="line"><span style="color:#fd971f">  %into_object.args</span><span style="color:#f8f8f2"> = </span><span style="color:#fb4934;font-weight:700">alloca</span><span style="color:#f8f8f2"> [</span><span style="color:#ae81ff">1</span><span style="color:#f8f8f2"> x </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#f8f8f2">], align </span><span style="color:#ae81ff">8</span></span>
<span class="line"><span style="color:#f8f8f2">  %</span><span style="color:#e6db74">&quot;into_object.args[0]&quot;</span><span style="color:#f8f8f2"> = </span><span style="color:#fb4934;font-weight:700">getelementptr</span><span style="color:#fb4934;font-weight:700"> inbounds</span><span style="color:#f8f8f2"> [</span><span style="color:#ae81ff">1</span><span style="color:#f8f8f2"> x </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#f8f8f2">], </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> %into_object.args</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">i32</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">i32</span><span style="color:#ae81ff"> 0</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  store</span><span style="color:#66d9ef;font-style:italic"> ptr</span><span style="color:#fd971f"> %0</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#f8f8f2"> %</span><span style="color:#e6db74">&quot;into_object.args[0]&quot;</span><span style="color:#f8f8f2">, align </span><span style="color:#ae81ff">8</span></span>
<span class="line"><span style="color:#fd971f">  %into_object.ret_alloc</span><span style="color:#f8f8f2"> = </span><span style="color:#fb4934;font-weight:700">alloca</span><span style="color:#66d9ef;font-style:italic"> i8</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">i32</span><span style="color:#ae81ff"> 8</span><span style="color:#f8f8f2">, align </span><span style="color:#ae81ff">8</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  call</span><span style="color:#66d9ef;font-style:italic"> void</span><span style="color:#fd971f"> @jank_generated_helper_1</span><span style="color:#f8f8f2">(</span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#f8f8f2"> null, </span><span style="color:#66d9ef;font-style:italic">i32</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> %into_object.args</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> %into_object.ret_alloc</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#fd971f">  %ret</span><span style="color:#f8f8f2"> = </span><span style="color:#fb4934;font-weight:700">load</span><span style="color:#66d9ef;font-style:italic"> ptr</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> %into_object.ret_alloc</span><span style="color:#f8f8f2">, align </span><span style="color:#ae81ff">8</span></span></code></pre><p>I've tried to put some helpful names into the generated IR, to aid in reading. We can see here that we generate the args array for our call, we store <code>%0</code> (our <code>size_t</code> which we read earlier) into the zeroth spot of the array, we allocate enough space for the return value, and then we call our second helper.<h3>Returning our value</h3><p>There's one last catch, though. The <code>convert&lt;size_t&gt;::into_object</code> function returns a typed jank object, which is <code>obj::integer_ref</code>. This is great for taking advantage of type information, but we're crossing jank function boundaries here, so everything needs to be a type-erased <code>object_ref</code>. We can do this by just shifting the pointer, if we know the offset to the base from <code>obj::integer</code>. Fortunately, jank will do this for us automatically when it detects that we need a type-erased object and we have a typed object. Our final IR function looks like this:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">define </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> @clojure_core_cpp_value_7603_0</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">entry:</span></span>
<span class="line"><span style="color:#88846f">  ; Store our -1 in %0.</span></span>
<span class="line"><span style="color:#fd971f">  %0</span><span style="color:#f8f8f2"> = </span><span style="color:#fb4934;font-weight:700">alloca</span><span style="color:#66d9ef;font-style:italic"> i8</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">i32</span><span style="color:#ae81ff"> 8</span><span style="color:#f8f8f2">, align </span><span style="color:#ae81ff">8</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  call</span><span style="color:#66d9ef;font-style:italic"> void</span><span style="color:#fd971f"> @jank_generated_helper_0</span><span style="color:#f8f8f2">(</span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#f8f8f2"> null, </span><span style="color:#66d9ef;font-style:italic">i32</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#f8f8f2"> null, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> %0</span><span style="color:#f8f8f2">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">  ; Now convert our -1 into a jank object.</span></span>
<span class="line"><span style="color:#fd971f">  %into_object.args</span><span style="color:#f8f8f2"> = </span><span style="color:#fb4934;font-weight:700">alloca</span><span style="color:#f8f8f2"> [</span><span style="color:#ae81ff">1</span><span style="color:#f8f8f2"> x </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#f8f8f2">], align </span><span style="color:#ae81ff">8</span></span>
<span class="line"><span style="color:#f8f8f2">  %</span><span style="color:#e6db74">&quot;into_object.args[0]&quot;</span><span style="color:#f8f8f2"> = </span><span style="color:#fb4934;font-weight:700">getelementptr</span><span style="color:#fb4934;font-weight:700"> inbounds</span><span style="color:#f8f8f2"> [</span><span style="color:#ae81ff">1</span><span style="color:#f8f8f2"> x </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#f8f8f2">], </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> %into_object.args</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">i32</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">i32</span><span style="color:#ae81ff"> 0</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  store</span><span style="color:#66d9ef;font-style:italic"> ptr</span><span style="color:#fd971f"> %0</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#f8f8f2"> %</span><span style="color:#e6db74">&quot;into_object.args[0]&quot;</span><span style="color:#f8f8f2">, align </span><span style="color:#ae81ff">8</span></span>
<span class="line"><span style="color:#fd971f">  %into_object.ret_alloc</span><span style="color:#f8f8f2"> = </span><span style="color:#fb4934;font-weight:700">alloca</span><span style="color:#66d9ef;font-style:italic"> i8</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">i32</span><span style="color:#ae81ff"> 8</span><span style="color:#f8f8f2">, align </span><span style="color:#ae81ff">8</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  call</span><span style="color:#66d9ef;font-style:italic"> void</span><span style="color:#fd971f"> @jank_generated_helper_0</span><span style="color:#f8f8f2">(</span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#f8f8f2"> null, </span><span style="color:#66d9ef;font-style:italic">i32</span><span style="color:#ae81ff"> 0</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> %into_object.args</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> %into_object.ret_alloc</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#fd971f">  %ret</span><span style="color:#f8f8f2"> = </span><span style="color:#fb4934;font-weight:700">load</span><span style="color:#66d9ef;font-style:italic"> ptr</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> %into_object.ret_alloc</span><span style="color:#f8f8f2">, align </span><span style="color:#ae81ff">8</span></span>
<span class="line"></span>
<span class="line"><span style="color:#88846f">  ; Adjust the pointer to the base.</span></span>
<span class="line"><span style="color:#fd971f">  %ret_base</span><span style="color:#f8f8f2"> = </span><span style="color:#fb4934;font-weight:700">getelementptr</span><span style="color:#fb4934;font-weight:700"> inbounds</span><span style="color:#66d9ef;font-style:italic"> i8</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> %ret</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">i32</span><span style="color:#ae81ff"> 8</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  ret</span><span style="color:#66d9ef;font-style:italic"> ptr</span><span style="color:#fd971f"> %ret_base</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>This ends up being a lot of work for seemingly one line of jank code, but there's a great deal of magic going on behind the scenes. What's amazing, though, is that all of this gets completely optimized away. With <code>-O2</code> settings on our IR optimizations, LLVM will turn our function into this:<pre class="shiki monokai"style="background-color:#272822;color:#f8f8f2"tabindex="0"><code><span class="line"><span style="color:#f8f8f2">define nonnull </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> @clojure_core_cpp_value_7603_0</span><span style="color:#f8f8f2">() {</span></span>
<span class="line"><span style="color:#f8f8f2">entry:</span></span>
<span class="line"><span style="color:#fd971f">  %0</span><span style="color:#f8f8f2"> = tail </span><span style="color:#fb4934;font-weight:700">call</span><span style="color:#66d9ef;font-style:italic"> ptr</span><span style="color:#fd971f"> @_ZN4jank7runtime7convertImE11into_objectEm</span><span style="color:#f8f8f2">(</span><span style="color:#66d9ef;font-style:italic">i64</span><span style="color:#f8f8f2"> noundef -</span><span style="color:#ae81ff">1</span><span style="color:#f8f8f2">)</span></span>
<span class="line"><span style="color:#fd971f">  %ret_base</span><span style="color:#f8f8f2"> = </span><span style="color:#fb4934;font-weight:700">getelementptr</span><span style="color:#fb4934;font-weight:700"> inbounds</span><span style="color:#66d9ef;font-style:italic"> i8</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">ptr</span><span style="color:#fd971f"> %0</span><span style="color:#f8f8f2">, </span><span style="color:#66d9ef;font-style:italic">i64</span><span style="color:#ae81ff"> 8</span></span>
<span class="line"><span style="color:#fb4934;font-weight:700">  ret</span><span style="color:#66d9ef;font-style:italic"> ptr</span><span style="color:#fd971f"> %ret_base</span></span>
<span class="line"><span style="color:#f8f8f2">}</span></span></code></pre><p>The <code>-1</code>, which came from <code>std::string::npos</code>, was completely inlined. Then we just call our conversion function and shift our pointer to cast from <code>obj::integer_ref</code> to <code>object_ref</code>. Phew, that's it!<h3>What's next?</h3><p>We're one month into the quarter and I'm pleased with the progress so far. However, there's a lot remaining work to do. I still need to tackle free/static function calls, member access, member function calls, operators, dynamic allocations, complex type support, and automatic destructors for locals with the same guarantees C++ provides. On top of that, I need to make sure we can process C++ headers in a portable way. This will definitely keep me busy for the quarter! Stay tuned for my next update in a month.<p>Lastly, shout out to <a href="https://github.com/compiler-research/CppInterOp">CppInterOp</a> for shining light on how this sort of thing can be done and making it easier for me to do so.<h2>Would you like to help out?</h2><ol><li>Join the community on <a href="https://clojurians.slack.com/archives/C03SRH97FDK">Slack</a><li>Join the design discussions or pick up a ticket on <a href="https://github.com/jank-lang/jank">GitHub</a><li>Considering becoming a <a href="https://github.com/sponsors/jeaye">Sponsor</a> <span class="icon mr-1"style="color:#c96198"><i class="gg-heart"></i></span><li><strong>Better yet, reach out to discuss corporate sponsorship!</strong></ol></div></div></section></div><footer class="footer"><div class="container"><div class="columns has-text-centered"></div><div class="container has-text-centered"><div class="content is-small"><p>© 2025 Jeaye Wilkerson | All rights reserved.</div></div></div></footer><noscript><p><img src="//matomo.jeaye.com/matomo.php?idsite=1&amp;rec=1"style="border:0"alt=""></p></noscript><script>for(var coll=document.getElementsByClassName("collapsible"),i=0;i<coll.length;i++)coll[i].addEventListener("click",function(){this.classList.toggle("active");var l=this.nextElementSibling;"block"===l.style.display?l.style.display="none":l.style.display="block"})</script>